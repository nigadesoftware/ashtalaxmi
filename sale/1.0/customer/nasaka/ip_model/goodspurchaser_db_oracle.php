<?php
//This is generated by Swapp Software Application on 07/03/2019 04:32:07 PM for PHP
include_once("../swappbase/formbase.php");
require_once("../../../../../finance/2.0/customer/nasaka/ip_model/accountsubledger_db_oracle.php");
class goodspurchaser extends swappform
{
    Public $purchasercode;
    Public $purchasernameuni;
    Public $purchasernameeng;
    Public $goodscategorycode;
    Public $pannumber;
    Public $gstinnumber;
    Public $contactnumber;
    Public $contactperson;
    Public $address;
    Public $emailid;
    Public $statecode;
    Public $purchasercategorycode;
    Public $pincode;
    Public $distance;
    Public $location;
    Public $tdsapplicable;
    public function __construct(&$connection)
    {
     		 parent::__construct($connection);
         $this->purchasercode='';
         $this->purchasernameuni='';
         $this->purchasernameeng='';
         $this->goodscategorycode='';
         $this->pannumber='';
         $this->gstinnumber='';
         $this->contactnumber='';
         $this->contactperson='';
         $this->address='';
         $this->emailid='';
         $this->statecode='';
         $this->purchasercategorycode='';
	   }
    private function entryvalidation()
    {
    		$this->start_validation();
        $this->checkrequired($this->purchasernameuni,'Purchaser Name (Unicode)');
        $this->checkrequired($this->purchasernameeng,'Purchaser Name (English)');
        $this->checkrequired($this->goodscategorycode,'Goods Category');
        $this->checkrequired($this->address,'Address');
        $this->checkrequired($this->statecode,'State');
        $this->checkrequired($this->purchasercategorycode,'Purchaser Category');
        $this->checkrequired($this->pincode,'Pincode');
        $this->checkrequired($this->distance,'Distance');
        $this->checkrequired($this->location,'Location');
        $this->end_validation();
        return $this->invalidid;
	  }
    private function datavalidation()
    {
        $this->start_validation();
    		$this->invalidid=0;
    		$this->invalidmessagetext='Validated';
    		$this->end_validation();
    		return $this->invalidid;
    }
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
	    if ($this->purchasercode == '')
        {
            $query = "select nvl(max(purchasercode),0)+1 as purchasercode from goodspurchaser";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->purchasercode = $row["PURCHASERCODE"];
        }
        $query = "
            insert into goodspurchaser(
            purchasercode
            ,purchasernameuni
            ,purchasernameeng
            ,goodscategorycode
            ,pannumber
            ,gstinnumber
            ,contactnumber
            ,contactperson
            ,address
            ,emailid
            ,statecode
            ,purchasercategorycode
            ,pincode
            ,distance
            ,location
            ,tdsapplicable
	        )
	        values (
            ".$this->invl($this->purchasercode,true)."
            ,".$this->invl($this->purchasernameuni,false)."
            ,".$this->invl($this->purchasernameeng,false)."
            ,".$this->invl($this->goodscategorycode,true)."
            ,".$this->invl($this->pannumber,false)."
            ,".$this->invl($this->gstinnumber,false)."
            ,".$this->invl($this->contactnumber,false)."
            ,".$this->invl($this->contactperson,false)."
            ,".$this->invl($this->address,false)."
            ,".$this->invl($this->emailid,false)."
            ,".$this->invl($this->statecode,true,true)."
            ,".$this->invl($this->purchasercategorycode,true,true)."
            ,".$this->invl($this->pincode,true,true)."
            ,".$this->invl($this->distance,true,true)."
            ,".$this->invl($this->location,false)."
            ,".$this->invl($this->tdsapplicable,true)."
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='';
		    if ($this->purchasercode!='' and $this->purchasercode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.purchasercode = ".$this->purchasercode;
			       }
			       else
			       {
				         $cond=$cond." and t.purchasercode = ".$this->purchasercode;
			       }
		    }
		    if ($this->purchasernameuni!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.purchasernameuni like '%".$this->purchasernameuni."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.purchasernameuni like '%".$this->purchasernameuni."%'";
			       }
		    }
		    if ($this->purchasernameeng!='')
		    {
			      if ($cond=='')
			      {
				        $cond="upper(t.purchasernameeng) like '%".strtoupper($this->purchasernameeng)."%'";
			       }
			       else
			       {
				         $cond=$cond." and upper(t.purchasernameeng) like '%".strtoupper($this->purchasernameeng)."%'";
			       }
		    }
		    if ($this->pannumber!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.pannumber like '%".$this->pannumber."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.pannumber like '%".$this->pannumber."%'";
			       }
		    }
		    if ($this->gstinnumber!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.gstinnumber like '%".$this->gstinnumber."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.gstinnumber like '%".$this->gstinnumber."%'";
			       }
		    }
		    if ($this->statecode!='' and $this->statecode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.statecode = ".$this->statecode;
			       }
			       else
			       {
				         $cond=$cond." and t.statecode = ".$this->statecode;
			       }
		    }
		    if ($this->purchasercategorycode!='' and $this->purchasercategorycode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.purchasercategorycode = ".$this->purchasercategorycode;
			       }
			       else
			       {
				         $cond=$cond." and t.purchasercategorycode = ".$this->purchasercategorycode;
			       }
            }
            if ($this->pincode!='' and $this->pincode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.pincode = ".$this->pincode;
			       }
			       else
			       {
				         $cond=$cond." and t.pincode = ".$this->pincode;
			       }
            }
            if ($this->distance!='' and $this->distance!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.distance = ".$this->distance;
			       }
			       else
			       {
				         $cond=$cond." and t.distance = ".$this->distance;
			       }
            }
        if ($cond!='')
		    {
		        $query = "select t.* from goodspurchaser t where ".$cond." order by purchasercode";
			      $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
			      return $result;
		     }
		     else
		     {
		         $query = "select t.* from goodspurchaser t order by purchasercode";
			       $result = oci_parse($this->connection, $query);
             $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
			       return $result;
		     }
	  }
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $query = "
        update goodspurchaser set 
        purchasernameuni =".$this->invl($this->purchasernameuni,false)."
        ,purchasernameeng =".$this->invl($this->purchasernameeng,false)."
        ,goodscategorycode = ".$this->invl($this->goodscategorycode,true)."
        ,pannumber =".$this->invl($this->pannumber,false)."
        ,gstinnumber =".$this->invl($this->gstinnumber,false)."
        ,contactnumber =".$this->invl($this->contactnumber,false)."
        ,contactperson =".$this->invl($this->contactperson,false)."
        ,address =".$this->invl($this->address,false)."
        ,emailid =".$this->invl($this->emailid,false)."
        ,statecode = ".$this->invl($this->statecode,true)."
        ,purchasercategorycode = ".$this->invl($this->purchasercategorycode,true)."
        ,pincode = ".$this->invl($this->pincode,true)."
        ,distance = ".$this->invl($this->distance,true)."
        ,location = ".$this->invl($this->location,false)."
        ,tdsapplicable = ".$this->invl($this->tdsapplicable,true)."
        where 
        purchasercode = ".$this->invl($this->purchasercode,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $query = "
        delete from goodspurchaser
        where 
        purchasercode = ".$this->invl($this->purchasercode,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
             return 1;
             exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        purchasercode
        ,purchasernameuni
        ,purchasernameeng
        ,goodscategorycode
        ,pannumber
        ,gstinnumber
        ,contactnumber
        ,contactperson
        ,address
        ,emailid
        ,p.statecode
        ,purchasercategorycode
        ,statenameeng
        ,statenameuni
        ,pincode
        ,distance
        ,location
        ,tdsapplicable
        from nst_nasaka_sale.goodspurchaser p,nst_nasaka_db.state s 
        where p.statecode=s.statecode
        and purchasercode = ".$this->invl($this->purchasercode,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->purchasercode = $row['PURCHASERCODE'];
                $this->purchasernameuni = $row['PURCHASERNAMEUNI'];
                $this->purchasernameeng = $row['PURCHASERNAMEENG'];
                $this->goodscategorycode = $row['GOODSCATEGORYCODE'];
                $this->pannumber = $row['PANNUMBER'];
                $this->gstinnumber = $row['GSTINNUMBER'];
                $this->contactnumber = $row['CONTACTNUMBER'];
                $this->contactperson = $row['CONTACTPERSON'];
                $this->address = $row['ADDRESS'];
                $this->emailid = $row['EMAILID'];
                $this->statecode = $row['STATECODE'];
                $this->purchasercategorycode = $row['PURCHASERCATEGORYCODE'];
                $this->statenameeng = $row['STATENAMEENG'];
                $this->statenameuni = $row['STATENAMEUNI'];
                $this->pincode = $row['PINCODE'];
                $this->distance = $row['DISTANCE'];
                $this->location = $row['LOCATION'];
                $this->tdsapplicable = $row['TDSAPPLICABLE'];
                $this->found=true;
                return true;
        }
        else
        {
        return false;
        }
    }
    function autosubledgeraccount()
    {
        $this->dataoperationmode = operationmode::Select;
        /* union all
                (select t.accountcode,s.prefix||p.purchasercode as referencecode 
                from nst_nasaka_finance.accountheaddetail t,nst_nasaka_finance.subledgertype s,goodspurchaser p,salecontroltable c
                where t.subledgertypecode=s.subledgertypecode 
                and p.goodscategorycode=".$this->goodscategorycode." 
                and c.goodscategorycode=p.goodscategorycode 
                and c.postingcategory=2
                and t.subledgertypecode=3
                and t.accountcode=1106038
                minus
                select l.accountcode,l.referencecode
                from nst_nasaka_finance.accountheaddetail t,nst_nasaka_finance.subledgertype s,nst_nasaka_finance.accountsubledger l,salecontroltable c
                where t.subledgertypecode=s.subledgertypecode 
                and t.accountcode=l.accountcode
                and l.accountcode=1106038
                and t.subledgertypecode=3
                and c.goodscategorycode=".$this->goodscategorycode."
                and c.postingcategory=2) */
        $query = "select accountcode,referencecode,g.purchasernameuni,g.purchasernameeng
        from (
        select accountcode,referencecode
        from (select t.accountcode,s.prefix||p.purchasercode as referencecode 
                from nst_nasaka_finance.accountheaddetail t,nst_nasaka_finance.subledgertype s,goodspurchaser p,salecontroltable c
                where t.subledgertypecode=s.subledgertypecode 
                and p.goodscategorycode=".$this->goodscategorycode." 
                and c.goodscategorycode=p.goodscategorycode 
                and t.subledgertypecode=3
                and c.postingcategory=2
                and t.accountcode=c.debtorsaccountcode
                minus
                select l.accountcode,l.referencecode
                from nst_nasaka_finance.accountheaddetail t,nst_nasaka_finance.subledgertype s,nst_nasaka_finance.accountsubledger l,salecontroltable c
                where t.subledgertypecode=s.subledgertypecode 
                and t.accountcode=l.accountcode
                and t.subledgertypecode=3
                and l.accountcode=c.debtorsaccountcode
                and c.goodscategorycode=".$this->goodscategorycode."
                and c.postingcategory=2)
                ) t, goodspurchaser g
                where t.referencecode='P'||g.purchasercode
                and g.purchasercode=".$this->purchasercode;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        $connection1=swapp_connection_user('nst_nasaka_finance');
        while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $accountsubledger1 = new accountsubledger($connection1);
            $accountsubledger1->subledgernameeng = $row['PURCHASERNAMEENG'];
            $accountsubledger1->subledgernameuni = $row['PURCHASERNAMEUNI'];
            $accountsubledger1->subledgertypecode = 3;
            $accountsubledger1->accountcode = $row['ACCOUNTCODE'];
            $accountsubledger1->referencecode = $row['REFERENCECODE'];
            $ret = $accountsubledger1->insert();
            if ($ret == 1)
            {
                oci_commit($connection1);
            }
            else
            {
                oci_rollback($connection1);
            }
        }
    }
}
?>

