<?php
//This is generated by Swapp Software Application on 17/03/2019 11:12:38 AM for PHP
require_once("../swappbase/formbase.php");
require_once("../ip_model/goodspurchaser_db_oracle.php");
require_once("../ip_model/salememoheader_db_oracle.php");
require_once("../../../../../finance/2.0/customer/nasaka/ip_model/voucherheader_db_oracle.php");
require_once("../../../../../finance/2.0/customer/nasaka/ip_model/voucherdetail_db_oracle.php");
require_once("../../../../../finance/2.0/customer/nasaka/ip_model/accountsubledger_db_oracle.php");
require_once("../../../../../finance/2.0/customer/nasaka/ip_model/voucheractiondetail_db_oracle.php");
require_once("../../../../../finance/2.0/customer/nasaka/ip_model/accounthead_db_oracle.php");
class saleinvoiceheader extends swappform
{
    Public $transactionnumber;
    Public $goodscategorycode;
    Public $salecategorycode;
    Public $yearperiodcode;
    Public $salememotransactionnumber;
    Public $saleinvoicenumberseriesid;
    Public $saleinvoicenumberbasevalue;
    Public $invoicenumber;
    Public $invoicenumberpresuf;
    Public $invoicedate;
    Public $brokercode;
    Public $purchasercode;
    Public $shippingpartycode;
    Public $preparationtime;
    Public $removaltime;
    Public $vehiclenumber;
    Public $drivername;
    Public $driverlicenseno;
    Public $cgstamount;
    Public $sgstamount;
    Public $igstamount;
    Public $ugstamount;
    Public $vatamount;
    Public $totaltaxamount;
    Public $grossamount;
    Public $bookingstation;
    Public $receivingstation;
    Public $taxableamount;
    Public $tcs;
    Public $memonumber;
    Public $purchaser;
    Public $shiftto;
    Public $broker;
    Public $goodscategorynameeng;
    Public $salecategorynameeng;
    Public $irnnumber;
    Public $acknumber;
    Public $ackdate;
    Public $tds;
    public function __construct(&$connection)
    {
         parent::__construct($connection);
         $this->transactionnumber='';
         $this->goodscategorycode='';
         $this->salecategorycode='';
         $this->yearperiodcode='';
         $this->invoicenumber='';
         $this->invoicenumberpresuf='';
         $this->invoicedate='';
         $this->brokercode='';
         $this->purchasercode='';
         $this->shippingpartycode='';
         $this->preparationtime='';
         $this->removaltime='';
         $this->vehiclenumber='';
         $this->drivername='';
         $this->driverlicenseno='';
	}
    private function entryvalidation()
    {
    	$this->start_validation();
        $this->checkrequired($this->invoicedate,'Invoice Date');
        $this->checkrequired($this->brokercode,'Broker Name');
        $this->checkrequired($this->purchasercode,'Purchaser Name');
        $this->checkrequired($this->preparationtime,'Preparation Time');
        $this->checkrequired($this->removaltime,'Removal Time');
        $this->checkrequired($this->vehiclenumber,'Vehicle Number');
        $this->end_validation();
        return $this->invalidid;
	  }
    private function datavalidation()
    {
        $this->start_validation();
        $this->invalidid=0;
        $this->invalidmessagetext='Validated';
        $this->end_validation();
        return $this->invalidid;
    }
    public function generatesaleinvoicenumber()
	{
        if ($this->invoicedate!='')
        {
            $this->invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
        }
        if (!isset($this->invoicenumber) or $this->invoicenumber == '' )
        {
            $query = "select nvl(d.salenumberprefix,'') as salenumberprefix,periodresetcategorycode,transactioncategorycode from nst_nasaka_sale.salenumberseries d where d.salenumberseriesid=".$this->saleinvoicenumberseriesid." and d.goodscategorycode=".$this->goodscategorycode;
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
            if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
            {
                switch ($row['PERIODRESETCATEGORYCODE'])
                {
                    case 1:
                    {
                        $prefix = $row["SALENUMBERPREFIX"];
                        //Sale invoice transactioncategorycode=2
                        if ($row['TRANSACTIONCATEGORYCODE']==4)
                        {
                            //$invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
                            $query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,nst_nasaka_sale.salenumberbasevalue('".$this->invoicedate."',1) as invoicenumberbasevalue  from nst_nasaka_sale.saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and saleinvoicenumberbasevalue=nst_nasaka_sale.salenumberbasevalue('".$this->invoicedate."',1) and saleinvoicenumberseriesid=".$this->saleinvoicenumberseriesid;
                        }
                        
                        $result_12 = oci_parse($this->connection, $query_12);
                        $r = oci_execute($result_12);
                        $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                        $this->invoicenumber = $ROW_12["INVOICENUMBER"];
                        $this->invoicenumberpresuf = $prefix.str_pad($row_12["INVOICENUMBER"],5,'0',STR_PAD_LEFT);
                        $this->invoicenumberbasevalue = $row_12["INVOICENUMBERBASEVALUE"];
                        break;
                    }
                    case 2:
                    {
                        $prefix = $row["SALENUMBERPREFIX"];
                        //Sale invoice transactioncategorycode=2
                        if ($row['TRANSACTIONCATEGORYCODE']==4)
                        {
                            //$invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
                            $query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,nst_nasaka_sale.salenumberbasevalue('".$this->invoicedate."',2) as invoicenumberbasevalue  from nst_nasaka_sale.saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and saleinvoicenumberbasevalue=nst_nasaka_sale.salenumberbasevalue('".$this->invoicedate."',2) and saleinvoicenumberseriesid=".$this->saleinvoicenumberseriesid;
                        }
                        
                        //$query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,salenumberbasevalue('".$saledate."',2) as invoicenumberbasevalue from saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and invoicenumberbasevalue=salenumberbasevalue('".$saledate."',2) and invoicenumberseriesid=".$this->invoicenumberseriesid;
                        $result_12 = oci_parse($this->connection, $query_12);
                        $r = oci_execute($result_12);
                        $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                        $this->invoicenumber = $row_12["INVOICENUMBER"];
                        $this->invoicenumberpresuf = $prefix.str_pad($row_12["INVOICENUMBER"],5,'0',STR_PAD_LEFT);
                        $this->invoicenumberbasevalue = $row_12["INVOICENUMBERBASEVALUE"];
                        break;
                    }
                    case 3:
                    {
                        $prefix = $row["SALENUMBERPREFIX"];
                        //Sale invoice transactioncategorycode=2
                        if ($row['TRANSACTIONCATEGORYCODE']==4)
                        {
                            //$invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
                            $query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,nst_nasaka_sale.salenumberbasevalue('".$this->invoicedate."',3) as invoicenumberbasevalue  from nst_nasaka_sale.saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and saleinvoicenumberbasevalue=nst_nasaka_sale.salenumberbasevalue('".$this->invoicedate."',3) and saleinvoicenumberseriesid=".$this->saleinvoicenumberseriesid;
                        }
                        //$query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,salenumberbasevalue('".$saledate."',3) as invoicenumberbasevalue from saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and invoicenumberbasevalue=salenumberbasevalue('".$saledate."',3) and invoicenumberseriesid=".$this->invoicenumberseriesid;
                        $result_12 = oci_parse($this->connection, $query_12);
                        $r = oci_execute($result_12);
                        $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                        $this->invoicenumber = $row_12["INVOICENUMBER"];
                        $this->invoicenumberpresuf = $prefix.str_pad($row_12["INVOICENUMBER"],5,'0',STR_PAD_LEFT);
                        $this->invoicenumberbasevalue = $row_12["INVOICENUMBERBASEVALUE"];
                        break;
                    }
                    case 4:
                    {
                        $prefix = $row["SALENUMBERPREFIX"];
                        if ($row['TRANSACTIONCATEGORYCODE']==4)
                        {
                            //$invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
                            $query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,nst_nasaka_sale.salenumberbasevalue('".$this->invoicedate."',4) as invoicenumberbasevalue  from nst_nasaka_sale.saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and saleinvoicenumberbasevalue=nst_nasaka_sale.salenumberbasevalue('".$this->invoicedate."',4) and saleinvoicenumberseriesid=".$this->saleinvoicenumberseriesid;
                        }
                        //$query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,salenumberbasevalue('".$saledate."',4) as invoicenumberbasevalue from saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and invoicenumberbasevalue=salenumberbasevalue('".$saledate."',4) and invoicenumberseriesid=".$this->invoicenumberseriesid;
                        $result_12 = oci_parse($this->connection, $query_12);
                        $r = oci_execute($result_12);
                        $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                        $this->invoicenumber = $row_12["INVOICENUMBER"];
                        $this->invoicenumberpresuf = $prefix.'/'.substr($this->yearperiodcode,2,2).substr($this->yearperiodcode,6,2).'/'.str_pad($row_12["INVOICENUMBER"],5,'0',STR_PAD_LEFT);
                        $this->saleinvoicenumberbasevalue = $row_12["INVOICENUMBERBASEVALUE"];
                        break;
                    }
                }
                return 1;
                exit;
            }
            else
            {
                return 0;
                exit;
            }
        }
        else
        {
            return 0;
            exit;
        }
	}
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        if ($this->saleinvoicenumberseriesid == '')
        {
            $query = "select s.saleinvoicenumberseriesid as saleinvoicenumberseriesid 
            from salecategory s
            where salecategorycode=".$this->salecategorycode;
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->saleinvoicenumberseriesid = $row["SALEINVOICENUMBERSERIESID"];
        }
	    if ($this->transactionnumber == '')
        {
            $query = "select nvl(max(transactionnumber),0)+1 as transactionnumber from saleinvoiceheader";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->transactionnumber = $row["TRANSACTIONNUMBER"];
        }
        if ($this->invoicedate!='')
        {
            $this->invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
        }
        if ($this->preparationtime!='')
        {
            $this->preparationtime = DateTime::createFromFormat('d/m/Y H:i',$this->preparationtime)->format('d-M-Y H:i');
        }
        if ($this->removaltime!='')
        {
            $this->removaltime = DateTime::createFromFormat('d/m/Y H:i',$this->removaltime)->format('d-M-Y H:i');
        }
        //$this->generatesaleinvoicenumber();    
        $query = "
            insert into saleinvoiceheader(
            transactionnumber
            ,goodscategorycode
            ,salecategorycode
            ,yearperiodcode
            ,salememotransactionnumber
            ,saleinvoicenumberseriesid
            ,saleinvoicenumberbasevalue
            ,invoicenumber
            ,invoicenumberpresuf
            ,invoicedate
            ,brokercode
            ,purchasercode
            ,shippingpartycode
            ,preparationtime
            ,removaltime
            ,vehiclenumber
            ,drivername
            ,driverlicenseno
            ,cgstamount
            ,sgstamount
            ,igstamount
            ,ugstamount
            ,vatamount
            ,totaltaxamount
            ,grossamount
            ,bookingstation
            ,receivingstation
	        )
	        values (
            ".$this->invl($this->transactionnumber,true)."
            ,".$this->invl($this->goodscategorycode,true)."
            ,".$this->invl($this->salecategorycode,true,true)."
            ,".$this->invl($this->yearperiodcode,true)."
            ,".$this->invl($this->salememotransactionnumber,true)."
            ,".$this->invl($this->saleinvoicenumberseriesid,true)."
            ,".$this->invl($this->saleinvoicenumberbasevalue,false)."
            ,".$this->invl($this->invoicenumber,true)."
            ,".$this->invl($this->invoicenumberpresuf,false)."
            ,".$this->invl($this->invoicedate,false)."
            ,".$this->invl($this->brokercode,true,true)."
            ,".$this->invl($this->purchasercode,true,true)."
            ,".$this->invl($this->shippingpartycode,true,true)."
            ,to_date(".$this->invl($this->preparationtime,false).",'dd-mon-yyyy hh24:mi')
            ,to_date(".$this->invl($this->removaltime,false).",'dd-mon-yyyy hh24:mi')
            ,".$this->invl($this->vehiclenumber,false)."
            ,".$this->invl($this->drivername,false)."
            ,".$this->invl($this->driverlicenseno,false)."
            ,".$this->invl($this->cgstamount,true)."
            ,".$this->invl($this->sgstamount,true)."
            ,".$this->invl($this->igstamount,true)."
            ,".$this->invl($this->ugstamount,true)."
            ,".$this->invl($this->vatamount,true)."
            ,".$this->invl($this->totaltaxamount,true)."
            ,".$this->invl($this->grossamount,true)."
            ,".$this->invl($this->bookingstation,false)."
            ,".$this->invl($this->receivingstation,false)."
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='';
		    if ($this->salecategorycode!='' and $this->salecategorycode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.salecategorycode = ".$this->salecategorycode;
			       }
			       else
			       {
				         $cond=$cond." and t.salecategorycode = ".$this->salecategorycode;
			       }
		    }
		    if ($this->invoicenumber!='' and $this->invoicenumber!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.invoicenumber = ".$this->invoicenumber;
			       }
			       else
			       {
				         $cond=$cond." and t.invoicenumber = ".$this->invoicenumber;
			       }
		    }
		    if ($this->invoicenumberpresuf!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.invoicenumberpresuf like '%".$this->invoicenumberpresuf."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.invoicenumberpresuf like '%".$this->invoicenumberpresuf."%'";
			       }
		    }
		    if ($this->invoicedate!='')
		    {
			      $this->invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
			      if ($cond=='')
			      {
				        $cond="t.invoicedate = '".$this->invoicedate."'";
			       }
			       else
			       {
				         $cond=$cond." and t.invoicedate = '".$this->invoicedate."'";
			       }
		    }
		    if ($this->brokercode!='' and $this->brokercode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.brokercode = ".$this->brokercode;
			       }
			       else
			       {
				         $cond=$cond." and t.brokercode = ".$this->brokercode;
			       }
		    }
		    if ($this->purchasercode!='' and $this->purchasercode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.purchasercode = ".$this->purchasercode;
			       }
			       else
			       {
				         $cond=$cond." and t.purchasercode = ".$this->purchasercode;
			       }
		    }
		    if ($this->vehiclenumber!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.vehiclenumber like '%".$this->vehiclenumber."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.vehiclenumber like '%".$this->vehiclenumber."%'";
			       }
		    }
        if ($cond!='')
		    {
		        $query = "select t.* from saleinvoiceheader t where ".$cond." order by transactionnumber";
			      $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
			      return $result;
		     }
		     else
		     {
		         $query = "select t.* from saleinvoiceheader t order by transactionnumber";
			       $result = oci_parse($this->connection, $query);
             $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
			       return $result;
		     }
	  }
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
        $this->preparationtime = DateTime::createFromFormat('d/m/Y H:i',$this->preparationtime)->format('d-M-Y H:i');
        $this->removaltime = DateTime::createFromFormat('d/m/Y H:i',$this->removaltime)->format('d-M-Y H:i');
        $query = "
        update saleinvoiceheader set 
        goodscategorycode = ".$this->invl($this->goodscategorycode,true)."
        ,salecategorycode = ".$this->invl($this->salecategorycode,true)."
        ,yearperiodcode = ".$this->invl($this->yearperiodcode,true)."
        ,salememotransactionnumber = ".$this->invl($this->salememotransactionnumber,true)."
        ,saleinvoicenumberseriesid = ".$this->invl($this->saleinvoicenumberseriesid,true)."
        ,saleinvoicenumberbasevalue = ".$this->invl($this->saleinvoicenumberbasevalue,false)."
        ,invoicenumber = ".$this->invl($this->invoicenumber,true)."
        ,invoicenumberpresuf =".$this->invl($this->invoicenumberpresuf,false)."
        ,invoicedate =".$this->invl($this->invoicedate,false)."
        ,brokercode = ".$this->invl($this->brokercode,true)."
        ,purchasercode = ".$this->invl($this->purchasercode,true)."
        ,shippingpartycode = ".$this->invl($this->shippingpartycode,true)."
        ,preparationtime = to_date(".$this->invl($this->preparationtime,false).",'dd-mon-yyyy hh24:mi')
        ,removaltime = to_date(".$this->invl($this->removaltime,false).",'dd-mon-yyyy hh24:mi')
        ,vehiclenumber =".$this->invl($this->vehiclenumber,false)."
        ,drivername =".$this->invl($this->drivername,false)."
        ,driverlicenseno =".$this->invl($this->driverlicenseno,false)."
        ,cgstamount = ".$this->invl($this->cgstamount,true)."
        ,sgstamount = ".$this->invl($this->sgstamount,true)."
        ,igstamount = ".$this->invl($this->igstamount,true)."
        ,ugstamount = ".$this->invl($this->ugstamount,true)."
        ,vatamount = ".$this->invl($this->vatamount,true)."
        ,totaltaxamount = ".$this->invl($this->totaltaxamount,true)."
        ,grossamount = ".$this->invl($this->grossamount,true)."
        ,bookingstation =".$this->invl($this->bookingstation,false)."
        ,receivingstation =".$this->invl($this->receivingstation,false)."
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            if ($this->invoicenumberpresuf != '')
            {
                if ($this->goodscategorycode == 1)
                {
                    //$this->voucherposting(2);
                    $ret = $this->vouchertofinanceposting(2);
                }
                else
                {
                    return 0;
                }
            }
            return 1;
            exit;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function updategeneratedinvoicenumber()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $query = "
        update nst_nasaka_sale.saleinvoiceheader set 
        saleinvoicenumberbasevalue = ".$this->invl($this->saleinvoicenumberbasevalue,false)."
        ,invoicenumber = ".$this->invl($this->invoicenumber,true)."
        ,invoicenumberpresuf =".$this->invl($this->invoicenumberpresuf,false)."
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
        $query1 = "select s.accounttransactionnumber from saleaccountbridge s 
        where s.saletransactionnumber=".$this->transactionnumber;
        $result1 = oci_parse($this->connection, $query1);
        $r1 = oci_execute($result1,OCI_NO_AUTO_COMMIT);
        if ($row1 = oci_fetch_array($result1,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $query = "delete from saleaccountbridge
            where saletransactionnumber = ".$this->invl($this->transactionnumber,true);
            $result = oci_parse($this->connection, $query);
            if (oci_execute($result,OCI_NO_AUTO_COMMIT))
            {
                $query = "delete from nst_nasaka_finance.voucherheader v
                where v.transactionnumber = ".$this->invl($row1['ACCOUNTTRANSACTIONNUMBER'],true);
                $result = oci_parse($this->connection, $query);
                if (oci_execute($result,OCI_NO_AUTO_COMMIT))
                {

                }
                else
                {
                    return 0;
                }
            }
            else
            {
                return 0;
            }
        }
        $query = "
        delete from saleinvoiceheader
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
             return 1;
             exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        h.transactionnumber
        ,h.goodscategorycode
        ,h.salecategorycode
        ,yearperiodcode
        ,salememotransactionnumber
        ,h.saleinvoicenumberseriesid
        ,saleinvoicenumberbasevalue
        ,invoicenumber
        ,invoicenumberpresuf
        ,invoicedate
        ,brokercode
        ,purchasercode
        ,shippingpartycode
        ,to_char(preparationtime,'DD-MON-YYYY HH24:MI') as preparationtime
        ,to_char(removaltime,'DD-MON-YYYY HH24:MI') as removaltime
        ,vehiclenumber
        ,drivername
        ,driverlicenseno
        ,cgstamount
        ,sgstamount
        ,igstamount
        ,ugstamount
        ,totaltaxamount
        ,grossamount
        ,bookingstation
        ,receivingstation
        ,taxableamount
        ,goodscategorynameeng
        ,salecategorynameeng
        ,tcs
        ,virn_number as irnnumber
        ,vack_no as acknumber
        ,vack_date as ackdate
        ,transportationamount
        ,tds
        from nst_nasaka_sale.saleinvoiceheader h,nst_nasaka_sale.salecategory s,nst_nasaka_sale.goodscategory g where 
        h.salecategorycode=s.salecategorycode 
        and h.goodscategorycode=g.goodscategorycode
        and h.transactionnumber = ".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->transactionnumber = $row['TRANSACTIONNUMBER'];
                $this->goodscategorycode = $row['GOODSCATEGORYCODE'];
                $this->salecategorycode = $row['SALECATEGORYCODE'];
                $this->yearperiodcode = $row['YEARPERIODCODE'];
                $this->salememotransactionnumber = $row['SALEMEMOTRANSACTIONNUMBER'];
                $this->saleinvoicenumberseriesid = $row['SALEINVOICENUMBERSERIESID'];
                $this->saleinvoicenumberbasevalue = $row['SALEINVOICENUMBERBASEVALUE'];
                $this->invoicenumber = $row['INVOICENUMBER'];
                $this->invoicenumber = $row['INVOICENUMBER'];
                $this->invoicenumberpresuf = $row['INVOICENUMBERPRESUF'];
                $this->invoicedate = DateTime::createFromFormat('d-M-y',$row['INVOICEDATE'])->format('d/m/Y');
                $this->brokercode = $row['BROKERCODE'];
                $this->purchasercode = $row['PURCHASERCODE'];
                $this->shippingpartycode = $row['SHIPPINGPARTYCODE'];
                $this->preparationtime = DateTime::createFromFormat('d-M-Y H:i',$row['PREPARATIONTIME'])->format('d/m/Y H:i');
                $this->removaltime = DateTime::createFromFormat('d-M-Y H:i',$row['REMOVALTIME'])->format('d/m/Y H:i');
                $this->vehiclenumber = $row['VEHICLENUMBER'];
                $this->drivername = $row['DRIVERNAME'];
                $this->driverlicenseno = $row['DRIVERLICENSENO'];
                $this->cgstamount = $row['CGSTAMOUNT'];
                $this->sgstamount = $row['SGSTAMOUNT'];
                $this->igstamount = $row['IGSTAMOUNT'];
                $this->ugstamount = $row['UGSTAMOUNT'];
                $this->vatamount = $row['VATAMOUNT'];
                $this->totaltaxamount = $row['TOTALTAXAMOUNT'];
                $this->grossamount = $row['GROSSAMOUNT'];
                $this->bookingstation = $row['BOOKINGSTATION'];
                $this->receivingstation = $row['RECEIVINGSTATION'];
                $this->taxableamount = $row['TAXABLEAMOUNT'];
                $this->goodscategorynameeng = $row['GOODSCATEGORYNAMEENG'];
                $this->salecategorynameeng = $row['SALECATEGORYNAMEENG'];
                $this->tcs = $row['TCS'];
                $this->transportationamount = $row['TRANSPORTATIONAMOUNT'];
                $salememoheader1 = new salememoheader($this->connection);
                $salememoheader1->transactionnumber = $this->salememotransactionnumber;
                $salememoheader1->fetch();
                $this->memonumber = $salememoheader1->memonumberpresuf;

                $broker1 = new goodspurchaser($this->connection);
                $broker1->purchasercode = $this->brokercode;
                $broker1->goodscategorycode = $this->goodscategorycode;
                $broker1->fetch();
                if ($_SESSION['lng']=="English")
                {
                    $this->broker = $broker1->purchasernameeng;
                }
                else
                {
                    $this->broker = $broker1->purchasernameuni; 
                }



                $goodspurchaser1 = new goodspurchaser($this->connection);
                $goodspurchaser1->purchasercode = $this->purchasercode;
                $goodspurchaser1->goodscategorycode = $this->goodscategorycode;
                $goodspurchaser1->fetch();
                if ($_SESSION['lng']=="English")
                {
                    $this->purchaser = $goodspurchaser1->purchasernameeng;
                }
                else
                {
                    if ($goodspurchaser1->purchasernameuni!='')
                        $this->purchaser = $goodspurchaser1->purchasernameuni; 
                    else
                        $this->purchaser = $goodspurchaser1->purchasernameeng; 
                }
                $shiftto1 = new goodspurchaser($this->connection);
                $shiftto1->purchasercode = $this->shippingpartycode;
                $shiftto1->goodscategorycode = $this->goodscategorycode;
                $shiftto1->fetch();
                if ($_SESSION['lng']=="English")
                {
                    $this->shiftto = $shiftto1->purchasernameeng;
                }
                else
                {
                    $this->shiftto = $shiftto1->purchasernameuni; 
                }
                $this->irnnumber = $row['IRNNUMBER'];
                $this->acknumber = $row['ACKNUMBER'];
                $this->ackdate = $row['ACKDATE'];
                $this->tds = $row['TDS'];
                $this->found=true;
                return true;
        }
        else
        {
        return false;
        }
    }
    Public function voucherposting($postingcategory)
    {
        $query = "select s.debtorsaccountcode
        ,s.saleaccountcode
        ,s.cgstaccountcode
        ,s.sgstaccountcode
        ,s.igstaccountcode
        ,s.ugstaccountcode
        ,s.vataccountcode
        ,s.gstexpenses
        from nst_nasaka_sale.salecontroltable s
        where s.goodscategorycode=".$this->goodscategorycode."
        and s.postingcategory=".$postingcategory;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $query1 = "select b.accounttransactionnumber 
                from nst_nasaka_sale.saleaccountbridge b
                where b.saletransactionnumber=".$this->transactionnumber;            
            $result1 = oci_parse($this->connection, $query1);
            $r1 = oci_execute($result1,OCI_NO_AUTO_COMMIT);
            //existing invoice-voucher
            if ($row1 = oci_fetch_array($result1,OCI_ASSOC+OCI_RETURN_NULLS))
            {
                $goodspurchaser1 = new goodspurchaser($this->connection);
                $goodspurchaser1->purchasercode = $this->purchasercode;
                $goodspurchaser1->goodscategorycode = $this->goodscategorycode;
                $goodspurchaser1->fetch();
                $purchaser = $goodspurchaser1->purchasernameuni; 

                $voucherheader1 = new voucherheader($this->connection);
                $voucherheader1->transactionnumber = $row1['ACCOUNTTRANSACTIONNUMBER'];
                if ($voucherheader1->fetch()==true)
                {
                    $voucherheader1->legalentitycode = 1;
                    $voucherheader1->yearperiodcode = $_SESSION['yearperiodcode'];
                    if ($goodspurchaser1->goodscategorycode == 1)
                    {
                        $voucherheader1->vouchersubtypecode = 14;
                        $voucherheader1->narration = 'साखर विक्री बिल नंबर - '
                        .$this->invoicenumberpresuf.' बिल दिनांक - '.$this->invoicedate
                        .' बिल रक्कम - '.$this->grossamount.' खरेदीदार '.$purchaser
                        .' यांना साखर विकली';
                    }
                    $this->invoicedate = DateTime::createFromFormat('d-M-Y',$this->invoicedate)->format('d/m/Y');
                    $voucherheader1->voucherdate = $this->invoicedate;
                    $voucherheader1->description = $purchaser;
                    $ret = $voucherheader1->update();
                    if ($ret == 1)
                    {
                        $voucherdetail1 = new voucherdetail($this->connection);
                        $voucherdetail1->transactionnumber = $voucherheader1->transactionnumber;
                        if ($voucherdetail1->deletevoucherdetails()==true)
                        {
                            $ret = 1;
                        }
                        else
                        {
                            return false;
                        }
                    }
                    else
                    {
                        return false;
                    }
                }
                else
                {
                    return false;
                }
            }
            //new invoice-voucher
            else
            {
                if ($this->generatesaleinvoicenumber()==true)
                {
                    if ($this->updategeneratedinvoicenumber()==1)
                    {
                        
                    }
                    else
                    {
                        return 0;
                    }
                }
                else
                {
                    return 0;
                }
                $goodspurchaser1 = new goodspurchaser($this->connection);
                $goodspurchaser1->purchasercode = $this->purchasercode;
                $goodspurchaser1->goodscategorycode = $this->goodscategorycode;
                $goodspurchaser1->fetch();
                $purchaser = $goodspurchaser1->purchasernameuni; 

                $voucherheader1 = new voucherheader($this->connection);
                $voucherheader1->legalentitycode = 1;
                $voucherheader1->yearperiodcode = $_SESSION['yearperiodcode'];
                if ($this->goodscategorycode == 1)
                {
                    $voucherheader1->vouchersubtypecode = 14;
                    $voucherheader1->narration = 'साखर विक्री बिल नंबर - '
                    .$this->invoicenumberpresuf.' बिल दिनांक - '.$this->invoicedate
                    .' बिल रक्कम - '.$this->grossamount.' खरेदीदार '.$purchaser
                    .' यांना साखर विकली';
                }
                $invoicedate = DateTime::createFromFormat('d-M-Y',$this->invoicedate)->format('d/m/Y');
                $voucherheader1->voucherdate = $invoicedate;
                $voucherheader1->description = $purchaser;
                $voucherheader1->approvalstatus=9;
                $ret = $voucherheader1->insert();
                if ($ret==1)
                {
                    $query11 = "insert into nst_nasaka_sale.saleaccountbridge
                    (goodscategorycode,saletransactionnumber,accounttransactionnumber)
                    values (".$this->goodscategorycode.",".$this->transactionnumber.",".$voucherheader1->transactionnumber.")";
                    $result11 = oci_parse($this->connection, $query11);
                    //bridge insert record
                    if (oci_execute($result11,OCI_NO_AUTO_COMMIT))
                    {
                        $invoicedate = DateTime::createFromFormat('d-M-Y',$this->invoicedate)->format('d/m/Y');
                        $voucherheader1->voucherdate = $invoicedate;
                        $ret = $voucherheader1->generatevouchernumber();
                        if ($ret==1)
                        {
                            $ret = $voucherheader1->updatenextapprovalstage(1);
                        }
                    }
                    else
                    {
                        return false;
                    }
                }
                else
                {
                    return false;
                }
            }
            //common part for existing and new
            if ($ret == 1)
            {
                $query2 = "select nvl(sum(t.amount),0) as basicamount
                ,nvl(sum(t.cgstamount),0) as cgstamount
                ,nvl(sum(t.sgstamount),0) as sgstamount
                ,nvl(sum(t.igstamount),0) as igstamount
                ,nvl(sum(t.ugstamount),0) as ugstamount
                ,nvl(sum(t.vatamount),0) as vatamount
                ,nvl(sum(t.totaltaxamount),0) as totaltaxamount
                ,nvl(sum(t.grossamount),0) as grossamount
                from nst_nasaka_sale.saleinvoicedetail t
                where t.transactionnumber=".$this->transactionnumber; 
                $result2 = oci_parse($this->connection, $query2);
                $r2 = oci_execute($result2,OCI_NO_AUTO_COMMIT);
                if ($row2 = oci_fetch_array($result2,OCI_ASSOC+OCI_RETURN_NULLS))
                {
                    $accountsubledger1 = new accountsubledger($this->connection);
                    $accountsubledger1->accountcode = $row['DEBTORSACCOUNTCODE'];
                    $accountsubledger1->referencecode = 'P'.$this->purchasercode;
                    if ($accountsubledger1->fetchbyreference()==true)
                    {
                        //debtor debit
                        $voucherdetail1 = new voucherdetail($this->connection);
                        $voucherdetail1->transactionnumber = $voucherheader1->transactionnumber;
                        $voucherdetail1->accountcode = $row['DEBTORSACCOUNTCODE'];
                        $voucherdetail1->subledgercode = $accountsubledger1->subledgercode;
                        $voucherdetail1->debit = $row2['GROSSAMOUNT'];
                        if ($voucherdetail1->insert()==true)
                        {
                            //sale credit
                            $voucherdetail2 = new voucherdetail($this->connection);
                            $voucherdetail2->transactionnumber = $voucherheader1->transactionnumber;
                            $voucherdetail2->accountcode = $row['SALEACCOUNTCODE'];
                            //basic amount
                            if ($postingcategory==1)
                            {
                                $voucherdetail2->credit = $row2['BASICAMOUNT'];
                            }
                            //net amount
                            elseif ($postingcategory==2)
                            {
                                $voucherdetail2->credit = $row2['GROSSAMOUNT'];
                            }
                            if ($voucherdetail2->insert()==true)
                            {
                                //cgst
                                if ($row2['CGSTAMOUNT']>0)
                                {
                                    $voucherdetail3 = new voucherdetail($this->connection);
                                    $voucherdetail3->transactionnumber = $voucherheader1->transactionnumber;
                                    $voucherdetail3->accountcode = $row['CGSTACCOUNTCODE'];
                                    $voucherdetail3->credit = $row2['CGSTAMOUNT'];
                                    if ($voucherdetail3->insert()==false)
                                    {
                                        return false;
                                    }
                                }
                                //sgst
                                if ($row2['SGSTAMOUNT']>0)
                                {
                                    $voucherdetail4 = new voucherdetail($this->connection);
                                    $voucherdetail4->transactionnumber = $voucherheader1->transactionnumber;
                                    $voucherdetail4->accountcode = $row['SGSTACCOUNTCODE'];
                                    $voucherdetail4->credit = $row2['SGSTAMOUNT'];
                                    if ($voucherdetail4->insert()==false)
                                    {
                                        return false;
                                    }
                                }
                                //igst
                                if ($row2['IGSTAMOUNT']>0)
                                {
                                    $voucherdetail5 = new voucherdetail($this->connection);
                                    $voucherdetail5->transactionnumber = $voucherheader1->transactionnumber;
                                    $voucherdetail5->accountcode = $row['SGSTACCOUNTCODE'];
                                    $voucherdetail5->credit = $row2['IGSTAMOUNT'];
                                    if ($voucherdetail5->insert()==false)
                                    {
                                        return false;
                                    }
                                }
                                //ugst
                                if ($row2['UGSTAMOUNT']>0)
                                {
                                    $voucherdetail6 = new voucherdetail($this->connection);
                                    $voucherdetail6->transactionnumber = $voucherheader1->transactionnumber;
                                    $voucherdetail6->accountcode = $row['UGSTACCOUNTCODE'];
                                    $voucherdetail6->credit = $row2['UGSTAMOUNT'];
                                    if ($voucherdetail6->insert()==false)
                                    {
                                        return false;
                                    }
                                }
                                //vat
                                if ($row2['VATAMOUNT']>0)
                                {
                                    $voucherdetail7 = new voucherdetail($this->connection);
                                    $voucherdetail7->transactionnumber = $voucherheader1->transactionnumber;
                                    $voucherdetail7->accountcode = $row['VATACCOUNTCODE'];
                                    $voucherdetail7->credit = $row2['VATAMOUNT'];
                                    if ($voucherdetail7->insert()==false)
                                    {
                                        return false;
                                    }
                                }
                                //net amount
                                if ($postingcategory==2)
                                {
                                    //total tax expenses
                                    if ($row2['TOTALTAXAMOUNT']>0)
                                    {
                                        $voucherdetail7 = new voucherdetail($this->connection);
                                        $voucherdetail7->transactionnumber = $voucherheader1->transactionnumber;
                                        $voucherdetail7->accountcode = $row['GSTEXPENSES'];
                                        $voucherdetail7->debit = $row2['TOTALTAXAMOUNT'];
                                        if ($voucherdetail7->insert()==false)
                                        {
                                            return false;
                                        }
                                    }
                                }
                                $voucherdetail1->updateheader();
                                return true;
                            }
                            else
                            {
                                return false;    
                            }
                        }
                        else
                        {
                            return false;    
                        }
                    }
                    else
                    {
                        return false;
                    }
                }
                else
                {
                    return false;
                }
            }
        }
        else
        {
            return false;
        }
    }
    Public function invoicedeletewithunposting()
    {
        $ret=0;
        $transactionnumber=$this->transactionnumber;
        $sql = 'BEGIN Sale_Bill_Delete(:p_saletransactionnumber,:p_ret); END;';
        $result = oci_parse($this->connection,$sql);
        oci_bind_by_name($result,':p_saletransactionnumber',$this->transactionnumber,20,SQLT_INT);
        oci_bind_by_name($result,':p_ret',$p_ret,10,SQLT_INT);
        oci_execute($result);
        if ($p_ret==1)
        {
            return 1;
        }
        else
        {
            return 0;
        }
    }
    Public function invoicedeletewithposting()
    {
        $ret=0;
        $transactionnumber=$this->transactionnumber;
        $sql = 'BEGIN Sale_Bill_Delete_Posting(:p_saletransactionnumber,:p_ret); END;';
        $result = oci_parse($this->connection,$sql);
        oci_bind_by_name($result,':p_saletransactionnumber',$this->transactionnumber,20,SQLT_INT);
        oci_bind_by_name($result,':p_ret',$p_ret,10,SQLT_INT);
        oci_execute($result);
        if ($p_ret==1)
        {
            return 1;
        }
        else
        {
            return 0;
        }
    }

    Public function vouchertofinanceposting($action)
    {
        $ret=1;
        if ($action==1)
        {
            $this->generatesaleinvoicenumber();
            $ret=$this->updategeneratedinvoicenumber();
        }
         if ($ret==1)
        {
            $transactionnumber=$this->transactionnumber;
            $act=1;
            $sql = 'BEGIN Sale_Bill_Swapp_Posting(:p_saletransactionnumber,:p_action,:p_ret); END;';
            $result = oci_parse($this->connection,$sql);
            oci_bind_by_name($result,':p_saletransactionnumber',$transactionnumber,20,SQLT_INT);
            oci_bind_by_name($result,':p_action',$act,10,SQLT_INT);
            oci_bind_by_name($result,':p_ret',$p_ret,10,SQLT_INT);
            oci_execute($result);
            if ($p_ret==1)
            {
                return 1;
            }
            else
            {
                return 0;
            }
        }
        return $ret;
        exit;
    }

    Public function voucherwrongposting()
    {
        $sql = 'BEGIN sale_bill_wrong_posting; END;';
        $result = oci_parse($this->connection,$sql);
        oci_execute($result);
    }
    public function quantity()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select sum(salequantity) as salequantity 
        from nst_nasaka_sale.saleinvoicedetail d,finishedgoods f 
        where d.finishedgoodscode=f.finishedgoodscode 
        and d.transactionnumber = ".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            return $row['SALEQUANTITY'];
        }
        else
        {
            return 0;
        }
    }
    public function rate()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select avg(salerate) as salerate 
        from nst_nasaka_sale.saleinvoicedetail d,finishedgoods f 
        where d.finishedgoodscode=f.finishedgoodscode 
        and transactionnumber = ".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            return $row['SALERATE'];
        }
        else
        {
            return 0;
        }
    }
    public function getqrimage()
    {
        $query = "SELECT einv_qr_file as image FROM saleinvoiceheader WHERE transactionnumber =".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        oci_execute($result);
        $row = oci_fetch_array($result, OCI_ASSOC+OCI_RETURN_NULLS);
        if ($row['IMAGE']!='')
        $img = $row['IMAGE']->load();
        else
        $img =='';
        return $img;
    }
}
?>

