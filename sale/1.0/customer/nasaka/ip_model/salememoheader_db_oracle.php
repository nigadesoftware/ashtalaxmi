<?php
//This is generated by Swapp Software Application on 17/03/2019 11:12:38 AM for PHP
require_once("../swappbase/formbase.php");
require_once("../ip_model/goodspurchaser_db_oracle.php");
class salememoheader extends swappform
{
    Public $transactionnumber;
    Public $goodscategorycode;
    Public $salecategorycode;
    Public $yearperiodcode;
    Public $salememonumberseriesid;
    Public $salememonumberbasevalue;
    Public $memonumber;
    Public $memonumberpresuf;
    Public $memodate;
    Public $brokercode;
    Public $purchasercode;
    Public $shippingpartycode;
    Public $preparationtime;
    Public $removaltime;
    Public $vehiclenumber;
    Public $drivername;
    Public $driverlicenseno;
    Public $cgstamount;
    Public $sgstamount;
    Public $igstamount;
    Public $ugstamount;
    Public $vatamount;
    Public $tcs;
    Public $totaltaxamount;
    Public $grossamount;
    Public $taxableamount;
    Public $transportationamount;
    Public $tds;

    public $purchaser;
    public $shiftto;
    public $broker;
    Public $salecategorynameeng;
    Public $salecategorynameuni;

    public function __construct(&$connection)
    {
     	 parent::__construct($connection);
         $this->transactionnumber='';
         $this->goodscategorycode='';
         $this->salecategorycode='';
         $this->yearperiodcode='';
         $this->memonumber='';
         $this->memonumberpresuf='';
         $this->memodate='';
         $this->brokercode='';
         $this->purchasercode='';
         $this->shippingpartycode='';
         $this->preparationtime='';
         $this->removaltime='';
         $this->vehiclenumber='';
         $this->drivername='';
         $this->driverlicenseno='';
	}
    private function entryvalidation()
    {
    	$this->start_validation();
        $this->checkrequired($this->memodate,'Invoice Date');
        $this->checkrequired($this->brokercode,'Broker Name');
        $this->checkrequired($this->purchasercode,'Purchaser Name');
        $this->checkrequired($this->preparationtime,'Preparation Time');
        $this->checkrequired($this->removaltime,'Removal Time');
        $this->checkrequired($this->salecategorycode,'Sale Category');
        $this->end_validation();
        return $this->invalidid;
	  }
    private function datavalidation()
    {
        $this->start_validation();
        if ($this->balance($this->purchasercode)>=0)
        {
            $this->invalidid=-250;
            $this->invalidmessagetext='Insufficient Balance';
        }
        elseif ($this->salecategorycode==0)
        {
            $this->invalidid=-250;
            $this->invalidmessagetext='Sale Category Not Selected';
        }
        else
        {
            $this->invalidid=0;
            $this->invalidmessagetext='Validated';
        }
        
        $this->end_validation();
        return $this->invalidid;
    }
    public function generatesalememonumber()
	{
        if (!isset($this->memonumber) or $this->memonumber == '' )
        {
            $query = "select nvl(d.salenumberprefix,'') as salenumberprefix,periodresetcategorycode,transactioncategorycode from salenumberseries d where d.salenumberseriesid=".$this->salememonumberseriesid." and d.goodscategorycode=".$this->goodscategorycode;
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
            if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
            {
                switch ($row['PERIODRESETCATEGORYCODE'])
                {
                    case 1:
                    {
                        $prefix = $row["SALENUMBERPREFIX"];
                        //Sale memo transactioncategorycode=2
                        if ($row['TRANSACTIONCATEGORYCODE']==4)
                        {
                            //$memodate = DateTime::createFromFormat('d/m/Y',$this->memodate)->format('d-M-Y');
                            $query_12 = "select nvl(max(memonumber),0)+1 as memonumber,salenumberbasevalue('".$this->memodate."',1) as memonumberbasevalue  from salememoheader where yearperiodcode=".$this->yearperiodcode." and salememonumberbasevalue=salenumberbasevalue('".$this->memodate."',1) and salememonumberseriesid=".$this->salememonumberseriesid;
                        }
                        
                        $result_12 = oci_parse($this->connection, $query_12);
                        $r = oci_execute($result_12);
                        $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                        $THIS->memonumber = $ROW_12["MEMONUMBER"];
                        $this->memonumberpresuf = $prefix.str_pad($row_12["MEMONUMBER"],5,'0',STR_PAD_LEFT);
                        $this->memonumberbasevalue = $row_12["MEMONUMBERBASEVALUE"];
                        break;
                    }
                    case 2:
                    {
                        $prefix = $row["SALENUMBERPREFIX"];
                        //Sale memo transactioncategorycode=2
                        if ($row['TRANSACTIONCATEGORYCODE']==4)
                        {
                            //$memodate = DateTime::createFromFormat('d/m/Y',$this->memodate)->format('d-M-Y');
                            $query_12 = "select nvl(max(memonumber),0)+1 as memonumber,salenumberbasevalue('".$this->memodate."',2) as memonumberbasevalue  from salememoheader where yearperiodcode=".$this->yearperiodcode." and salememonumberbasevalue=salenumberbasevalue('".$this->memodate."',2) and salememonumberseriesid=".$this->salememonumberseriesid;
                        }
                        
                        //$query_12 = "select nvl(max(memonumber),0)+1 as memonumber,salenumberbasevalue('".$saledate."',2) as memonumberbasevalue from salememoheader where yearperiodcode=".$this->yearperiodcode." and memonumberbasevalue=salenumberbasevalue('".$saledate."',2) and memonumberseriesid=".$this->memonumberseriesid;
                        $result_12 = oci_parse($this->connection, $query_12);
                        $r = oci_execute($result_12);
                        $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                        $this->memonumber = $row_12["MEMONUMBER"];
                        $this->memonumberpresuf = $prefix.str_pad($row_12["MEMONUMBER"],5,'0',STR_PAD_LEFT);
                        $this->memonumberbasevalue = $row_12["MEMONUMBERBASEVALUE"];
                        break;
                    }
                    case 3:
                    {
                        $prefix = $row["SALENUMBERPREFIX"];
                        //Sale memo transactioncategorycode=2
                        if ($row['TRANSACTIONCATEGORYCODE']==4)
                        {
                            //$memodate = DateTime::createFromFormat('d/m/Y',$this->memodate)->format('d-M-Y');
                            $query_12 = "select nvl(max(memonumber),0)+1 as memonumber,salenumberbasevalue('".$this->memodate."',3) as memonumberbasevalue  from salememoheader where yearperiodcode=".$this->yearperiodcode." and salememonumberbasevalue=salenumberbasevalue('".$this->memodate."',3) and salememonumberseriesid=".$this->salememonumberseriesid;
                        }
                        //$query_12 = "select nvl(max(memonumber),0)+1 as memonumber,salenumberbasevalue('".$saledate."',3) as memonumberbasevalue from salememoheader where yearperiodcode=".$this->yearperiodcode." and memonumberbasevalue=salenumberbasevalue('".$saledate."',3) and memonumberseriesid=".$this->memonumberseriesid;
                        $result_12 = oci_parse($this->connection, $query_12);
                        $r = oci_execute($result_12);
                        $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                        $this->memonumber = $row_12["MEMONUMBER"];
                        $this->memonumberpresuf = $prefix.str_pad($row_12["MEMONUMBER"],5,'0',STR_PAD_LEFT);
                        $this->memonumberbasevalue = $row_12["MEMONUMBERBASEVALUE"];
                        break;
                    }
                    case 4:
                    {
                        $prefix = $row["SALENUMBERPREFIX"];
                        if ($row['TRANSACTIONCATEGORYCODE']==4)
                        {
                            //$memodate = DateTime::createFromFormat('d/m/Y',$this->memodate)->format('d-M-Y');
                            $query_12 = "select nvl(max(memonumber),0)+1 as memonumber,salenumberbasevalue('".$this->memodate."',4) as memonumberbasevalue  from salememoheader where yearperiodcode=".$this->yearperiodcode." and salememonumberbasevalue=salenumberbasevalue('".$this->memodate."',4) and salememonumberseriesid=".$this->salememonumberseriesid;
                        }
                        //$query_12 = "select nvl(max(memonumber),0)+1 as memonumber,salenumberbasevalue('".$saledate."',4) as memonumberbasevalue from salememoheader where yearperiodcode=".$this->yearperiodcode." and memonumberbasevalue=salenumberbasevalue('".$saledate."',4) and memonumberseriesid=".$this->memonumberseriesid;
                        $result_12 = oci_parse($this->connection, $query_12);
                        $r = oci_execute($result_12);
                        $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                        $this->memonumber = $row_12["MEMONUMBER"];
                        $this->memonumberpresuf = $prefix.'/'.$this->yearperiodcode.'/'.str_pad($row_12["MEMONUMBER"],5,'0',STR_PAD_LEFT);
                        $this->salememonumberbasevalue = $row_12["MEMONUMBERBASEVALUE"];
                        break;
                    }
                }
                return 1;
                exit;
            }
            else
            {
                return 0;
                exit;
            }
        }
        else
        {
            return 0;
            exit;
        }
	}
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        if ($this->salememonumberseriesid == '')
        {
            $query = "select s.salememonumberseriesid
            from salecategory s
            where salecategorycode=".$this->salecategorycode;
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->salememonumberseriesid = $row["SALEMEMONUMBERSERIESID"];
        }
	    if ($this->transactionnumber == '')
        {
            $query = "select nvl(max(transactionnumber),0)+1 as transactionnumber from salememoheader";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->transactionnumber = $row["TRANSACTIONNUMBER"];
        }
        if ($this->memodate!='')
        {
            $this->memodate = DateTime::createFromFormat('d/m/Y',$this->memodate)->format('d-M-Y');
        }
        if ($this->preparationtime!='')
        {
            $this->preparationtime = DateTime::createFromFormat('d/m/Y H:i',$this->preparationtime)->format('d-M-Y H:i');
        }
        if ($this->removaltime!='')
        {
            $this->removaltime = DateTime::createFromFormat('d/m/Y H:i',$this->removaltime)->format('d-M-Y H:i');
        }
        $this->generatesalememonumber();
        $query = "
            insert into salememoheader(
            transactionnumber
            ,goodscategorycode
            ,salecategorycode
            ,yearperiodcode
            ,salememonumberseriesid
            ,salememonumberbasevalue
            ,memonumber
            ,memonumberpresuf
            ,memodate
            ,brokercode
            ,purchasercode
            ,shippingpartycode
            ,preparationtime
            ,removaltime
            ,vehiclenumber
            ,drivername
            ,driverlicenseno
            ,cgstamount
            ,sgstamount
            ,igstamount
            ,ugstamount
            ,vatamount
            ,totaltaxamount
            ,grossamount
            ,taxableamount
	        )
	        values (
            ".$this->invl($this->transactionnumber,true)."
            ,".$this->invl($this->goodscategorycode,true)."
            ,".$this->invl($this->salecategorycode,true,true)."
            ,".$this->invl($this->yearperiodcode,true)."
            ,".$this->invl($this->salememonumberseriesid,true)."
            ,".$this->invl($this->salememonumberbasevalue,false)."
            ,".$this->invl($this->memonumber,true)."
            ,".$this->invl($this->memonumberpresuf,false)."
            ,".$this->invl($this->memodate,false)."
            ,".$this->invl($this->brokercode,true,true)."
            ,".$this->invl($this->purchasercode,true,true)."
            ,".$this->invl($this->shippingpartycode,true,true)."
            ,to_date(".$this->invl($this->preparationtime,false).",'dd-mon-yyyy hh24:mi')
            ,to_date(".$this->invl($this->removaltime,false).",'dd-mon-yyyy hh24:mi')
            ,".$this->invl($this->vehiclenumber,false)."
            ,".$this->invl($this->drivername,false)."
            ,".$this->invl($this->driverlicenseno,false)."
            ,".$this->invl($this->cgstamount,true)."
            ,".$this->invl($this->sgstamount,true)."
            ,".$this->invl($this->igstamount,true)."
            ,".$this->invl($this->ugstamount,true)."
            ,".$this->invl($this->vatamount,true)."
            ,".$this->invl($this->totaltaxamount,true)."
            ,".$this->invl($this->grossamount,true)."
            ,".$this->invl($this->taxableamount,true)."
            
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='';
		    if ($this->salecategorycode!='' and $this->salecategorycode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.salecategorycode = ".$this->salecategorycode;
			       }
			       else
			       {
				         $cond=$cond." and t.salecategorycode = ".$this->salecategorycode;
			       }
		    }
		    if ($this->memonumber!='' and $this->memonumber!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.memonumber = ".$this->memonumber;
			       }
			       else
			       {
				         $cond=$cond." and t.memonumber = ".$this->memonumber;
			       }
		    }
		    if ($this->memonumberpresuf!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.memonumberpresuf like '%".$this->memonumberpresuf."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.memonumberpresuf like '%".$this->memonumberpresuf."%'";
			       }
		    }
		    if ($this->memodate!='')
		    {
			      $this->memodate = DateTime::createFromFormat('d/m/Y',$this->memodate)->format('d-M-Y');
			      if ($cond=='')
			      {
				        $cond="t.memodate = '".$this->memodate."'";
			       }
			       else
			       {
				         $cond=$cond." and t.memodate = '".$this->memodate."'";
			       }
		    }
		    if ($this->brokercode!='' and $this->brokercode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.brokercode = ".$this->brokercode;
			       }
			       else
			       {
				         $cond=$cond." and t.brokercode = ".$this->brokercode;
			       }
		    }
		    if ($this->purchasercode!='' and $this->purchasercode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.purchasercode = ".$this->purchasercode;
			       }
			       else
			       {
				         $cond=$cond." and t.purchasercode = ".$this->purchasercode;
			       }
		    }
		    if ($this->vehiclenumber!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.vehiclenumber like '%".$this->vehiclenumber."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.vehiclenumber like '%".$this->vehiclenumber."%'";
			       }
		    }
        if ($cond!='')
		    {
		        $query = "select t.* from salememoheader t where ".$cond." order by transactionnumber";
			      $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
			      return $result;
		     }
		     else
		     {
		         $query = "select t.* from salememoheader t order by transactionnumber";
			       $result = oci_parse($this->connection, $query);
             $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
			       return $result;
		     }
	  }
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->memodate = DateTime::createFromFormat('d/m/Y',$this->memodate)->format('d-M-Y');
        $this->preparationtime = DateTime::createFromFormat('d/m/Y H:i',$this->preparationtime)->format('d-M-Y H:i');
        $this->removaltime = DateTime::createFromFormat('d/m/Y H:i',$this->removaltime)->format('d-M-Y H:i');
        $query = "
        update salememoheader set 
        goodscategorycode = ".$this->invl($this->goodscategorycode,true)."
        ,salecategorycode = ".$this->invl($this->salecategorycode,true)."
        ,yearperiodcode = ".$this->invl($this->yearperiodcode,true)."
        ,salememonumberseriesid = ".$this->invl($this->salememonumberseriesid,true)."
        ,salememonumberbasevalue = ".$this->invl($this->salememonumberbasevalue,false)."
        ,memonumber = ".$this->invl($this->memonumber,true)."
        ,memonumberpresuf =".$this->invl($this->memonumberpresuf,false)."
        ,memodate =".$this->invl($this->memodate,false)."
        ,brokercode = ".$this->invl($this->brokercode,true)."
        ,purchasercode = ".$this->invl($this->purchasercode,true)."
        ,shippingpartycode = ".$this->invl($this->shippingpartycode,true)."
        ,preparationtime = to_date(".$this->invl($this->preparationtime,false).",'dd-mon-yyyy hh24:mi')
        ,removaltime = to_date(".$this->invl($this->removaltime,false).",'dd-mon-yyyy hh24:mi')
        ,vehiclenumber =".$this->invl($this->vehiclenumber,false)."
        ,drivername =".$this->invl($this->drivername,false)."
        ,driverlicenseno =".$this->invl($this->driverlicenseno,false)."
        ,cgstamount = ".$this->invl($this->cgstamount,true)."
        ,sgstamount = ".$this->invl($this->sgstamount,true)."
        ,igstamount = ".$this->invl($this->igstamount,true)."
        ,ugstamount = ".$this->invl($this->ugstamount,true)."
        ,vatamount = ".$this->invl($this->vatamount,true)."
        ,totaltaxamount = ".$this->invl($this->totaltaxamount,true)."
        ,grossamount = ".$this->invl($this->grossamount,true)."
        ,taxableamount = ".$this->invl($this->taxableamount,true)."  
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->memodate = DateTime::createFromFormat('d/m/Y',$this->memodate)->format('d-M-Y');
        $query = "
        delete from salememoheader
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
             return 1;
             exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        h.transactionnumber
        ,h.goodscategorycode
        ,h.salecategorycode
        ,yearperiodcode
        ,h.salememonumberseriesid
        ,salememonumberbasevalue
        ,memonumber
        ,memonumberpresuf
        ,memodate
        ,brokercode
        ,purchasercode
        ,shippingpartycode
        ,to_char(preparationtime,'DD-MON-YYYY HH24:MI') as preparationtime
        ,to_char(removaltime,'DD-MON-YYYY HH24:MI') as removaltime
        ,vehiclenumber
        ,drivername
        ,driverlicenseno
        ,cgstamount
        ,sgstamount
        ,igstamount
        ,ugstamount
        ,totaltaxamount
        ,tcs
        ,grossamount
        ,s.salecategorynameeng
        ,s.salecategorynameuni
        ,taxableamount
        ,transportationamount
        ,tds
        from nst_nasaka_sale.salememoheader h
        ,nst_nasaka_sale.salecategory s 
        where h.salecategorycode=s.salecategorycode
        and h.transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $this->transactionnumber = $row['TRANSACTIONNUMBER'];
            $this->goodscategorycode = $row['GOODSCATEGORYCODE'];
            $this->salecategorycode = $row['SALECATEGORYCODE'];
            $this->yearperiodcode = $row['YEARPERIODCODE'];
            $this->salememonumberseriesid = $row['SALEMEMONUMBERSERIESID'];
            $this->salememonumberbasevalue = $row['SALEMEMONUMBERBASEVALUE'];
            $this->memonumber = $row['MEMONUMBER'];
            $this->memonumberpresuf = $row['MEMONUMBERPRESUF'];
            $this->memodate = DateTime::createFromFormat('d-M-y',$row['MEMODATE'])->format('d/m/Y');
            $this->brokercode = $row['BROKERCODE'];
            $this->purchasercode = $row['PURCHASERCODE'];
            $this->shippingpartycode = $row['SHIPPINGPARTYCODE'];
            $this->preparationtime = DateTime::createFromFormat('d-M-Y H:i',$row['PREPARATIONTIME'])->format('d/m/Y H:i');
            $this->removaltime = DateTime::createFromFormat('d-M-Y H:i',$row['REMOVALTIME'])->format('d/m/Y H:i');
            $this->vehiclenumber = $row['VEHICLENUMBER'];
            $this->drivername = $row['DRIVERNAME'];
            $this->driverlicenseno = $row['DRIVERLICENSENO'];
            $this->cgstamount = $row['CGSTAMOUNT'];
            $this->sgstamount = $row['SGSTAMOUNT'];
            $this->igstamount = $row['IGSTAMOUNT'];
            $this->ugstamount = $row['UGSTAMOUNT'];
            $this->vatamount = $row['VATAMOUNT'];
            $this->tcs = $row['TCS'];
            $this->totaltaxamount = $row['TOTALTAXAMOUNT'];
            $this->grossamount = $row['GROSSAMOUNT'];
            $this->taxableamount = $row['TAXABLEAMOUNT'];  
            $this->transportationamount = $row['TRANSPORTATIONAMOUNT'];  
            $broker1 = new goodspurchaser($this->connection);
            $broker1->purchasercode = $this->brokercode;
            $broker1->goodscategorycode = $this->goodscategorycode;
            $broker1->fetch();
            if ($_SESSION['lng']=="English")
            {
                $this->broker = $broker1->purchasernameeng;
            }
            else
            {
                $this->broker = $broker1->purchasernameuni; 
            }

            $goodspurchaser1 = new goodspurchaser($this->connection);
            $goodspurchaser1->purchasercode = $this->purchasercode;
            $goodspurchaser1->goodscategorycode = $this->goodscategorycode;
            $goodspurchaser1->fetch();
            if ($_SESSION['lng']=="English")
            {
                $this->purchaser = $goodspurchaser1->purchasernameeng;
            }
            else
            {
                $this->purchaser = $goodspurchaser1->purchasernameuni; 
            }
            $shiftto1 = new goodspurchaser($this->connection);
            $shiftto1->purchasercode = $this->shippingpartycode;
            $shiftto1->goodscategorycode = $this->goodscategorycode;
            $shiftto1->fetch();
            if ($_SESSION['lng']=="English")
            {
                $this->shiftto = $shiftto1->purchasernameeng;
            }
            else
            {
                $this->shiftto = $shiftto1->purchasernameuni; 
            }
            $this->salecategorynameeng = $row['SALECATEGORYNAMEENG'];
            $this->salecategorynameuni = $row['SALECATEGORYNAMEUNI'];
            $this->tds = $row['TDS'];
            $this->found=true;
            return true;
        }
        else
        {
        return false;
        }
    }
    public function isinvoiceexist()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select count(*) as cnt 
        from saleinvoiceheader h
        where h.goodscategorycode = ".$this->goodscategorycode." 
        and h.salememotransactionnumber = ".$this->transactionnumber;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            if ($row['CNT']==0)
            {
                return false;
            }
            else
            {
                return true;
            }
        }
        else
        {
            return false;
        }
    }
    public function balance($purchasercode)
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select subledger,sum(clearbalance+uncleardebit) as balance 
        from (
        select subledgercode as subledger,nst_nasaka_finance.subaccountclosingbalance(p_yearcode => ".$_SESSION['yearperiodcode'].",p_accountcode => 1100099,p_subledgercode => p.subledgercode) as clearbalance,0 as uncleardebit
        from (select t.subledgercode 
        from nst_nasaka_finance.accountsubledger t
        where t.accountcode=1100099 and t.referencecode='P'||".$purchasercode.")p
        union all
        select g.subledgercode,0 as clearbalance,nvl(sum(h.grossamount),0) as uncleardebit 
        from nst_nasaka_sale.salememoheader h
        ,nst_nasaka_sale.goodspurchaser p
        ,nst_nasaka_finance.accountsubledger g 
        where h.purchasercode=p.purchasercode
        and g.accountcode=1100099 
        and to_number(substr(g.referencecode,2,10))=p.purchasercode
        and p.purchasercode=".$purchasercode."
        and h.transactionnumber not in (select s.salememotransactionnumber 
        from nst_nasaka_sale.saleinvoiceheader s where nvl(s.grossamount,0)>0
        and s.purchasercode=p.purchasercode and s.invoicenumber is not null)
        group by g.subledgercode) t
        group by subledger";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            return $row['BALANCE'];
        }
        else
        {
            return 0;
        }
    }
}
?>