<?php
//This is generated by Nigade Software Technologies (opc) Private Limited 11/02/2021 04:33:42 pm for PHP
require_once("../swappbase/formbase.php");
class otherweight extends swappform
{
    Public $transactionnumber;
    Public $yearperiodcode;
    Public $receiptnumber;
    Public $weighmentdate;
    Public $purchasercode;
    Public $partycustomer;
    Public $place;
    Public $vehiclenumber;
    Public $loadweight;
    Public $emptyweight;
    Public $netweight;
    Public $userid;
    Public $weightcategorycode;
    Public $narration;
    Public $othmatcategorycode;
    Public $othmatcategorycodetextcombo;
    Public $balance;
    Public $balancetype;
    Public $rate;

    public function __construct(&$connection)
    {
     		 parent::__construct($connection);
         $this->transactionnumber='';
         $this->transactionnumbertextcombo='';
         $this->yearperiodcode='';
         $this->yearperiodcodetextcombo='';
         $this->receiptnumber='';
         $this->receiptnumbertextcombo='';
         $this->weighmentdate='';
         $this->weighmentdatetextcombo='';
         $this->partycustomer='';
         $this->partycustomertextcombo='';
         $this->place='';
         $this->placetextcombo='';
         $this->vehiclenumber='';
         $this->vehiclenumbertextcombo='';
         $this->loadweight='';
         $this->loadweighttextcombo='';
         $this->emptyweight='';
         $this->emptyweighttextcombo='';
         $this->netweight='';
         $this->netweighttextcombo='';
         $this->userid='';
         $this->useridtextcombo='';
	   }
    public function entryvalidation()
    {
    		$this->start_validation();
        $this->checkrequired($this->partycustomer,'Supplier Customer','पुरवठादार ग्राहक');
        $this->checkrequired($this->vehiclenumber,'Vehicle Number','वाहन नंबर');
        $this->checkrequired($this->othmatcategorycode,'Oth Mat Cat','इतर माल वर्ग');
        if ($_POST['weightcategorycode']==1)
        $this->checkrequired($this->loadweight,'Load Weight','भरगाडी वजन');
        if ($_POST['weightcategorycode']==2)
        $this->checkrequired($this->emptyweight,'Load Weight','रिकामीगाडी वजन');
        if ($this->othmatcategorycode==10)
        {
            $this->checkrequired($this->purchasercode,'Purchaser','खरेदीदार');
            if ($this->balancetype == 'Dr')
            {
                $this->invalidid=-200;
                $this->invalidmessagetext='No Balance';
            }
            if ($this->balancetype == 'Cr' and ($this->balance-(($this->rate+($this->rate*0.05))*$this->netweight))<0)
            {
                $this->invalidid=-201;
                $this->invalidmessagetext='Insufficient Balance';
            }
        }
        $this->end_validation();
        return $this->invalidid;
	  }
    private function datavalidation()
    {
        $this->start_validation();
    		$this->invalidid=0;
    		$this->invalidmessagetext='Validated';
    		$this->end_validation();
    		return $this->invalidid;
    }
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
	    if ($this->transactionnumber == '')
        {
            $query = "select nvl(max(transactionnumber),0)+1 as transactionnumber from otherweight";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->transactionnumber = $row["TRANSACTIONNUMBER"];
        }
	    $this->yearperiodcode=$_SESSION['yearperiodcode'];
        if ($this->receiptnumber == '')
        {
            $query = "select nvl(max(receiptnumber),0)+1 as receiptnumber from otherweight where yearperiodcode=".$this->yearperiodcode;
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->receiptnumber = $row["RECEIPTNUMBER"];
        }
        if ($this->loadweight!='' and $this->emptyweight=='' and ($this->netweight=='' or $this->netweight==0))
        {
            $query = "select to_char(sysdate,'dd-mon-yyyy hh24:mi:ss') as dt
            from dual";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->loaddatetime = $row['DT'];
            $query = "
            insert into otherweight(
            transactionnumber
            ,yearperiodcode
            ,receiptnumber
            ,weighmentdate
            ,purchasercode
            ,partycustomer
            ,place
            ,vehiclenumber
            ,loadweight
            ,emptyweight
            ,netweight
            ,userid
            ,narration
            ,othmatcategorycode
            ,loaddatetime
	        )
	        values (
            ".$this->invl($this->transactionnumber,true)."
            ,".$this->invl($this->yearperiodcode,true)."
            ,".$this->invl($this->receiptnumber,true)."
            ,".$this->invl($this->weighmentdate,false)."
            ,".$this->invl($this->purchasercode,true)."
            ,".$this->invl($this->partycustomer,false)."
            ,".$this->invl($this->place,false)."
            ,".$this->invl($this->vehiclenumber,false)."
            ,".$this->invl($this->loadweight,true)."
            ,".$this->invl($this->emptyweight,true)."
            ,".$this->invl($this->netweight,true)."
            ,".$this->invl($this->userid,true)."
            ,".$this->invl($this->narration,false)."
            ,".$this->invl($this->othmatcategorycode,true)."
            ,to_date(".$this->invl($this->loaddatetime,false).",'dd-mon-yyyy hh24:mi:ss')
            )";
        }
        elseif ($this->loadweight=='' and $this->emptyweight!='' and ($this->netweight=='' or $this->netweight==0))
        {
            $query = "select to_char(sysdate,'dd-mon-yyyy hh24:mi:ss') as dt
            from dual";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->emptydatetime = $row['DT'];
            $query = "
            insert into otherweight(
            transactionnumber
            ,yearperiodcode
            ,receiptnumber
            ,weighmentdate
            ,purchasercode
            ,partycustomer
            ,place
            ,vehiclenumber
            ,loadweight
            ,emptyweight
            ,netweight
            ,userid
            ,narration
            ,othmatcategorycode
            ,emptydatetime
	        )
	        values (
            ".$this->invl($this->transactionnumber,true)."
            ,".$this->invl($this->yearperiodcode,true)."
            ,".$this->invl($this->receiptnumber,true)."
            ,".$this->invl($this->weighmentdate,false)."
            ,".$this->invl($this->purchasercode,true)."
            ,".$this->invl($this->partycustomer,false)."
            ,".$this->invl($this->place,false)."
            ,".$this->invl($this->vehiclenumber,false)."
            ,".$this->invl($this->loadweight,true)."
            ,".$this->invl($this->emptyweight,true)."
            ,".$this->invl($this->netweight,true)."
            ,".$this->invl($this->userid,true)."
            ,".$this->invl($this->narration,false)."
            ,".$this->invl($this->othmatcategorycode,true)."
            ,to_date(".$this->invl($this->emptydatetime,false).",'dd-mon-yyyy hh24:mi:ss')
            )";
        }
        else {
            $this->invalidid=0;
    		$this->invalidmessagetext='not saved';
        }
        /* if ($this->weighmentdate=='' or $this->weighmentdate==null)
        {
            $query = "select to_char(sysdate,'dd-mon-yyyy hh24:mi:ss') as dt
            from dual";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->weighmentdate = $row['DT'];
        } */
        
        /* if ($this->weighmentdate!='')
        {
            $this->weighmentdate = DateTime::createFromFormat('d/m/Y',$this->weighmentdate)->format('d-M-Y');
        } */
        //,to_date(".$this->invl($this->weighmentdate,false).",'dd-mon-yyyy hh24:mi:ss') 
        
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='';
		    if ($this->receiptnumber!='' and $this->receiptnumber!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.receiptnumber = ".$this->receiptnumber;
			       }
			       else
			       {
				         $cond=$cond." and t.receiptnumber = ".$this->receiptnumber;
			       }
		    }
		    if ($this->weighmentdate!='')
		    {
			      $this->weighmentdate = DateTime::createFromFormat('d/m/Y',$this->weighmentdate)->format('d-M-Y');
			      if ($cond=='')
			      {
				        $cond="trunc(t.weighmentdate) = '".$this->weighmentdate."'";
			       }
			       else
			       {
				         $cond=$cond." and trunc(t.weighmentdate) = '".$this->weighmentdate."'";
			       }
		    }
            if ($this->purchasercode!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.purchasercode like '%".$this->purchasercode."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.purchasercode like '%".$this->purchasercode."%'";
			       }
		    }
		    if ($this->partycustomer!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.partycustomer like '%".$this->partycustomer."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.partycustomer like '%".$this->partycustomer."%'";
			       }
		    }
		    if ($this->vehiclenumber!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.vehiclenumber like '%".$this->vehiclenumber."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.vehiclenumber like '%".$this->vehiclenumber."%'";
			       }
		    }
            if ($this->othmatcategorycode!='' and $this->othmatcategorycode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.othmatcategorycode = ".$this->othmatcategorycode;
			       }
			       else
			       {
				         $cond=$cond." and t.othmatcategorycode = ".$this->othmatcategorycode;
			       }
		    }

            
        if ($cond!='')
		    {
		        $cond=$cond." and t.yearperiodcode = ".$_SESSION['yearperiodcode'];
                $query = "select t.* from otherweight t where ".$cond." order by transactionnumber desc";
			      $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
			      return $result;
		     }
		     else
		     {
		        $cond=" t.yearperiodcode = ".$_SESSION['yearperiodcode'];
                $query = "select t.* from otherweight t where ".$cond." order by transactionnumber desc";
			       $result = oci_parse($this->connection, $query);
             $r = oci_execute($result);
			       return $result;
		     }
	  }
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $query = "select * from otherweight
        where transactionnumber = ".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            if ($this->loadweight!='' and $row['LOADWEIGHT']=='' and ($row['NETWEIGHT']=='' or $row['NETWEIGHT']==0) and $this->emptyweight!='' and $this->netweight!='')
            {
                $query = "select to_char(sysdate,'dd-mon-yyyy hh24:mi:ss') as dt
                from dual";
                $result = oci_parse($this->connection, $query);
                $r = oci_execute($result);
                $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
                $this->loaddatetime = $row['DT'];
                $this->weighmentdate = $row['DT'];
                //to_date(".$this->invl($this->weighmentdate,false).",'dd-mon-yyyy hh24:mi:ss')
                $query = "
                update otherweight set 
                purchasercode =".$this->invl($this->purchasercode,true)."
                ,partycustomer =".$this->invl($this->partycustomer,false)."
                ,place =".$this->invl($this->place,false)."
                ,vehiclenumber =".$this->invl($this->vehiclenumber,false)."
                ,loadweight = ".$this->invl($this->loadweight,true,true)."
                ,emptyweight = ".$this->invl($this->emptyweight,true,true)."
                ,netweight = ".$this->invl($this->netweight,true,true)."
                ,narration = ".$this->invl($this->narration,false)."
                ,othmatcategorycode = ".$this->invl($this->othmatcategorycode,false)."
                ,loaddatetime = to_date(".$this->invl($this->loaddatetime,false).",'dd-mon-yyyy hh24:mi:ss')
                ,weighmentdate = to_date(".$this->invl($this->weighmentdate,false).",'dd-mon-yyyy hh24:mi:ss')
                where 
                transactionnumber = ".$this->invl($this->transactionnumber,true)."
                ";
            }
            elseif (($this->loadweight!='' and $this->emptyweight!='' and $row['EMPTYWEIGHT']=='' and ($row['NETWEIGHT']=='' or $row['NETWEIGHT']==0) and $this->netweight!=''))
            {
                $query = "select to_char(sysdate,'dd-mon-yyyy hh24:mi:ss') as dt
                from dual";
                $result = oci_parse($this->connection, $query);
                $r = oci_execute($result);
                $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
                $this->emptydatetime = $row['DT'];
                $this->weighmentdate = $row['DT'];
                $query = "
                update otherweight set 
                purchasercode =".$this->invl($this->purchasercode,true)."
                ,partycustomer =".$this->invl($this->partycustomer,false)."
                ,place =".$this->invl($this->place,false)."
                ,vehiclenumber =".$this->invl($this->vehiclenumber,false)."
                ,loadweight = ".$this->invl($this->loadweight,true,true)."
                ,emptyweight = ".$this->invl($this->emptyweight,true,true)."
                ,netweight = ".$this->invl($this->netweight,true,true)."
                ,narration = ".$this->invl($this->narration,false)."
                ,othmatcategorycode = ".$this->invl($this->othmatcategorycode,false)."
                ,emptydatetime = to_date(".$this->invl($this->emptydatetime,false).",'dd-mon-yyyy hh24:mi:ss')
                ,weighmentdate = to_date(".$this->invl($this->weighmentdate,false).",'dd-mon-yyyy hh24:mi:ss')
                where 
                transactionnumber = ".$this->invl($this->transactionnumber,true)."
                ";
            }
            else
            {
                $query = "
                update otherweight set 
                purchasercode =".$this->invl($this->purchasercode,true)."
                ,partycustomer =".$this->invl($this->partycustomer,false)."
                ,place =".$this->invl($this->place,false)."
                where 
                transactionnumber = ".$this->invl($this->transactionnumber,true)."
                ";

            }
        }
        
        //$this->weighmentdate = DateTime::createFromFormat('d/m/Y',$this->weighmentdate)->format('d-M-Y');
        //,userid = ".$this->invl($this->userid,true,true)."
        
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        //$this->weighmentdate = DateTime::createFromFormat('d/m/Y',$this->weighmentdate)->format('d-M-Y');
        $query = "
        delete from otherweight
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
             return 1;
             exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        transactionnumber
        ,yearperiodcode
        ,receiptnumber
        ,to_char(weighmentdate,'dd/mm/yyyy hh24:mi:ss') weighmentdate
        ,t.purchasercode 
        ,partycustomer
        ,place
        ,vehiclenumber
        ,nvl(loadweight,0) loadweight
        ,nvl(emptyweight,0) emptyweight
        ,netweight
        ,userid
        ,narration
        ,t.othmatcategorycode
        ,othmatcategorynameeng
        ,othmatcategorynameuni
        ,p.purchasernameeng
        ,p.purchasernameuni
        from otherweight t,othermaterial m,nst_nasaka_byproductsale.goodspurchaser p 
        where 
        t.othmatcategorycode=m.othmatcategorycode 
        and t.purchasercode=p.purchasercode(+)
        and t.transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->transactionnumber = $row['TRANSACTIONNUMBER'];
                $this->yearperiodcode = $row['YEARPERIODCODE'];
                $this->receiptnumber = $row['RECEIPTNUMBER'];
                $this->weighmentdate = $row['WEIGHMENTDATE'];
                $this->purchasercode = $row['PURCHASERCODE'];
                $this->partycustomer = $row['PARTYCUSTOMER'];
                $this->place = $row['PLACE'];
                $this->vehiclenumber = $row['VEHICLENUMBER'];
                $this->loadweight = $row['LOADWEIGHT'];
                $this->emptyweight = $row['EMPTYWEIGHT'];
                $this->netweight = $row['NETWEIGHT'];
                $this->userid = $row['USERID'];
                $this->narration = $row['NARRATION'];
                $this->othmatcategorycode = $row['OTHMATCATEGORYCODE'];
                if ($_SESSION['lng']=="English")
                {
                    $this->othmatcategorycodetextcombo = $row['OTHMATCATEGORYNAMEENG'];
                    $this->purchasercodetextcombo = $row['PURCHASERNAMEENG'];
                }
                else
                {
                    $this->othmatcategorycodetextcombo = $row['OTHMATCATEGORYNAMEUNI'];
                    $this->purchasercodetextcombo = $row['PURCHASERNAMEUNI'];
                }
                $this->found=true;
                return true;
        }
        else
        {
            return false;
        }
    }

    public function pending($weightcategorycode)
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='t.yearperiodcode='.$_SESSION['yearperiodcode'];
		    if ($weightcategorycode==1)
		    {
                if ($cond=='')
                {
                    $cond="nvl(loadweight,0)=0";
                }
                else
                {
                    $cond=$cond." and nvl(loadweight,0)=0";
                }
		    }
            elseif ($weightcategorycode==2)
		    {
                if ($cond=='')
                {
                    $cond="nvl(emptyweight,0)=0";
                }
                else
                {
                    $cond=$cond." and nvl(emptyweight,0)=0";
                }
		    }
        if ($cond!='')
		    {
		        $query = "select 
                transactionnumber
                ,yearperiodcode
                ,receiptnumber
                ,to_char(weighmentdate,'dd/mm/yyyy hh24:mi:ss') weighmentdate
                ,purchasercode
                ,partycustomer
                ,place
                ,vehiclenumber
                ,nvl(loadweight,0) loadweight
                ,nvl(emptyweight,0) emptyweight
                ,netweight
                ,narration
                ,othmatcategorycode
                ,userid from otherweight t where ".$cond." order by transactionnumber";
			      $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
			      return $result;
		     }
		     else
		     {
		         $query = "select  
                 transactionnumber
                 ,yearperiodcode
                 ,receiptnumber
                 ,to_char(weighmentdate,'dd/mm/yyyy hh24:mi:ss') weighmentdate
                 ,purchasercode
                 ,partycustomer
                 ,place
                 ,vehiclenumber
                 ,nvl(loadweight,0) loadweight
                 ,nvl(emptyweight,0) emptyweight
                 ,netweight
                 ,othmatcategorycode
                 ,userid from otherweight t order by transactionnumber";
			       $result = oci_parse($this->connection, $query);
             $r = oci_execute($result);
			       return $result;
		     }
	  }
      public function balance($goodscategorycode,$purchasercode)
      {
          $this->dataoperationmode = operationmode::Select;
          if ($goodscategorycode==5)
          {
                $othmatcategorycode=10;
                $finishgoodscode=13;
                $gst=5/100;
                $tcs=0;
          }
          else if ($goodscategorycode==4)
          {
                $othmatcategorycode=11;
                $finishgoodscode=20;
                $gst=5/100;
                $tcs=0.1/100;
          }
          else if ($goodscategorycode==3)
          {
                $othmatcategorycode=7;
                $finishgoodscode=14;
                $gst=5/100;
                $tcs=0.1/100;
          }    
          $query = "select nvl(sum(balance),0) balance from (select nst_finance.subaccountclosingbalance(p_yearcode => nst_db.GETCURRENTYEAR(3)
          ,p_accountcode => c.debtorsaccountcode
          ,p_subledgercode => nst_finance.subledgercodebyprodpurcode(p_goodscategorycode => ".$goodscategorycode."
          ,p_purchasercode => ".$purchasercode.",p_accountcode => c.debtorsaccountcode)) balance 
          from nst_nasaka_byproductsale.salecontroltable c 
          where c.goodscategorycode=".$goodscategorycode." and c.postingcategory=2
          union all
          select nvl(netweight,0)*nvl(salerate,0)+(nvl(netweight,0)*nvl(salerate,0)*{$gst})+(nvl(netweight,0)*nvl(salerate,0)*{$tcs}) balance
          from (
          select w.netweight,(select t.salerate
          from nst_nasaka_byproductsale.FINISHEDGOODSRATEMASTER t
          where t.fromdate<=w.weighmentdate and t.todate>=w.weighmentdate
          and t.finishedgoodscode={$finishgoodscode}) salerate
          from otherweight w
          where w.othmatcategorycode={$othmatcategorycode} 
          and w.purchasercode= ".$purchasercode."
          and saletransactionnumber is null))";
          $result = oci_parse($this->connection, $query);
          $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
          if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
          {
              return round($row['BALANCE'],2);
          }
          else
          {
              return 0;
          }
      }
      
      public function rate($goodscategorycode)
      {
          $this->dataoperationmode = operationmode::Select;
          $query = "select t.salerate
          from nst_nasaka_byproductsale.FINISHEDGOODSRATEMASTER t,nst_nasaka_byproductsale.finishedgoods g
          where t.fromdate<=trunc(sysdate) and t.todate>=trunc(sysdate)
          and t.finishedgoodscode=g.finishedgoodscode and g.goodscategorycode=".$goodscategorycode;
          $result = oci_parse($this->connection, $query);
          $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
          if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
          {
              return $row['SALERATE'];
          }
          else
          {
              return 0;
          }
      }
}
?>

