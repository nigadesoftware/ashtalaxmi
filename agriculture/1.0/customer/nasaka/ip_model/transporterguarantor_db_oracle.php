<?php
//This is generated by Swapp Software Application on 13/05/2019 12:16:43 PM for PHP
require_once("../swappbase/formbase.php");
require_once("../ip_model/vehicle_db_oracle.php");

class transporterguarantor extends swappform
{
    Public $transactionnumber;
    Public $seasoncode;
    Public $servicetrhrcategorycode;
    Public $vehiclecode1;
    Public $vehiclecode2;
    Public $vehiclecode3;
    Public $vehicle1;
    Public $vehicle2;
    Public $vehicle3;
    public function __construct(&$connection)
    {
     		 parent::__construct($connection);
         $this->transactionnumber='';
         $this->seasoncode='';
         $this->servicetrhrcategorycode='';
         $this->vehiclecode1='';
         $this->vehiclecode2='';
         $this->vehiclecode3='';
	   }
    public function entryvalidation()
    {
    	$this->start_validation();
        $this->checkrequired($this->vehiclecode1,'Vehicle 1');
        $this->checkrequired($this->vehiclecode2,'Vehicle 2');
        $this->checkrequired($this->vehiclecode3,'Vehicle 3');
        if ($this->vehiclecode1==$this->vehiclecode2 or $this->vehiclecode1==$this->vehiclecode3 or $this->vehiclecode2==$this->vehiclecode3)
        {
            $this->invalidid=-123;
            $this->invalidmessagetext='Invalid vehicle number';
        }
        $this->end_validation();
        return $this->invalidid;
	}
    private function datavalidation()
    {
        $this->start_validation();
        
        $query = "select count(*) as cnt from transporterguarantor
        where (vehiclecode1=".$this->vehiclecode1." or
        vehiclecode1=".$this->vehiclecode2." or 
        vehiclecode1=".$this->vehiclecode3.") and
        (vehiclecode2=".$this->vehiclecode1." or
        vehiclecode2=".$this->vehiclecode2." or 
        vehiclecode2=".$this->vehiclecode3.") and
        (vehiclecode3=".$this->vehiclecode1." or
        vehiclecode3=".$this->vehiclecode2." or 
        vehiclecode3=".$this->vehiclecode3.")";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            if ($row['CNT']>0 and $this->dataoperationmode == operationmode::Insert)
            {
                $this->invalidid=-234;
                $this->invalidmessagetext='Record already exists';
            }
            elseif ($row['CNT']>1 and $this->dataoperationmode == operationmode::Update)
            {
                $this->invalidid=-234;
                $this->invalidmessagetext='Record already exists';
            }
            else
            {
                $this->invalidid=0;
                $this->invalidmessagetext='Validated';
            }
        }
        else
        {
            $this->invalidid=0;
            $this->invalidmessagetext='Validated';
        }
        
        $this->end_validation();
        return $this->invalidid;
    }
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
	    if ($this->transactionnumber == '')
        {
            $query = "select nvl(max(transactionnumber),0)+1 as transactionnumber 
            from transporterguarantor 
            where seasoncode=".$this->seasoncode;
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->transactionnumber = $row["TRANSACTIONNUMBER"];
        }
        $query = "
            insert into transporterguarantor(
            transactionnumber
            ,seasoncode
            ,servicetrhrcategorycode
            ,vehiclecode1
            ,vehiclecode2
            ,vehiclecode3
	        )
	        values (
            ".$this->invl($this->transactionnumber,true)."
            ,".$this->invl($this->seasoncode,true)."
            ,".$this->invl($this->servicetrhrcategorycode,true)."
            ,".$this->invl($this->vehiclecode1,true,true)."
            ,".$this->invl($this->vehiclecode2,true,true)."
            ,".$this->invl($this->vehiclecode3,true,true)."
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='';
		    if ($this->vehiclecode1!='' and $this->vehiclecode1!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.vehiclecode1 = ".$this->vehiclecode1;
			       }
			       else
			       {
				         $cond=$cond." and t.vehiclecode1 = ".$this->vehiclecode1;
			       }
		    }
		    if ($this->vehiclecode2!='' and $this->vehiclecode2!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.vehiclecode2 = ".$this->vehiclecode2;
			       }
			       else
			       {
				         $cond=$cond." and t.vehiclecode2 = ".$this->vehiclecode2;
			       }
		    }
		    if ($this->vehiclecode3!='' and $this->vehiclecode3!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.vehiclecode3 = ".$this->vehiclecode3;
			       }
			       else
			       {
				         $cond=$cond." and t.vehiclecode3 = ".$this->vehiclecode3;
			       }
		    }
        if ($cond!='')
		    {
		        $query = "select t.* from transporterguarantor t where ".$cond." order by transactionnumber";
			      $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
			      return $result;
		     }
		     else
		     {
		         $query = "select t.* from transporterguarantor t order by transactionnumber";
			       $result = oci_parse($this->connection, $query);
             $r = oci_execute($result);
			       return $result;
		     }
	  }
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $query = "
        update transporterguarantor set 
        seasoncode = ".$this->invl($this->seasoncode,true)."
        ,servicetrhrcategorycode = ".$this->invl($this->servicetrhrcategorycode,true)."
        ,vehiclecode1 = ".$this->invl($this->vehiclecode1,true)."
        ,vehiclecode2 = ".$this->invl($this->vehiclecode2,true)."
        ,vehiclecode3 = ".$this->invl($this->vehiclecode3,true)."
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        /*if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }*/
        $query = "
        delete from transporterguarantor
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
             return 1;
             exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        transactionnumber
        ,seasoncode
        ,servicetrhrcategorycode
        ,vehiclecode1
        ,vehiclecode2
        ,vehiclecode3
        from transporterguarantor where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->transactionnumber = $row['TRANSACTIONNUMBER'];
                $this->seasoncode = $row['SEASONCODE'];
                $this->servicetrhrcategorycode = $row['SERVICETRHRCATEGORYCODE'];
                $this->vehiclecode1 = $row['VEHICLECODE1'];
                $this->vehiclecode2 = $row['VEHICLECODE2'];
                $this->vehiclecode3 = $row['VEHICLECODE3'];
                $vehicle1=new vehicle($this->connection);
                $vehicle1->seasoncode=$this->seasoncode;
                $vehicle1->vehiclecode=$this->vehiclecode1;
                $vehicle1->fetch();
                $vehicle2=new vehicle($this->connection);
                $vehicle2->seasoncode=$this->seasoncode;
                $vehicle2->vehiclecode=$this->vehiclecode2;
                $vehicle2->fetch();
                $vehicle3=new vehicle($this->connection);
                $vehicle3->seasoncode=$this->seasoncode;
                $vehicle3->vehiclecode=$this->vehiclecode3;
                $vehicle3->fetch();
                $this->vehicle1=$vehicle1->vehiclenumber;
                $this->vehicle2=$vehicle2->vehiclenumber;
                $this->vehicle3=$vehicle3->vehiclenumber;
                $this->found=true;
                return true;
        }
        else
        {
        return false;
        }
    }
    public function fetchall($seasoncode,$vehiclecode)
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        p.transactionnumber
        ,p.vehiclecode1
        ,p.vehiclecode2
        ,p.vehiclecode3
        ,v1.vehiclenumber as vehiclenumber1
        ,v2.vehiclenumber as vehiclenumber2
        ,v3.vehiclenumber as vehiclenumber3
        ,s1.subcontractornameeng as subcontractornameeng1,s1.subcontractornameuni as subcontractornameuni1
        ,s2.subcontractornameeng as subcontractornameeng2,s2.subcontractornameuni as subcontractornameuni2
        ,s3.subcontractornameeng as subcontractornameeng3,s3.subcontractornameuni as subcontractornameuni3
        ,s1.subcontractorcode as subcontractorcode1
        ,s2.subcontractorcode as subcontractorcode2
        ,s3.subcontractorcode as subcontractorcode3
        from transporterguarantor p,vehicle v1,vehicle v2,vehicle v3
        ,subcontractor s1,subcontractor s2,subcontractor s3
        where (p.seasoncode=v1.seasoncode 
        and p.vehiclecode1=v1.vehiclecode)
        and (p.seasoncode=v2.seasoncode 
        and p.vehiclecode2=v2.vehiclecode)
        and (p.seasoncode=v3.seasoncode 
        and p.vehiclecode3=v3.vehiclecode)
        and (v1.seasoncode=s1.seasoncode 
        and v1.subcontractorcode=s1.subcontractorcode)
        and (v2.seasoncode=s2.seasoncode 
        and v2.subcontractorcode=s2.subcontractorcode)
        and (v3.seasoncode=s3.seasoncode 
        and v3.subcontractorcode=s3.subcontractorcode)
        and p.seasoncode = ".$this->invl($seasoncode,true)."
        and (p.vehiclecode1 = ".$this->invl($vehiclecode,true)." or
        p.vehiclecode2 = ".$this->invl($vehiclecode,true)." or
        p.vehiclecode3 = ".$this->invl($vehiclecode,true).")";
        $result = oci_parse($this->connection, $query);
        return $result;
    }
}
?>

