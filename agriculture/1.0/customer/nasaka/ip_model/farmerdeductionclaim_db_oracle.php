<?php
//This is generated by Nigade Software Technologies (opc) Private Limited 17/08/2020 06:43:31 pm for PHP
require_once("../swappbase/formbase.php");
require_once("../ip_model/deduction_db_oracle.php");
class farmerdeductionclaim extends swappform
{
    Public $farmerdeductionclaimcode;
    Public $seasonyearcode;
    Public $claimdate;
    Public $farmercode;
    Public $farmercodetextcombo;
    Public $deductioncode;
    Public $deductioncodetextcombo;
    Public $branchcode;
    Public $branchcodetextcombo;
    Public $seasonyearded;
    Public $claimamount;
    Public $creditedamount;
    Public $narration;
    Public $entryuserid;
    Public $entrydatetime;
    Public $imptransnumber;
    Public $contractorcode;
    Public $contractorcodetextcombo;
    Public $subcontractorcode;
    Public $subcontractorcodetextcombo;
    Public $vehiclecode;
    Public $vehiclecodetextcombo;
    Public $payeecategorycode;
    Public $garcontractorcode;
    Public $garcontractorcodetextcombo;

    Public $claimcredit;

    public function __construct(&$connection)
    {
     		 parent::__construct($connection);
         $this->farmerdeductionclaimcode='';
         $this->farmerdeductionclaimcodetextcombo='';
         $this->seasonyearcode='';
         $this->seasonyearcodetextcombo='';
         $this->claimdate='';
         $this->claimdatetextcombo='';
         $this->farmercode='';
         $this->farmercodetextcombo='';
         $this->deductioncode='';
         $this->deductioncodetextcombo='';
         $this->branchcode='';
         $this->branchcodetextcombo='';
         $this->seasonyearded='';
         $this->seasonyeardedtextcombo='';
         $this->claimamount='';
         $this->claimamounttextcombo='';
         $this->creditedamount='';
         $this->creditedamounttextcombo='';
         $this->narration='';
         $this->narrationtextcombo='';
         $this->entryuserid='';
         $this->entryuseridtextcombo='';
         $this->entrydatetime='';
         $this->entrydatetimetextcombo='';
         $this->imptransnumber='';
         $this->imptransnumbertextcombo='';
         $this->contractorcode='';
         $this->contractorcodetextcombo='';
         $this->subcontractorcode='';
         $this->subcontractorcodetextcombo='';
         $this->vehiclecode='';
         $this->vehiclecodetextcombo='';
         $this->payeecategorycode='';
         $this->payeecategorycodetextcombo='';
         $this->garcontractorcode='';
         $this->garcontractorcodetextcombo='';
	   }
    public function entryvalidation()
    {
    	$this->start_validation();
        $this->checkrequired($this->claimdate,'Deduction Claim Date','कपात मागणी दिनांक');
        $this->checkrequired($this->deductioncode,'Deduction Code','कपात कोड');
        $deduction1 = new deduction($this->connection);
        $deduction1->deductioncode=$this->deductioncode;
        $deduction1->fetch();
        if ($deduction1->issubdeduction==1)
        $this->checkrequired($this->branchcode,'Branch','शाखा');
        elseif ($this->branchcode!='')
        {
            if ($_SESSION['lng']=="English")
            {
                $this->invalidid=-200;
                $this->invalidmessagetext='Branch is not required';
            }
            else
            {
                $this->invalidid=-200;
                $this->invalidmessagetext='शाखा भरण्याची गरज नाही';
            }
        }
        if ($deduction1->issubseasonyear==1)
        $this->checkrequired($this->seasonyearded,'Sub Season Year','सब हंगाम वर्ष');
        elseif ($this->seasonyearded!='')
        {
            if ($_SESSION['lng']=="English")
            {
                $this->invalidid=-200;
                $this->invalidmessagetext='Season Year is not required';
            }
            else
            {
                $this->invalidid=-200;
                $this->invalidmessagetext='कपात हंगाम वर्ष भरण्याची गरज नाही';
            }
        }
        if ($this->payeecategorycode==1)
        {
            $this->checkrequired($this->farmercode,'Farmer Code','शेतकरी कोड');
            if ($this->claimcredit==1)
            $this->checkrequired($this->claimamount,'Claim Amount','मागणी रक्कम');
            elseif ($this->claimcredit==2)
            $this->checkrequired($this->creditedamount,'Credited Amount','जमा रक्कम');
        }
        elseif ($this->payeecategorycode==2)
        {
            $this->checkrequired($this->contractorcode,'HT Contractor','तोडणी वहातूक कंत्राटदार');
            if ($this->deductioncode==2011 and $this->garcontractorcode=='')
            {
                $this->checkrequired($this->garcontractorcode,'HT Contractor','तोडणी वहातूक कंत्राटदार जामीनदार');
            }
            if ($this->deductioncode!=2011 and $this->deductioncode!=2019 and $this->deductioncode!=3024)
            {
                $this->checkrequired($this->subcontractorcode,'HT Sub Contractor','तोडणी वहातूक सबकंत्राटदार');
            }
        }
        $this->end_validation();
        return $this->invalidid;
	}
    private function datavalidation()
    {
        $this->start_validation();
    		$this->invalidid=0;
    		$this->invalidmessagetext='Validated';
    		$this->end_validation();
    		return $this->invalidid;
    }
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
	    if ($this->farmerdeductionclaimcode == '')
        {
            $query = "select nvl(max(farmerdeductionclaimcode),0)+1 as farmerdeductionclaimcode from farmerdeductionclaim";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->farmerdeductionclaimcode = $row["FARMERDEDUCTIONCLAIMCODE"];
        }
        if ($this->claimdate!='')
        {
            $this->claimdate = DateTime::createFromFormat('d/m/Y',$this->claimdate)->format('d-M-Y');
        }
        $query = "
            insert into farmerdeductionclaim(
            farmerdeductionclaimcode
            ,seasonyearcode
            ,claimdate
            ,farmercode
            ,deductioncode
            ,branchcode
            ,seasonyearded
            ,claimamount
            ,creditedamount
            ,narration
            ,entryuserid
            ,entrydatetime
            ,imptransnumber
            ,contractorcode
            ,subcontractorcode
            ,vehiclecode
            ,payeecategorycode
            ,garcontractorcode
	        )
	        values (
            ".$this->invl($this->farmerdeductionclaimcode,true)."
            ,".$this->invl($this->seasonyearcode,true)."
            ,".$this->invl($this->claimdate,false)."
            ,".$this->invl($this->farmercode,true,true)."
            ,".$this->invl($this->deductioncode,true,true)."
            ,".$this->invl($this->branchcode,true,true)."
            ,".$this->invl($this->seasonyearded,true)."
            ,".$this->invl($this->claimamount,true)."
            ,".$this->invl($this->creditedamount,true)."
            ,".$this->invl($this->narration,false)."
            ,".$_SESSION['usersid']."
            ,".$this->invl($this->entrydatetime,false)."
            ,".$this->invl($this->imptransnumber,true)."
            ,".$this->invl($this->contractorcode,true,true)."
            ,".$this->invl($this->subcontractorcode,true,true)."
            ,".$this->invl($this->vehiclecode,true,true)."
            ,".$this->invl($this->payeecategorycode,true)."
            ,".$this->invl($this->garcontractorcode,true,true)."
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
            $this->dataoperationmode = operationmode::Select;
            if ($this->claimcredit==1)
            $cond='nvl(claimamount,0)>0';
            elseif ($this->claimcredit==2)
            $cond='nvl(creditedamount,0)>0';

		    if ($this->claimdate!='')
		    {
			      $this->claimdate = DateTime::createFromFormat('d/m/Y',$this->claimdate)->format('d-M-Y');
			      if ($cond=='')
			      {
				        $cond="t.claimdate = '".$this->claimdate."'";
			       }
			       else
			       {
				         $cond=$cond." and t.claimdate = '".$this->claimdate."'";
			       }
		    }
		    if ($this->farmercode!='' and $this->farmercode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.farmercode = ".$this->farmercode;
			       }
			       else
			       {
				         $cond=$cond." and t.farmercode = ".$this->farmercode;
			       }
		    }
		    if ($this->deductioncode!='' and $this->deductioncode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.deductioncode = ".$this->deductioncode;
			       }
			       else
			       {
				         $cond=$cond." and t.deductioncode = ".$this->deductioncode;
			       }
		    }
		    if ($this->branchcode!='' and $this->branchcode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.branchcode = ".$this->branchcode;
			       }
			       else
			       {
				         $cond=$cond." and t.branchcode = ".$this->branchcode;
			       }
		    }
		    if ($this->seasonyearded!='' and $this->seasonyearded!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.seasonyearded = ".$this->seasonyearded;
			       }
			       else
			       {
				         $cond=$cond." and t.seasonyearded = ".$this->seasonyearded;
			       }
		    }
		    if ($this->claimamount!='' and $this->claimamount!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.claimamount = ".$this->claimamount;
			       }
			       else
			       {
				         $cond=$cond." and t.claimamount = ".$this->claimamount;
			       }
            }
            if ($this->vehiclecode!='' and $this->vehiclecode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="v.vehiclecode = ".$this->vehiclecode;
			       }
			       else
			       {
				         $cond=$cond." and v.vehiclecode = ".$this->vehiclecode;
			       }
            }
            if ($this->subcontractorcode!='' and $this->subcontractorcode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="s.subcontractorcode = ".$this->subcontractorcode;
			       }
			       else
			       {
				         $cond=$cond." and s.subcontractorcode = ".$this->subcontractorcode;
			       }
            }
            if ($this->contractorcode!='' and $this->contractorcode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="c.contractorcode = ".$this->contractorcode;
			       }
			       else
			       {
				         $cond=$cond." and c.contractorcode = ".$this->contractorcode;
			       }
            }
        if ($cond!='')
		    {
                if ($this->payeecategorycode==1)
                {
                    $query = "select t.*
                    ,f.farmernameuni,farmernameeng
                    ,d.deductionnameuni,d.deductionnameuni
                    ,b.bankbranchnameuni,k.banknameuni
                    from farmerdeductionclaim t,farmer f,deduction d,bankbranch b,bank k
                    where t.farmercode=f.farmercode
                    and t.deductioncode=d.deductioncode
                    and t.branchcode=b.bankbranchcode(+)
                    and b.bankcode=k.bankcode(+)
                    and t.seasonyearcode=".$_SESSION['yearperiodcode']."
                    and t.payeecategorycode=".$this->payeecategorycode."
                    and ".$cond." 
                    order by f.farmercode,claimdate desc";
                }
                elseif ($this->payeecategorycode==2)
                {
                    $query = "select t.*
                    ,d.deductionnameuni,d.deductionnameuni
                    ,c.contractorcode,c.contractornameeng,c.contractornameuni
                    ,s.subcontractornameeng,s.subcontractornameuni
                    ,v.vehiclecode,v.vehiclenumber
                    ,j.contractorcode garcontractorcode,j.contractornameeng garcontractornameeng,j.contractornameuni garcontractornameuni
                    ,st.servicetrhrcatnameuni,st.servicetrhrcatnameeng
                    from farmerdeductionclaim t,deduction d
                    ,contractor c,subcontractor s,vehicle v,contractor j,contractorcontract cc,servicetrhrcategory st
                    where t.deductioncode=d.deductioncode
                    and t.contractorcode=c.contractorcode
                    and cc.seasoncode=s.seasoncode
                    and cc.contractcode=s.contractcode
                    and cc.servicetrhrcategorycode=st.servicetrhrcategorycode
                    and t.seasonyearcode=s.seasoncode(+)
                    and t.subcontractorcode=s.subcontractorcode(+)
                    and t.seasonyearcode=v.seasoncode(+)
                    and t.subcontractorcode=v.subcontractorcode(+)
                    and t.vehiclecode=v.vehiclecode(+)
                    and t.garcontractorcode=j.contractorcode(+)
                    and t.seasonyearcode=".$_SESSION['yearperiodcode']."
                    and t.payeecategorycode=".$this->payeecategorycode."
                    and ".$cond." 
                    order by t.contractorcode,t.subcontractorcode,claimdate desc";
                }
			    $result = oci_parse($this->connection, $query);
                $r = oci_execute($result);
			    return $result;
		    }
		    else
		    {
                if ($this->payeecategorycode==1)
                {
                    $query = "select t.*
                    ,f.farmernameuni,farmernameeng
                    ,d.deductionnameuni,d.deductionnameuni
                    ,b.bankbranchnameuni,k.banknameuni
                    from farmerdeductionclaim t,farmer f,deduction d,bankbranch b,bank k
                    where t.farmercode=f.farmercode
                    and t.deductioncode=d.deductioncode
                    and t.branchcode=b.bankbranchcode(+)
                    and b.bankcode=k.bankcode(+)
                    and t.seasonyearcode=".$_SESSION['yearperiodcode']."
                    and t.payeecategorycode=".$this->payeecategorycode."
                    and ".$cond." 
                    order by f.farmercode,claimdate desc";
                }
                elseif ($this->payeecategorycode==2)
                {
                    $query = "select t.*
                    ,f.farmernameuni,farmernameeng
                    ,d.deductionnameuni,d.deductionnameuni
                    ,c.contractorcode,c.contractornameeng,c.contractornameuni
                    ,s.subcontractornameeng,s.subcontractornameuni
                    ,v.vehiclecode,v.vehiclenumber 
                    ,j.contractorcode garcontractorcode,j.contractornameeng garcontractornameeng,j.contractornameuni garcontractornameuni
                    from farmerdeductionclaim t,deduction d
                    ,contractor c,subcontractorcode s,vehicle v,contractor j
                    where t.deductioncode=d.deductioncode
                    and t.contractorcode=c.contractorcode
                    and t.seasoncode=s.seasoncode
                    and t.subcontractorcode=s.subcontractorcode
                    and s.seasoncode=v.seasoncode(+)
                    and s.subcontractorcode=v.subcontractorcode(+)
                    and t.vehiclecode=v.vehiclecode(+)
                    and t.garcontractorcode=j.contractorcode(+)
                    and t.seasoncode=".$_SESSION['yearperiodcode']."
                    and t.payeecategorycode=".$this->payeecategorycode."
                    and ".$cond." 
                    order by t.contractorcode,t.subcontractorcode,claimdate desc";
                }
			    $result = oci_parse($this->connection, $query);
                $r = oci_execute($result);
			    return $result;
		    }
	  }
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->claimdate = DateTime::createFromFormat('d/m/Y',$this->claimdate)->format('d-M-Y');
        $query = "
        update farmerdeductionclaim set 
        seasonyearcode = ".$this->invl($this->seasonyearcode,true,true)."
        ,claimdate =".$this->invl($this->claimdate,false)."
        ,farmercode = ".$this->invl($this->farmercode,true,true)."
        ,deductioncode = ".$this->invl($this->deductioncode,true,true)."
        ,branchcode = ".$this->invl($this->branchcode,true,true)."
        ,seasonyearded = ".$this->invl($this->seasonyearded,true,true)."
        ,claimamount = ".$this->invl($this->claimamount,true,true)."
        ,creditedamount = ".$this->invl($this->creditedamount,true,true)."
        ,narration =".$this->invl($this->narration,false)."
        ,imptransnumber = ".$this->invl($this->imptransnumber,true,true)."
        ,contractorcode = ".$this->invl($this->contractorcode,true,true)."
        ,subcontractorcode = ".$this->invl($this->subcontractorcode,true,true)."
        ,vehiclecode = ".$this->invl($this->vehiclecode,true,true)."
        ,payeecategorycode = ".$this->invl($this->payeecategorycode,true,true)."
        ,garcontractorcode = ".$this->invl($this->garcontractorcode,true,true)."
        where 
        farmerdeductionclaimcode = ".$this->invl($this->farmerdeductionclaimcode,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $query = "
        delete from farmerdeductionclaim
        where 
        farmerdeductionclaimcode = ".$this->invl($this->farmerdeductionclaimcode,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
             return 1;
             exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        farmerdeductionclaimcode
        ,claimdate
        ,farmercode
        ,deductioncode
        ,branchcode
        ,claimamount
        ,seasonyearcode
        ,creditedamount
        ,narration
        ,entryuserid
        ,entrydatetime
        ,imptransnumber
        ,seasonyearded
        ,contractorcode
        ,subcontractorcode
        ,vehiclecode
        ,payeecategorycode
        ,garcontractorcode
        from farmerdeductionclaim where 
        farmerdeductionclaimcode = ".$this->invl($this->farmerdeductionclaimcode,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->farmerdeductionclaimcode = $row['FARMERDEDUCTIONCLAIMCODE'];
                $this->claimdate = DateTime::createFromFormat('d-M-y',$row['CLAIMDATE'])->format('d/m/Y');
                $this->farmercode = $row['FARMERCODE'];
                $this->deductioncode = $row['DEDUCTIONCODE'];
                $this->branchcode = $row['BRANCHCODE'];
                $this->claimamount = $row['CLAIMAMOUNT'];
                $this->seasonyearcode = $row['SEASONYEARCODE'];
                $this->creditedamount = $row['CREDITEDAMOUNT'];
                $this->narration = $row['NARRATION'];
                $this->entryuserid = $row['ENTRYUSERID'];
                if ($row['ENTRYDATETIME']!='')
                $this->entrydatetime = DateTime::createFromFormat('d-M-y',$row['ENTRYDATETIME'])->format('d/m/Y');
                $this->imptransnumber = $row['IMPTRANSNUMBER'];
                $this->seasonyearded = $row['SEASONYEARDED'];
                $this->branchcodetextcombo = $this->textcomboname($this->connection,$table='BANKBRANCH',$datafield='BANKBRANCHCODE',$datafieldvalue=$row['BRANCHCODE'],$engfield='BANKBRANCHNAMEENG',$unicodefield='BANKBRANCHNAMEUNI');
                $this->deductioncodetextcombo = $this->textcomboname($this->connection,$table='DEDUCTION',$datafield='DEDUCTIONCODE',$datafieldvalue=$row['DEDUCTIONCODE'],$engfield='DEDUCTIONNAMEENG',$unicodefield='DEDUCTIONNAMEUNI');
                $this->farmercodetextcombo = $this->textcomboname($this->connection,$table='FARMER',$datafield='FARMERCODE',$datafieldvalue=$row['FARMERCODE'],$engfield='FARMERNAMEENG',$unicodefield='FARMERNAMEUNI');
                $this->contractorcode = $row['CONTRACTORCODE'];
                $this->subcontractorcode = $row['SUBCONTRACTORCODE'];
                $this->vehiclecode = $row['VEHICLECODE'];
                $this->payeecategorycode = $row['PAYEECATEGORYCODE'];
                $this->garcontractorcode = $row['GARCONTRACTORCODE'];
                $this->contractorcodetextcombo = $this->textcomboname($this->connection,$table='CONTRACTOR',$datafield='CONTRACTORCODE',$datafieldvalue=$row['CONTRACTORCODE'],$engfield='CONTRACTORNAMEENG',$unicodefield='CONTRACTORNAMEUNI');
                $this->garcontractorcodetextcombo = $this->textcomboname($this->connection,$table='CONTRACTOR',$datafield='CONTRACTORCODE',$datafieldvalue=$row['GARCONTRACTORCODE'],$engfield='CONTRACTORNAMEENG',$unicodefield='CONTRACTORNAMEUNI');
                $this->subcontractorcodetextcombo = $this->textcomboname($this->connection,$table='SUBCONTRACTOR',$datafield='SUBCONTRACTORCODE',$datafieldvalue=$row['SUBCONTRACTORCODE'],$engfield='SUBCONTRACTORNAMEENG',$unicodefield='SUBCONTRACTORNAMEUNI',$cond='SEASONCODE='.$_SESSION['yearperiodcode']);
                $this->vehiclecodetextcombo = $this->textcomboname($this->connection,$table='VEHICLE',$datafield='VEHICLECODE',$datafieldvalue=$row['VEHICLECODE'],$engfield='VEHICLENUMBER',$unicodefield='VEHICLENUMBER',$cond='SEASONCODE='.$_SESSION['yearperiodcode']);
                $this->found=true;
                return true;
        }
        else
        {
        return false;
        }
    }
}
?>

