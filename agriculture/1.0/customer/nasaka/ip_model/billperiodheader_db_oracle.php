<?php
//This is generated by Nigade Software Technologies (opc) Private Limited 22/08/2020 11:13:51 am for PHP
require_once("../swappbase/formbase.php");
class billperiodheader extends swappform
{
    Public $billperiodtransnumber;
    Public $seasonyear;
    Public $billcategorycode;
    Public $billperiodnumber;
    Public $fromdate;
    Public $todate;
    Public $paymentdate;
    Public $islocked;
    Public $payeecategorycode;
    Public $servicetrhrcategorycode;
    Public $contractorcategorycode;
    Public $contractcategorycode;
    Public $billdate;
    Public $commissionpercent;
    public function __construct(&$connection)
    {
     	 parent::__construct($connection);
         $this->billperiodtransnumber='';
         $this->billperiodtransnumbertextcombo='';
         $this->seasonyear='';
         $this->seasonyeartextcombo='';
         $this->billcategorycode='';
         $this->billcategorycodetextcombo='';
         $this->billperiodnumber='';
         $this->billperiodnumbertextcombo='';
         $this->fromdate='';
         $this->fromdatetextcombo='';
         $this->todate='';
         $this->todatetextcombo='';
         $this->paymentdate='';
         $this->paymentdatetextcombo='';
         $this->islocked='';
         $this->islockedtextcombo='';
         $this->payeecategorycode='';
         $this->payeecategorycodetextcombo='';
	}
    public function entryvalidation()
    {
    		$this->start_validation();
        $this->checkrequired($this->billcategorycode,'Bill Category','बिल प्रकार');
        //$this->checkrequired($this->billperiodnumber,'Bill Period Number','बिल कालावधी क्रमांक');
        $this->checkrequired($this->fromdate,'From Date','दिनांक पासून');
        $this->checkrequired($this->todate,'To Date','दिनांक पर्यंत');
        $this->checkrequired($this->paymentdate,'Payment Date','अदा दिनांक');
        $this->checkrequired($this->islocked,'Is Locked','लॉक आहे का?');
        $this->checkrequired($this->payeecategorycode,'Payee Category','पेयी प्रकार');
        if ($this->payeecategorycode==2 and $this->dataoperationmode == operationmode::Insert)
        {
            $this->checkrequired($this->billperiodnumber,'Bill Period Number','बिल कालावधी क्रमांक');
            if (($this->billcategorycode == 4 or $this->billcategorycode == 5) and ($this->commissionpercent == ''))
            {
                $this->checkrequired($this->commissionpercent,'Commission Percent','कमिशन टक्के');
            }
        }
        $this->end_validation();
        return $this->invalidid;
	  }
    private function datavalidation()
    {
        $this->start_validation();
        if ($this->payeecategorycode==1 and $this->billperiodnumber!='' and $this->dataoperationmode == operationmode::Insert)
        {
            $query = "select count(*) as cnt 
            from billperiodheader
            where payeecategorycode=".$this->payeecategorycode."
            and seasonyear=".$this->seasonyear."
            and billcategorycode=".$this->billcategorycode."
            and billperiodnumber=".$this->billperiodnumber;
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
            {
                if ($row['CNT']>0)
                {
                    $this->invalidid=-200;
                    $this->invalidmessagetext='Bill Period is already Exists';
                    exit;
                }
            }
        }
        
        $this->invalidid=0;
        $this->invalidmessagetext='Validated';
        $this->end_validation();
        return $this->invalidid;
    }
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
	    if ($this->billperiodtransnumber == '')
        {
            $query = "select nvl(max(billperiodtransnumber),0)+1 as billperiodtransnumber from billperiodheader";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->billperiodtransnumber = $row["BILLPERIODTRANSNUMBER"];
        }
        if ($this->payeecategorycode==1 and $this->billperiodnumber == '')
        {
            $query = "select nvl(max(billperiodnumber),0)+1 as billperiodnumber 
            from billperiodheader
            where payeecategorycode=".$this->payeecategorycode."
            and seasonyear=".$this->seasonyear."
            and billcategorycode=".$this->billcategorycode;
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->billperiodnumber = $row["BILLPERIODNUMBER"];
        }
        if ($this->fromdate!='')
        {
            $this->fromdate = DateTime::createFromFormat('d/m/Y',$this->fromdate)->format('d-M-Y');
        }
        if ($this->todate!='')
        {
            $this->todate = DateTime::createFromFormat('d/m/Y',$this->todate)->format('d-M-Y');
        }
        if ($this->paymentdate!='')
        {
            $this->paymentdate = DateTime::createFromFormat('d/m/Y',$this->paymentdate)->format('d-M-Y');
        }
        if ($this->billdate!='')
        $this->billdate = DateTime::createFromFormat('d/m/Y',$this->billdate)->format('d-M-Y');
        $query = "
            insert into billperiodheader(
            billperiodtransnumber
            ,seasonyear
            ,billcategorycode
            ,billperiodnumber
            ,fromdate
            ,todate
            ,paymentdate
            ,islocked
            ,payeecategorycode
            ,servicetrhrcategorycode
            ,contractorcategorycode
            ,contractcategorycode
            ,billdate
            ,commissionpercent
	        )
	        values (
            ".$this->invl($this->billperiodtransnumber,true)."
            ,".$this->invl($this->seasonyear,true)."
            ,".$this->invl($this->billcategorycode,true,true)."
            ,".$this->invl($this->billperiodnumber,true)."
            ,".$this->invl($this->fromdate,false)."
            ,".$this->invl($this->todate,false)."
            ,".$this->invl($this->paymentdate,false)."
            ,".$this->invl($this->islocked,true,true)."
            ,".$this->invl($this->payeecategorycode,true)."
            ,".$this->invl($this->servicetrhrcategorycode,true,true)."
            ,".$this->invl($this->contractorcategorycode,true,true)."
            ,".$this->invl($this->contractcategorycode,true,true)."
            ,".$this->invl($this->billdate,false)."
            ,".$this->invl($this->commissionpercent,true,true)."
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='';
		    if ($this->billcategorycode!='' and $this->billcategorycode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.billcategorycode = ".$this->billcategorycode;
			       }
			       else
			       {
				         $cond=$cond." and t.billcategorycode = ".$this->billcategorycode;
			       }
		    }
		    if ($this->billperiodnumber!='' and $this->billperiodnumber!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.billperiodnumber = ".$this->billperiodnumber;
			       }
			       else
			       {
				         $cond=$cond." and t.billperiodnumber = ".$this->billperiodnumber;
			       }
		    }
		    if ($this->fromdate!='')
		    {
			      $this->fromdate = DateTime::createFromFormat('d/m/Y',$this->fromdate)->format('d-M-Y');
			      if ($cond=='')
			      {
				        $cond="t.fromdate = '".$this->fromdate."'";
			       }
			       else
			       {
				         $cond=$cond." and t.fromdate = '".$this->fromdate."'";
			       }
		    }
		    if ($this->todate!='')
		    {
			      $this->todate = DateTime::createFromFormat('d/m/Y',$this->todate)->format('d-M-Y');
			      if ($cond=='')
			      {
				        $cond="t.todate = '".$this->todate."'";
			       }
			       else
			       {
				         $cond=$cond." and t.todate = '".$this->todate."'";
			       }
		    }
		    if ($this->paymentdate!='')
		    {
			      $this->paymentdate = DateTime::createFromFormat('d/m/Y',$this->paymentdate)->format('d-M-Y');
			      if ($cond=='')
			      {
				        $cond="t.paymentdate = '".$this->paymentdate."'";
			       }
			       else
			       {
				         $cond=$cond." and t.paymentdate = '".$this->paymentdate."'";
			       }
		    }
		    if ($this->islocked!='' and $this->islocked!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.islocked = ".$this->islocked;
			       }
			       else
			       {
				         $cond=$cond." and t.islocked = ".$this->islocked;
			       }
            }
            if ($this->seasonyear!='' and $this->seasonyear!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.seasonyear = ".$this->seasonyear;
			       }
			       else
			       {
				         $cond=$cond." and t.seasonyear = ".$this->seasonyear;
			       }
            }
            if ($this->payeecategorycode!='' and $this->payeecategorycode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.payeecategorycode = ".$this->payeecategorycode;
			       }
			       else
			       {
				         $cond=$cond." and t.payeecategorycode = ".$this->payeecategorycode;
			       }
            }
            if ($this->servicetrhrcategorycode!='' and $this->servicetrhrcategorycode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.servicetrhrcategorycode = ".$this->servicetrhrcategorycode;
			       }
			       else
			       {
				         $cond=$cond." and t.servicetrhrcategorycode = ".$this->servicetrhrcategorycode;
			       }
            }
            if ($this->contractorcategorycode!='' and $this->contractorcategorycode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.contractorcategorycode = ".$this->contractorcategorycode;
			       }
			       else
			       {
				         $cond=$cond." and t.contractorcategorycode = ".$this->contractorcategorycode;
			       }
            }
            if ($this->contractcategorycode!='' and $this->contractcategorycode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.contractcategorycode = ".$this->contractcategorycode;
			       }
			       else
			       {
				         $cond=$cond." and t.contractcategorycode = ".$this->contractcategorycode;
			       }
		    }
            if ($cond!='')
		    {
                $query = "select t.*,b.billtypenameeng,b.billtypenameuni,s.servicetrhrcatnameuni from billperiodheader t,billtype b,servicetrhrcategory s 
                where t.billcategorycode=b.billtypecode and t.servicetrhrcategorycode=s.servicetrhrcategorycode(+) and ".$cond." order by billperiodtransnumber";
			    $result = oci_parse($this->connection, $query);
                $r = oci_execute($result);
			    return $result;
		    }
		    else
		    {
                $query = "select t.*,b.billtypenameeng,b.billtypenameuni,s.servicetrhrcatnameuni 
                from billperiodheader t,billtype b,servicetrhrcategory s 
                where t.billcategorycode=b.billtypecode 
                and t.servicetrhrcategorycode=s.servicetrhrcategorycode(+)
                order by billperiodtransnumber";
			    $result = oci_parse($this->connection, $query);
                $r = oci_execute($result);
			    return $result;
		    }
	}
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->fromdate = DateTime::createFromFormat('d/m/Y',$this->fromdate)->format('d-M-Y');
        $this->todate = DateTime::createFromFormat('d/m/Y',$this->todate)->format('d-M-Y');
        $this->paymentdate = DateTime::createFromFormat('d/m/Y',$this->paymentdate)->format('d-M-Y');
        if ($this->billdate!='')
        $this->billdate = DateTime::createFromFormat('d/m/Y',$this->billdate)->format('d-M-Y');
        $query = "
        update billperiodheader set 
        seasonyear = ".$this->invl($this->seasonyear,true,true)."
        ,billcategorycode = ".$this->invl($this->billcategorycode,true,true)."
        ,billperiodnumber = ".$this->invl($this->billperiodnumber,true,true)."
        ,fromdate =".$this->invl($this->fromdate,false)."
        ,todate =".$this->invl($this->todate,false)."
        ,paymentdate =".$this->invl($this->paymentdate,false)."
        ,islocked = ".$this->invl($this->islocked,true,true)."
        ,payeecategorycode = ".$this->invl($this->payeecategorycode,true,true)."
        ,servicetrhrcategorycode = ".$this->invl($this->servicetrhrcategorycode,true,true)."
        ,contractorcategorycode = ".$this->invl($this->contractorcategorycode,true,true)."
        ,contractcategorycode = ".$this->invl($this->contractcategorycode,true,true)."
        ,billdate =".$this->invl($this->billdate,false)."
        ,commissionpercent = ".$this->invl($this->commissionpercent,true,true)."
        where 
        billperiodtransnumber = ".$this->invl($this->billperiodtransnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            if ($this->invl($this->islocked,true,true)==1)
            {    
                $query1 = "update farmer f
                set f.verified=1 
                where f.verified is null and f.bankbranchcode<>45 and f.farmercode in (
                select t.farmercode 
                from farmerbillheader t,billperiodheader h
                where t.billperiodtransnumber=h.billperiodtransnumber
                and h.billperiodtransnumber=".$this->invl($this->billperiodtransnumber,false)."
                group by t.farmercode)";
                $result = oci_parse($this->connection, $query1);
                if (oci_execute($result,OCI_NO_AUTO_COMMIT))
                {
                    return 1;
                    exit;
                }
                else
                {
                    return 0;
                    exit;
                }
            }
            else
            {
                return 1;
                exit;
            }
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->fromdate = DateTime::createFromFormat('d/m/Y',$this->fromdate)->format('d-M-Y');
        $this->todate = DateTime::createFromFormat('d/m/Y',$this->todate)->format('d-M-Y');
        $this->paymentdate = DateTime::createFromFormat('d/m/Y',$this->paymentdate)->format('d-M-Y');
        $query = "
        delete from billperiodheader
        where 
        billperiodtransnumber = ".$this->invl($this->billperiodtransnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
             return 1;
             exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        billperiodtransnumber
        ,seasonyear
        ,billcategorycode
        ,billperiodnumber
        ,fromdate
        ,todate
        ,paymentdate
        ,islocked
        ,payeecategorycode
        ,servicetrhrcategorycode
        ,contractorcategorycode
        ,contractcategorycode
        ,billdate 
        ,commissionpercent
        from billperiodheader where 
        billperiodtransnumber = ".$this->invl($this->billperiodtransnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->billperiodtransnumber = $row['BILLPERIODTRANSNUMBER'];
                $this->seasonyear = $row['SEASONYEAR'];
                $this->billcategorycode = $row['BILLCATEGORYCODE'];
                $this->billperiodnumber = $row['BILLPERIODNUMBER'];
                $this->fromdate = DateTime::createFromFormat('d-M-y',$row['FROMDATE'])->format('d/m/Y');
                $this->todate = DateTime::createFromFormat('d-M-y',$row['TODATE'])->format('d/m/Y');
                $this->paymentdate = DateTime::createFromFormat('d-M-y',$row['PAYMENTDATE'])->format('d/m/Y');
                $this->islocked = $row['ISLOCKED'];
                $this->payeecategorycode = $row['PAYEECATEGORYCODE'];
                $this->servicetrhrcategorycode = $row['SERVICETRHRCATEGORYCODE'];
                $this->contractorcategorycode = $row['CONTRACTORCATEGORYCODE'];
                $this->contractcategorycode = $row['CONTRACTCATEGORYCODE'];
                $this->commissionpercent = $row['COMMISSIONPERCENT'];
                if ($row['BILLDATE']!='')
                {
                    $this->billdate = DateTime::createFromFormat('d-M-y',$row['BILLDATE'])->format('d/m/Y');
                }
                $this->found=true;
                return true;
        }
        else
        {
        return false;
        }
    }

    public function farmerbillperioddatagen()
    {
        $sql = 'BEGIN FARMERBILLPERIODDATAGEN(:P_BILLPERIODTRANSNUMBER,:P_PAYEECATEGORYCODE,:P_RET); END;';
        $result = oci_parse($this->connection,$sql);
        oci_bind_by_name($result,':P_BILLPERIODTRANSNUMBER',$this->billperiodtransnumber,20,SQLT_INT);
        oci_bind_by_name($result,':P_PAYEECATEGORYCODE',$this->payeecategorycode,20,SQLT_INT);
        oci_bind_by_name($result,':P_RET',$p_ret,10,SQLT_INT);
        $p_rt=oci_execute($result);
        if ($p_rt==1)
        {
            return 1;
        }
        else
        {
           return 0;
        }
    }
    public function htbillperioddatagen()
    {
        $sql = 'BEGIN HTBILLPERIODDATAGEN(:P_BILLPERIODTRANSNUMBER,:P_SERVICETRHRCATEGORYCODE,:P_CONTRACTORCATEGORYCODE,:P_PAYEECATEGORYCODE,:P_RET); END;';
        $result = oci_parse($this->connection,$sql);
        oci_bind_by_name($result,':P_BILLPERIODTRANSNUMBER',$this->billperiodtransnumber,20,SQLT_INT);
        oci_bind_by_name($result,':P_SERVICETRHRCATEGORYCODE',$this->servicetrhrcategorycode,20,SQLT_INT);
        oci_bind_by_name($result,':P_CONTRACTORCATEGORYCODE',$this->contractorcategorycode,20,SQLT_INT);
        oci_bind_by_name($result,':P_PAYEECATEGORYCODE',$this->payeecategorycode,20,SQLT_INT);
        oci_bind_by_name($result,':P_RET',$p_ret,10,SQLT_INT);
        $p_rt=oci_execute($result);
        if ($p_rt==1)
        {
            return 1;
        }
        else
        {
           return 0;
        }
    }
}
?>