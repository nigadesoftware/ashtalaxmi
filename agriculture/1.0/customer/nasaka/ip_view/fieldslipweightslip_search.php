<?php
    //This is generated by Swapp Software Application on 07/05/2019 05:06:02 PM for PHP
    require_once("../info/phpsqlajax_dbinfo.php");
    require_once("../info/phpgetloginview.php");
    require_once("../info/routine.php");
    require_once("../ip_model/caneyardtoken_db_oracle.php");
    require_once("../ip_model/farmer_db_oracle.php");
    $connection =swapp_connection();
    $searchTerm = $_GET['term'];
    $vehiclecategorycode = $_GET['vehiclecategorycode'];
    if (isset($_GET['weightcategorycode']))
    {
        $weightcategorycode = $_GET['weightcategorycode'];
    }
    else
    {
        $weightcategorycode =0;
    }
    if (isset($_GET['flag']))
    {
        $flag = $_GET['flag'];
    }
    else
    {
        $flag ='';
    }
    $seasoncode = $_SESSION['yearperiodcode'];
    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    elseif (strlen($searchTerm)<1 and $searchTerm != '**')
    {
        exit;
    }
    if ($flag!='Query')
    {
        if ($weightcategorycode==1 or $weightcategorycode==3)
        {
            if ($vehiclecategorycode == 1 or $vehiclecategorycode == 2 or $vehiclecategorycode == 4)
            {
                    if ($searchTerm == '**')
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,f.vehiclecode,v.vehiclenumber,null as tyregadicode,null as tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                            from
                            (select t.seasoncode,t.fieldslipnumber from fieldslip t
                            minus
                            select w.seasoncode,w.fieldslipnumber from weightslip w
                            where nvl(w.loadweight,0)>0 
                            )t,fieldslip f,vehicle v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.vehiclecode=v.vehiclecode
                            and v.vehiclecategorycode=".$vehiclecategorycode."
                            and t.seasoncode=".$seasoncode;
                    }
                    else
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,f.vehiclecode,v.vehiclenumber,null as tyregadicode,null as tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                            from
                            (select t.seasoncode,t.fieldslipnumber from fieldslip t
                            minus
                            select w.seasoncode,w.fieldslipnumber from weightslip w
                            where nvl(w.loadweight,0)>0 
                            )t,fieldslip f,vehicle v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.vehiclecode=v.vehiclecode
                            and v.vehiclecategorycode=".$vehiclecategorycode."
                            and t.seasoncode=".$seasoncode." and  f.fieldslipnumber=".$searchTerm;
                    }
            }
            else if ($vehiclecategorycode == 3)
            {
                if ($searchTerm == '**')
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,null as vehiclecode,null as vehiclenumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                            from
                            (select t.seasoncode,t.fieldslipnumber from fieldslip t
                            minus
                            select w.seasoncode,w.fieldslipnumber from weightslip w
                            where nvl(w.loadweight,0)>0 
                            )t,fieldslip f,tyregadi v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.tyregadicode=v.tyregadicode
                            and t.seasoncode=".$seasoncode;
                    }
                    else
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,null as vehiclecode,null as vehiclenumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                            from
                            (select t.seasoncode,t.fieldslipnumber from fieldslip t
                            minus
                            select w.seasoncode,w.fieldslipnumber from weightslip w
                            where nvl(w.loadweight,0)>0 
                            )t,fieldslip f,vehicle v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.tyregadicode=v.tyregadicode
                            and t.seasoncode=".$seasoncode." and  f.fieldslipnumber=".$searchTerm;
                    }
            }
        }
        elseif ($weightcategorycode==2 or $weightcategorycode==3)
        {
            if ($vehiclecategorycode == 1 or $vehiclecategorycode == 2 or $vehiclecategorycode == 4)
            {
                    if ($searchTerm == '**')
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,f.vehiclecode,v.vehiclenumber,null as tyregadicode,null as tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                            from
                            (select w.seasoncode,w.fieldslipnumber from weightslip w
                            where nvl(w.loadweight,0)>0 and nvl(w.emptyweight,0)=0
                            )t,fieldslip f,vehicle v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.vehiclecode=v.vehiclecode
                            and v.vehiclecategorycode=".$vehiclecategorycode."
                            and t.seasoncode=".$seasoncode;
                    }
                    else
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,f.vehiclecode,v.vehiclenumber,null as tyregadicode,null as tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                            from
                            (select w.seasoncode,w.fieldslipnumber from weightslip w
                            where nvl(w.loadweight,0)>0 and nvl(w.emptyweight,0)=0
                            )t,fieldslip f,vehicle v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.vehiclecode=v.vehiclecode
                            and v.vehiclecategorycode=".$vehiclecategorycode."
                            and t.seasoncode=".$seasoncode." and  f.fieldslipnumber=".$searchTerm;
                    }
            }
            else if ($vehiclecategorycode == 3)
            {
                if ($searchTerm == '**')
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,null as vehiclecode,null as vehiclenumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                            from
                            (select w.seasoncode,w.fieldslipnumber from weightslip w
                            where nvl(w.loadweight,0)>0 and nvl(w.emptyweight,0)=0
                            )t,fieldslip f,tyregadi v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.tyregadicode=v.tyregadicode
                            and t.seasoncode=".$seasoncode;
                    }
                    else
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,null as vehiclecode,null as vehiclenumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                            from
                            (select w.seasoncode,w.fieldslipnumber from weightslip w
                            where nvl(w.loadweight,0)>0 and nvl(w.emptyweight,0)=0
                            )t,fieldslip f,vehicle v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.tyregadicode=v.tyregadicode
                            and t.seasoncode=".$seasoncode." and  f.fieldslipnumber=".$searchTerm;
                    }
            }
        }
    }
    elseif ($flag=='Query')
    {
        if ($weightcategorycode==1 or $weightcategorycode==3)
        {
            if ($vehiclecategorycode == 1 or $vehiclecategorycode == 2 or $vehiclecategorycode == 4)
            {
                    if ($searchTerm == '**')
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,f.vehiclecode,v.vehiclenumber,null as tyregadicode,null as tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                            from
                            (select t.seasoncode,t.fieldslipnumber from fieldslip t
                            )t,fieldslip f,vehicle v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.vehiclecode=v.vehiclecode
                            and v.vehiclecategorycode=".$vehiclecategorycode."
                            and t.seasoncode=".$seasoncode;
                    }
                    else
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,f.vehiclecode,v.vehiclenumber,null as tyregadicode,null as tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                            from
                            (select t.seasoncode,t.fieldslipnumber from fieldslip t
                            where nvl(w.loadweight,0)>0 
                            )t,fieldslip f,vehicle v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.vehiclecode=v.vehiclecode
                            and v.vehiclecategorycode=".$vehiclecategorycode."
                            and t.seasoncode=".$seasoncode." and  f.fieldslipnumber=".$searchTerm;
                    }
            }
            else if ($vehiclecategorycode == 3)
            {
                if ($searchTerm == '**')
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,null as vehiclecode,null as vehiclenumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                            from
                            (select t.seasoncode,t.fieldslipnumber from fieldslip t
                            where nvl(w.loadweight,0)>0 
                            )t,fieldslip f,tyregadi v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.tyregadicode=v.tyregadicode
                            and t.seasoncode=".$seasoncode;
                    }
                    else
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,null as vehiclecode,null as vehiclenumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                            from
                            (select t.seasoncode,t.fieldslipnumber from fieldslip t
                            )t,fieldslip f,vehicle v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.tyregadicode=v.tyregadicode
                            and t.seasoncode=".$seasoncode." and  f.fieldslipnumber=".$searchTerm;
                    }
            }
        }
        elseif ($weightcategorycode==2)
        {
            if ($vehiclecategorycode == 1 or $vehiclecategorycode == 2 or $vehiclecategorycode == 4)
            {
                    if ($searchTerm == '**')
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,f.vehiclecode,v.vehiclenumber,null as tyregadicode,null as tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                            from
                            (select w.seasoncode,w.fieldslipnumber from fieldslip w
                            )t,fieldslip f,vehicle v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.vehiclecode=v.vehiclecode
                            and v.vehiclecategorycode=".$vehiclecategorycode."
                            and t.seasoncode=".$seasoncode;
                    }
                    else
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,f.vehiclecode,v.vehiclenumber,null as tyregadicode,null as tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                            from
                            (select w.seasoncode,w.fieldslipnumber from fieldslip w
                            )t,fieldslip f,vehicle v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.vehiclecode=v.vehiclecode
                            and v.vehiclecategorycode=".$vehiclecategorycode."
                            and t.seasoncode=".$seasoncode." and  f.fieldslipnumber=".$searchTerm;
                    }
            }
            else if ($vehiclecategorycode == 3)
            {
                if ($searchTerm == '**')
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,null as vehiclecode,null as vehiclenumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                            from
                            (select w.seasoncode,w.fieldslipnumber from fieldslip w
                            )t,fieldslip f,tyregadi v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.tyregadicode=v.tyregadicode
                            and t.seasoncode=".$seasoncode;
                    }
                    else
                    {
                        $query = "select t.seasoncode,t.fieldslipnumber,null as vehiclecode,null as vehiclenumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                            ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                            where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                            from
                            (select w.seasoncode,w.fieldslipnumber from fieldslip w
                            )t,fieldslip f,vehicle v
                            where t.seasoncode=f.seasoncode 
                            and t.fieldslipnumber=f.fieldslipnumber
                            and t.seasoncode=v.seasoncode 
                            and f.tyregadicode=v.tyregadicode
                            and t.seasoncode=".$seasoncode." and  f.fieldslipnumber=".$searchTerm;
                    }
            }
        }
    }
   $result = oci_parse($connection, $query); $r = oci_execute($result);
   $r = oci_execute($result);
   while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
   {
       $caneyardtoken1 = new caneyardtoken($connection);
       $caneyardtoken1->transactionnumber = $row['TOKENTRANSACTIONNUMBER'];
       $caneyardtoken1->fetch();
       $id = $row['FIELDSLIPNUMBER'];
       $name = $row['FIELDSLIPNUMBER'];
       $tokentransactionnumber = $row['TOKENTRANSACTIONNUMBER'];   
       $tokennumberprefix = $caneyardtoken1->tokennumberprefix;
       if ($flag!='Query')
       {
            $vehiclecode = $row['VEHICLECODE'];
            $vehiclenumber = $row['VEHICLENUMBER'];
       }
       else
       {
            $vehiclecode = '';
            $vehiclenumber = '';
       }
       $tyregadicode = $row['TYREGADICODE'];
       $tyregadinumber = $row['TYREGADINUMBER'];
       $farmer1 = new farmer($connection);
       $farmer1->farmercode = $row['FARMERCODE'];
       $farmer1->fetch();
       $farmercode = $farmer1->farmercode;
       if ($_SESSION['lng']=="English")
       {
           $farmer = $farmer1->farmernameeng;
       }
       else
       {
           $farmer = $farmer1->farmernameuni;
       }
       $data[] = array( 
           'id' => $id
           ,'label' => $name
           ,'value' => $name
           ,'fieldslipnumber' => $fieldslipnumber 
           ,'tokentransactionnumber' => $tokentransactionnumber
           ,'tokennumberprefix' => $tokennumberprefix
           ,'vehiclecode' => $vehiclecode
           ,'vehiclenumber' => $vehiclenumber
           ,'tyregadicode' => $tyregadicode
           ,'tyregadinumber' => $tyregadinumber
           ,'farmercode' => $farmercode
           ,'farmer' => $farmer
           );
   }
   //return json data
   echo json_encode($data);
?>