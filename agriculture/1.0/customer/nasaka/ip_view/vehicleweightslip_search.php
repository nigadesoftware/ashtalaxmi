<?php
    //This is generated by Swapp Software Application on 07/05/2019 05:06:02 PM for PHP
    require_once("../info/phpsqlajax_dbinfo.php");
    require_once("../info/phpgetloginview.php");
    require_once("../info/routine.php");
    require_once("../ip_model/caneyardtoken_db_oracle.php");
    require_once("../ip_model/farmer_db_oracle.php");
    $connection =swapp_connection();
    $searchTerm = $_GET['term'];
    if (isset($_GET['vehiclecategorycode']))
    {
        $vehiclecategorycode = $_GET['vehiclecategorycode'];
    }
    else
    {
        $vehiclecategorycode =0;
    }
    if (isset($_GET['weightcategorycode']))
    {
        $weightcategorycode = $_GET['weightcategorycode'];
    }
    else
    {
        $weightcategorycode =0;
    }
    if (isset($_GET['flag']))
    {
        $flag = $_GET['flag'];
    }
    else
    {
        $flag ='';
    }
    $seasoncode = $_SESSION['yearperiodcode'];
    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    elseif (strlen($searchTerm)<3 and $searchTerm != '**')
    {
        exit;
    }
    if ($flag!='Query')
    {
        if ($weightcategorycode==1 or $weightcategorycode==3)
        {
            if ($searchTerm == '**')
            {
                $query = "select t.seasoncode,f.fieldslipnumber,f.vehiclecode,v.vehiclenumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                    from
                    (select t.seasoncode,t.fieldslipnumber from fieldslip t
                    minus
                    select w.seasoncode,w.fieldslipnumber from weightslip w
                    where nvl(w.loadweight,0)>0 
                    )t,fieldslip f,vehicle v
                    ,layer l
                    ,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.vehiclecode=v.vehiclecode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and f.fieldslipdate >= (trunc(sysdate)-3) 
                    and v.vehiclecategorycode=".$vehiclecategorycode."
                    and t.seasoncode=".$seasoncode." order by fieldslipdate desc,f.containercode,f.layercode,f.fieldslipnumber";
            }
            else
            {
                $query = "select t.seasoncode,f.fieldslipnumber,f.vehiclecode,v.vehiclenumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                    from
                    (select t.seasoncode,t.fieldslipnumber from fieldslip t
                    minus
                    select w.seasoncode,w.fieldslipnumber from weightslip w
                    where nvl(w.loadweight,0)>0 
                    )t,fieldslip f,vehicle v,layer l
                    ,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.vehiclecode=v.vehiclecode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and f.fieldslipdate >= (trunc(sysdate)-3) 
                    and v.vehiclecategorycode=".$vehiclecategorycode."
                    and t.seasoncode=".$seasoncode." and  (upper(v.vehiclenumber) like upper('%".$searchTerm."%')
                or v.vehiclenumber like '%".$searchTerm."%'
                or to_char(v.vehiclecode) like '".$searchTerm."') and v.seasoncode=".$seasoncode." order by fieldslipdate desc,f.containercode,f.layercode,f.fieldslipnumber";
            }
        }
        else if ($weightcategorycode==2)
        {
            if ($searchTerm == '**')
            {
                $query = "select t.seasoncode,f.fieldslipnumber,f.vehiclecode,v.vehiclenumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                    from
                    (select w.seasoncode,w.fieldslipnumber from weightslip w
                    where nvl(w.loadweight,0)>0 and nvl(w.emptyweight,0)=0 
                    )t,fieldslip f,vehicle v,layer l
                    ,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.vehiclecode=v.vehiclecode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and f.fieldslipdate >= (trunc(sysdate)-3) 
                    and v.vehiclecategorycode=".$vehiclecategorycode."
                    and t.seasoncode=".$seasoncode." order by fieldslipdate desc,f.containercode,f.layercode,f.fieldslipnumber";
            }
            else
            {
                $query = "select t.seasoncode,f.fieldslipnumber,f.vehiclecode,v.vehiclenumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                    from
                    (select w.seasoncode,w.fieldslipnumber from weightslip w
                    where nvl(w.loadweight,0)>0 and nvl(w.emptyweight,0)=0 
                    )t,fieldslip f,vehicle v,layer l
                    ,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.vehiclecode=v.vehiclecode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and f.fieldslipdate >= (trunc(sysdate)-3) 
                    and v.vehiclecategorycode=".$vehiclecategorycode."
                    and t.seasoncode=".$seasoncode." and  (upper(v.vehiclenumber) like upper('%".$searchTerm."%')
                or v.vehiclenumber like '%".$searchTerm."%'
                or to_char(v.vehiclecode) like '".$searchTerm."') and v.seasoncode=".$seasoncode." order by fieldslipdate desc,f.containercode,f.layercode,f.fieldslipnumber";
            }
        }
    }
    elseif ($flag=='Query')
    {
        if ($weightcategorycode==1 or $weightcategorycode==3)
        {
            if ($searchTerm == '**')
            {
                $query = "select t.seasoncode,f.fieldslipnumber,f.vehiclecode,v.vehiclenumber,f.farmercode
                ,l.layernameuni
                ,c.containernameuni
                ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                    from
                    (select t.seasoncode,t.fieldslipnumber from fieldslip t
                    )t,fieldslip f,vehicle v
                    ,layer l,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.vehiclecode=v.vehiclecode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and f.fieldslipdate >= (trunc(sysdate)-3) 
                    and v.vehiclecategorycode=".$vehiclecategorycode."
                    and t.seasoncode=".$seasoncode." order by fieldslipdate desc,f.containercode,f.layercode,f.fieldslipnumber";
            }
            else
            {
                $query = "select t.seasoncode,f.fieldslipnumber,f.vehiclecode,v.vehiclenumber,f.farmercode
                ,l.layernameuni
                ,c.containernameuni
                ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                    from
                    (select t.seasoncode,t.fieldslipnumber from fieldslip t
                    )t,fieldslip f,vehicle v
                    ,layer l,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.vehiclecode=v.vehiclecode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and f.fieldslipdate >= (trunc(sysdate)-3) 
                    and v.vehiclecategorycode=".$vehiclecategorycode."
                    and t.seasoncode=".$seasoncode." and  (upper(v.vehiclenumber) like upper('%".$searchTerm."%')
                or v.vehiclenumber like '%".$searchTerm."%'
                or to_char(v.vehiclecode) like '".$searchTerm."') and v.seasoncode=".$seasoncode
                ." order by fieldslipdate desc,f.containercode,f.layercode,f.fieldslipnumber";
            }
        }
        else if ($weightcategorycode==2)
        {
            if ($searchTerm == '**')
            {
                $query = "select t.seasoncode,f.fieldslipnumber,f.vehiclecode,v.vehiclenumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                    from
                    (select w.seasoncode,w.fieldslipnumber from weightslip w
                    where nvl(w.loadweight,0)>0 and nvl(w.emptyweight,0)=0
                    )t,fieldslip f,vehicle v
                    ,layer l,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.vehiclecode=v.vehiclecode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and f.fieldslipdate >= (trunc(sysdate)-3) 
                    and v.vehiclecategorycode=".$vehiclecategorycode."
                    and t.seasoncode=".$seasoncode." order by vehiclecode,fieldslipdate desc,f.containercode,f.layercode,f.fieldslipnumber";
            }
            else
            {
                $query = "select t.seasoncode,f.fieldslipnumber,f.vehiclecode,v.vehiclenumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                    from
                    (select w.seasoncode,w.fieldslipnumber from weightslip w
                    where nvl(w.loadweight,0)>0 and nvl(w.emptyweight,0)=0
                    )t,fieldslip f,vehicle v
                    ,layer l,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.vehiclecode=v.vehiclecode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and f.fieldslipdate >= (trunc(sysdate)-3) 
                    and v.vehiclecategorycode=".$vehiclecategorycode."
                    and t.seasoncode=".$seasoncode." and  (upper(v.vehiclenumber) like upper('%".$searchTerm."%')
                or v.vehiclenumber like '%".$searchTerm."%'
                or to_char(v.vehiclecode) like '".$searchTerm."') and v.seasoncode=".$seasoncode
                ." order by fieldslipdate desc,f.containercode,f.layercode,f.fieldslipnumber";
            }
        }
/*  */  elseif ($weightcategorycode==4)
        {
            if ($searchTerm == '**')
            {
                $query = "select t.seasoncode,weightslipnumber,f.fieldslipnumber,f.vehiclecode,v.vehiclenumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni,netweight
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                    from
                    (select w.seasoncode,w.weightslipnumber,w.fieldslipnumber,w.netweight from weightslip w
                    where nvl(w.loadweight,0)>0 and nvl(w.emptyweight,0)>0
                    )t,fieldslip f,vehicle v
                    ,layer l,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.vehiclecode=v.vehiclecode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and f.fieldslipdate >= (trunc(sysdate)-3) 
                    and v.vehiclecategorycode=".$vehiclecategorycode."
                    and t.seasoncode=".$seasoncode." order by weightslipnumber desc";
            }
            else
            {
                $query = "select t.seasoncode,weightslipnumber,f.fieldslipnumber,f.vehiclecode,v.vehiclenumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni,netweight
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.vehiclecode=f.vehiclecode) as tokentransactionnumber
                    from
                    (select w.seasoncode,w.weightslipnumber,w.fieldslipnumber,w.netweight from weightslip w
                    where nvl(w.loadweight,0)>0 and nvl(w.emptyweight,0)>0
                    )t,fieldslip f,vehicle v
                    ,layer l,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.vehiclecode=v.vehiclecode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and f.fieldslipdate >= (trunc(sysdate)-3) 
                    and v.vehiclecategorycode=".$vehiclecategorycode."
                    and t.seasoncode=".$seasoncode." and  (upper(v.vehiclenumber) like upper('%".$searchTerm."%')
                or v.vehiclenumber like '%".$searchTerm."%'
                or to_char(v.vehiclecode) like '".$searchTerm."') and v.seasoncode=".$seasoncode." order by weightslipnumber desc";
            }
        }
    }
   $result = oci_parse($connection, $query); $r = oci_execute($result);
   $r = oci_execute($result);
   while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
   {
       $caneyardtoken1 = new caneyardtoken($connection);
       $caneyardtoken1->transactionnumber = $row['TOKENTRANSACTIONNUMBER'];
       $caneyardtoken1->fetch();
       $id = $row['VEHICLECODE'];
       $name = $row['VEHICLENUMBER'];
       $layernameuni=$row['LAYERNAMEUNI'];
       $containernameuni=$row['CONTAINERNAMEUNI'];
       $fieldslipdate = $row['FIELDSLIPDATE'];
       $fieldslipnumber = $row['FIELDSLIPNUMBER']; 
       if ($weightcategorycode==4)
       {
            $netweight=$row['NETWEIGHT'];
            $fieldslipnumber = $row['FIELDSLIPNUMBER']; 
            $weightslipnumber = $row['WEIGHTSLIPNUMBER']; 
       }
       else {
            $netweight=0;
       }

       if ($flag!='Query')
       {
            $tokentransactionnumber = $row['TOKENTRANSACTIONNUMBER'];   
            $tokennumberprefix = $caneyardtoken1->tokennumberprefix;
            $farmer1 = new farmer($connection);
            $farmer1->farmercode = $row['FARMERCODE'];
            $farmer1->fetch();
            $farmercode = $farmer1->farmercode;
            if ($_SESSION['lng']=="English")
            {
                $farmer = $farmer1->farmernameeng;
            }
            else
            {
                $farmer = $farmer1->farmernameuni;
            }
        }
        if ($weightcategorycode==4)
        {
            $label=$name.':'.$weightslipnumber.':'.$fieldslipnumber.':'.$fieldslipdate.':'.$containernameuni.':'.$layernameuni.':'.$netweight;
        }
        else 
        {
            $label=$name.':'.$fieldslipnumber.':'.$fieldslipdate.':'.$containernameuni.':'.$layernameuni;
        }
       $data[] = array( 
           'id' => $id
           ,'label' => $label
           ,'value' => $name
           ,'fieldslipnumber' => $fieldslipnumber 
           ,'tokentransactionnumber' => $tokentransactionnumber
           ,'tokennumberprefix' => $tokennumberprefix
           ,'layer' => $layernameuni
           ,'container' => $containernameuni
           ,'farmercode' => $farmercode
           ,'farmer' => $farmer
           );
   }
   //return json data
   echo json_encode($data);
?>