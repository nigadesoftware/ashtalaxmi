<?php
    //This is generated by Swapp Software Application on 07/05/2019 05:06:02 PM for PHP
    require_once("../info/phpsqlajax_dbinfo.php");
    require_once("../info/phpgetloginview.php");
    require_once("../info/routine.php");
    require_once("../ip_model/caneyardtoken_db_oracle.php");
    require_once("../ip_model/farmer_db_oracle.php");
    $connection =swapp_connection();
    $searchTerm = $_GET['term'];
    if (isset($_GET['vehiclecategorycode']))
    {
        $vehiclecategorycode = $_GET['vehiclecategorycode'];
    }
    else
    {
        $vehiclecategorycode =0;
    }
    if (isset($_GET['weightcategorycode']))
    {
        $weightcategorycode = $_GET['weightcategorycode'];
    }
    else
    {
        $weightcategorycode =0;
    }
    if (isset($_GET['flag']))
    {
        $flag = $_GET['flag'];
    }
    else
    {
        $flag ='';
    }
    $seasoncode = $_SESSION['yearperiodcode'];
    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    elseif (strlen($searchTerm)<3 and $searchTerm != '**')
    {
        exit;
    }
    if ($flag != 'Query')
    {
        if ($weightcategorycode==1 or $weightcategorycode==3)
        {
            if ($searchTerm == '**')
            {
                $query = "select t.seasoncode,t.fieldslipnumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                    from
                    (select t.seasoncode,t.fieldslipnumber from fieldslip t
                    minus
                    select w.seasoncode,w.fieldslipnumber from weightslip w
                    where nvl(w.loadweight,0)>0
                    )t,fieldslip f,tyregadi v
                    ,layer l
                    ,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.tyregadicode=v.tyregadicode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and t.seasoncode=".$seasoncode.
                    " order by to_number(tyregadinumber),fieldslipdate desc,f.containercode,f.layercode,f.fieldslipnumber";
            }
            else
            {
                $query = "select t.seasoncode,t.fieldslipnumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                    from
                    (select t.seasoncode,t.fieldslipnumber from fieldslip t
                    minus
                    select w.seasoncode,w.fieldslipnumber from weightslip w
                    where nvl(w.loadweight,0)>0
                    )t,fieldslip f,tyregadi v
                    ,layer l
                    ,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.tyregadicode=v.tyregadicode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and t.seasoncode=".$seasoncode." and  (
                        v.tyregadinumber = '".$searchTerm."'
                        or to_char(v.tyregadicode) = ".$searchTerm.") and v.seasoncode=".$seasoncode.
                " order by to_number(tyregadinumber),fieldslipdate desc,f.containercode,f.layercode,f.fieldslipnumber";
            }
        }
    }
    elseif ($flag == 'Query')
    {
        if ($weightcategorycode==2)
        {
            if ($searchTerm == '**')
            {
                $query = "select t.seasoncode,t.fieldslipnumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                    from
                    (select t.seasoncode,t.fieldslipnumber from weightslip t
                    where nvl(t.loadweight,0)>0 and nvl(t.emptyweight,0)=0 
                    )t,fieldslip f,tyregadi v
                    ,layer l
                    ,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.tyregadicode=v.tyregadicode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and t.seasoncode=".$seasoncode." order by to_number(tyregadinumber)";
            }
            else
            {
                $query = "select t.seasoncode,t.fieldslipnumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                    from
                    (select t.seasoncode,t.fieldslipnumber from weightslip t
                    where nvl(t.loadweight,0)>0 and nvl(t.emptyweight,0)=0 
                    )t,fieldslip f,tyregadi v
                    ,layer l
                    ,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.tyregadicode=v.tyregadicode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and t.seasoncode=".$seasoncode." and  (
                        v.tyregadinumber = '".$searchTerm."'
                        or to_char(v.tyregadicode) = ".$searchTerm.") and v.seasoncode=".$seasoncode;
            }
        }
        elseif ($weightcategorycode==4)
        {
            if ($searchTerm == '**')
            {
                $query = "select t.seasoncode,weightslipnumber,f.fieldslipnumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni,netweight
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                    from
                    (select w.seasoncode,w.weightslipnumber,w.fieldslipnumber,w.netweight from weightslip w
                    where nvl(w.loadweight,0)>0 and nvl(w.emptyweight,0)>0
                    )t,fieldslip f,tyregadi v
                    ,layer l,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.tyregadicode=v.tyregadicode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and t.seasoncode=".$seasoncode." order by weightslipnumber desc";
            }
            else
            {
                $query = "select t.seasoncode,weightslipnumber,f.fieldslipnumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni,netweight
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                    from
                    (select w.seasoncode,w.weightslipnumber,w.fieldslipnumber,w.netweight from weightslip w
                    where nvl(w.loadweight,0)>0 and nvl(w.emptyweight,0)>0
                    )t,fieldslip f,tyregadi v
                    ,layer l,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.tyregadicode=v.tyregadicode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and t.seasoncode=".$seasoncode." and  (
                        v.tyregadinumber = '".$searchTerm."'
                        or to_char(v.tyregadicode) = ".$searchTerm.") and v.seasoncode=".$seasoncode." order by weightslipnumber desc";
            }
        }
        else
        {
            if ($searchTerm == '**')
            {
                $query = "select t.seasoncode,t.fieldslipnumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                    from
                    (select t.seasoncode,t.fieldslipnumber from fieldslip t
                    )t,fieldslip f,tyregadi v
                    ,layer l
                    ,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.tyregadicode=v.tyregadicode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and t.seasoncode=".$seasoncode." order by to_number(tyregadinumber)";
            }
            else
            {
                $query = "select t.seasoncode,t.fieldslipnumber,f.tyregadicode,v.tyregadinumber,f.farmercode
                    ,l.layernameuni
                    ,c.containernameuni
                    ,to_char(fieldslipdate,'dd/MM/YYYY') as fieldslipdate
                    ,(select max(c.transactionnumber) as transactionnumber from caneyardtoken c 
                    where c.seasoncode=t.seasoncode and c.tyregadicode=f.tyregadicode) as tokentransactionnumber
                    from
                    (select t.seasoncode,t.fieldslipnumber from fieldslip t
                    )t,fieldslip f,tyregadi v
                    ,layer l
                    ,container c
                    where t.seasoncode=f.seasoncode 
                    and t.fieldslipnumber=f.fieldslipnumber
                    and t.seasoncode=v.seasoncode 
                    and f.tyregadicode=v.tyregadicode
                    and f.layercode=l.layercode
                    and f.containercode=c.containercode
                    and t.seasoncode=".$seasoncode." and  (
                v.tyregadinumber = '".$searchTerm."'
                or to_char(v.tyregadicode) = ".$searchTerm.") and v.seasoncode=".$seasoncode;
            }
        }
    }
   $result = oci_parse($connection, $query); $r = oci_execute($result);
   $r = oci_execute($result);
   while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
   {
       $caneyardtoken1 = new caneyardtoken($connection);
       $caneyardtoken1->transactionnumber = $row['TOKENTRANSACTIONNUMBER'];
       $caneyardtoken1->fetch();
       $id = $row['TYREGADICODE'];
       $name = $row['TYREGADINUMBER'];
       $fieldslipdate = $row['FIELDSLIPDATE'];
       $fieldslipnumber = $row['FIELDSLIPNUMBER']; 
       $tokentransactionnumber = $row['TOKENTRANSACTIONNUMBER'];   
       $tokennumberprefix = $caneyardtoken1->tokennumberprefix;
       $farmer1 = new farmer($connection);
       $farmer1->farmercode = $row['FARMERCODE'];
       $farmer1->fetch();
       $farmercode = $farmer1->farmercode;
       $layernameuni=$row['LAYERNAMEUNI'];
       $containernameuni=$row['CONTAINERNAMEUNI'];
       if ($_SESSION['lng']=="English")
       {
           $farmer = $farmer1->farmernameeng;
       }
       else
       {
           $farmer = $farmer1->farmernameuni;
       }
       if ($weightcategorycode==4)
       {
            $netweight=$row['NETWEIGHT'];
            $fieldslipnumber = $row['FIELDSLIPNUMBER']; 
            $weightslipnumber = $row['WEIGHTSLIPNUMBER']; 
       }
       else {
            $netweight=0;
       }
       if ($weightcategorycode==4)
        {
            $label=$name.':'.$weightslipnumber.':'.$fieldslipnumber.':'.$fieldslipdate.':'.$layernameuni.':'.$netweight;
        }
        else 
        {
            $label=$name.':'.$fieldslipnumber.':'.$fieldslipdate.':'.$layernameuni;
        }
       $data[] = array( 
           'id' => $id
           ,'label' => $label
           ,'value' => $name
           ,'fieldslipnumber' => $fieldslipnumber 
           ,'tokentransactionnumber' => $tokentransactionnumber
           ,'tokennumberprefix' => $tokennumberprefix
           ,'layer' => $layernameuni
           ,'container' => $containernameuni
           ,'farmercode' => $farmercode
           ,'farmer' => $farmer
           );
   }
   //return json data
   echo json_encode($data);
?>