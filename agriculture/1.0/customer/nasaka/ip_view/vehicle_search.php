<?php
    //This is generated by Swapp Software Application on 07/05/2019 05:06:02 PM for PHP
    require_once("../info/phpsqlajax_dbinfo.php");
    require_once("../info/phpgetloginview.php");
    require_once("../info/routine.php");
    require_once("../ip_model/harvestervehiclepair_db_oracle.php");
    $connection =swapp_connection();
    $searchTerm = $_GET['term'];
    $vehiclecategorycode = $_GET['vehiclecategorycode'];
    if ($searchTerm=='')
    {
        $searchTerm = 'No Values';
    }
    $seasoncode = $_SESSION['yearperiodcode'];
    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    /* elseif (strlen($searchTerm)<1 and $searchTerm != '**')
    {
        exit;
    } */
   if ($vehiclecategorycode !='')
   { 
    if ($searchTerm == '**')
    {
        $query = "select t.vehiclecode,t.vehiclenumber,t.vehiclecategorycode
        ,s.subcontractorcode,s.subcontractornameeng,s.subcontractornameuni
        ,c.contractorcode,c.contractornameeng,c.contractornameuni 
        ,a.servicetrhrcategorycode
        from vehicle t,subcontractor s,contractor c,contractorcontract a
        where t.subcontractorcode=s.subcontractorcode
        and t.seasoncode=s.seasoncode
        and c.contractorcode=a.contractorcode
        and s.contractcode=a.contractcode
        and s.seasoncode=a.seasoncode
        and t.vehiclecategorycode=".$vehiclecategorycode."
            and t.seasoncode=".$seasoncode;
    }
    else
    {
        $query = "select t.vehiclecode,t.vehiclenumber,t.vehiclecategorycode
        ,s.subcontractorcode,s.subcontractornameeng,s.subcontractornameuni
        ,c.contractorcode,c.contractornameeng,c.contractornameuni 
        ,a.servicetrhrcategorycode
        from vehicle t,subcontractor s,contractor c,contractorcontract a
        where t.subcontractorcode=s.subcontractorcode
        and t.seasoncode=s.seasoncode
        and c.contractorcode=a.contractorcode
        and s.contractcode=a.contractcode
        and s.seasoncode=a.seasoncode
        and t.vehiclecategorycode=".$vehiclecategorycode."
        and  (upper(t.vehiclenumber) like upper('%".$searchTerm."%')
        or t.vehiclenumber like '%".$searchTerm."%'
        or to_char(t.vehiclecode) like '".$searchTerm."') and t.seasoncode=".$_SESSION['yearperiodcode'];
    }
   } 
   else
   {
    if ($searchTerm == '**')
    {
        $query = "select t.vehiclecode,t.vehiclenumber,t.vehiclecategorycode
        ,s.subcontractorcode,s.subcontractornameeng,s.subcontractornameuni
        ,c.contractorcode,c.contractornameeng,c.contractornameuni 
        ,a.servicetrhrcategorycode
        from vehicle t,subcontractor s,contractor c,contractorcontract a
        where t.subcontractorcode=s.subcontractorcode
        and t.seasoncode=s.seasoncode
        and c.contractorcode=a.contractorcode
        and s.contractcode=a.contractcode
        and s.seasoncode=a.seasoncode
            and t.seasoncode=".$seasoncode;
    }
    else
    {
        $query = "select t.vehiclecode,t.vehiclenumber,t.vehiclecategorycode
        ,s.subcontractorcode,s.subcontractornameeng,s.subcontractornameuni
        ,c.contractorcode,c.contractornameeng,c.contractornameuni 
        ,servicetrhrcategorycode
        from vehicle t,subcontractor s,contractor c,contractorcontract a
        where t.subcontractorcode=s.subcontractorcode
        and t.seasoncode=s.seasoncode
        and c.contractorcode=a.contractorcode
        and s.contractcode=a.contractcode
        and s.seasoncode=a.seasoncode
        and  (upper(t.vehiclenumber) like upper('%".$searchTerm."%')
        or t.vehiclenumber like '%".$searchTerm."%'
        or to_char(t.vehiclecode) like '".$searchTerm."') and t.seasoncode=".$_SESSION['yearperiodcode'];
    }
   }
   $result = oci_parse($connection, $query); $r = oci_execute($result);
   $r = oci_execute($result);
   $cnt=0;
   while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
   {
    $cnt++;  
    $query1 = "select s.subcontractorcode,s.subcontractornameeng,s.subcontractornameuni
    from harvestervehiclepair p,subcontractor s
    where p.seasoncode=".$seasoncode." and p.vehiclecode=".$row['VEHICLECODE'].
    " and p.harvestercode=s.subcontractorcode and p.seasoncode=s.seasoncode";
    $result1 = oci_parse($connection, $query1); $r = oci_execute($result1);
    $r1 = oci_execute($result1);
    $row1 = oci_fetch_array($result1,OCI_ASSOC+OCI_RETURN_NULLS);
    $id = $row['VEHICLECODE'];
    if ($row['VEHICLECATEGORYCODE']==4 and $row['SERVICETRHRCATEGORYCODE']!=13)
    $subcontractorcode ='';
    else if ($row['VEHICLECATEGORYCODE']==4 and $row['SERVICETRHRCATEGORYCODE']==13)
    $subcontractorcode = $row['SUBCONTRACTORCODE'];
    else
    $subcontractorcode = $row['SUBCONTRACTORCODE'];
    $contractorcode = $row['CONTRACTORCODE'];
    if ($row['VEHICLECATEGORYCODE']==1 or $row['VEHICLECATEGORYCODE']==2)
    {
         $harvestercode = $row1['SUBCONTRACTORCODE'];
    }
    else
    {
        $harvestercode = '';
    }
    if ($row['VEHICLECATEGORYCODE']==4 and $row['SERVICETRHRCATEGORYCODE']!=13)
    {
         $harvestertransportercode = $row['SUBCONTRACTORCODE'];
    }
    if ($row['VEHICLECATEGORYCODE']==4 and $row['SERVICETRHRCATEGORYCODE']==13)
    {
         $harvestertransportercode = '';
    }
    else
    {
        $harvestertransportercode = $row['SUBCONTRACTORCODE'];
    }
    if ($_SESSION['lng'] == "English")
    {
        $name = $row['VEHICLENUMBER'];
        if ($row['VEHICLECATEGORYCODE']==4 and $row['SERVICETRHRCATEGORYCODE']!=13)
        $subcontractorname ='';
        elseif ($row['VEHICLECATEGORYCODE']==4 and $row['SERVICETRHRCATEGORYCODE']==13)
        $subcontractorname =$row['SUBCONTRACTORNAMEENG'];
        else
        $subcontractorname = $row['SUBCONTRACTORNAMEENG'];
        $contractorname = $row['CONTRACTORNAMEENG'];
        if ($row['VEHICLECATEGORYCODE']==1 or $row['VEHICLECATEGORYCODE']==2)
        {
             $harvestername = $row1['SUBCONTRACTORNAMEENG'];
        }
        else
        {
             $harvestername = '';
        }
        if ($row['VEHICLECATEGORYCODE']==4 and $row['SERVICETRHRCATEGORYCODE']!=13)
        {
             $harvestertransportername = $row['SUBCONTRACTORNAMEENG'];
        }
        else
        {
             $harvestertransportername = '';
        }  
    }
    else
    {
        $name = $row['VEHICLENUMBER'];
        if ($row['VEHICLECATEGORYCODE']==4 and $row['SERVICETRHRCATEGORYCODE']!=13)
        $subcontractorname ='';
        elseif ($row['VEHICLECATEGORYCODE']==4 and $row['SERVICETRHRCATEGORYCODE']==13)
        $subcontractorname =$row['SUBCONTRACTORNAMEUNI'];
        else
        $subcontractorname = $row['SUBCONTRACTORNAMEUNI'];
        $contractorname = $row['CONTRACTORNAMEUNI'];
        if ($row['VEHICLECATEGORYCODE']==1 or $row['VEHICLECATEGORYCODE']==2)
        {
            $harvestername = $row1['SUBCONTRACTORNAMEUNI'];
        }
        else
        {
            $harvestername = '';
        }
        if ($row['VEHICLECATEGORYCODE']==4 and $row['SERVICETRHRCATEGORYCODE']!=13)
        {
             $harvestertransportername = $row['SUBCONTRACTORNAMEUNI'];
        }
        elseif ($row['VEHICLECATEGORYCODE']==4 and $row['SERVICETRHRCATEGORYCODE']==13)
        {
            $harvestertransportername = '';
        }
        else
        {
             $harvestertransportername = '';
        }   
    }
    $data[] = array( 
        'id' => $id
        ,'label' => $name
        ,'value' => $name
        ,'subcontractorname' => $subcontractorname
        ,'subcontractorcode' => $subcontractorcode
        ,'contractorname' => $contractorname
        ,'contractorcode' => $contractorcode
        ,'harvestername' => $harvestername
        ,'harvestercode' => $harvestercode
        ,'harvestertransportername' => $harvestertransportername
        ,'harvestertransportercode' => $harvestertransportercode
        );
}
if ($cnt==0)
{
    $data[] = array( 
        'id' => ''
        ,'label' => ''
        ,'value' => ''
        ,'subcontractorname' => ''
        ,'subcontractorcode' => ''
        ,'contractorname' => ''
        ,'contractorcode' => ''
        ,'harvestername' => ''
        ,'harvestercode' => ''
        ,'harvestertransportername' => ''
        ,'harvestertransportercode' => ''
        );
}
//return json data
echo json_encode($data);
?>