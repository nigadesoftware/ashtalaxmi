<?php
    //This is generated by Swapp Software Application on 28/05/2019 07:19:54 PM for PHP
    require_once("../info/phpsqlajax_dbinfo.php");
    require_once("../info/phpgetloginview.php");
    require_once("../info/routine.php");
    $connection = swapp_connection();
    $searchTerm = $_GET['term'];
    $farmercode = $_GET['farmercode'];
    $seasoncode = $_SESSION['yearperiodcode'];
    $plantationcategorycode = $_GET['plantationcategorycode'];
    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    elseif ((strlen($searchTerm)<3) and $searchTerm != '**')
    {
        exit;
    }
    if ($plantationcategorycode==1)
    {
        exit;
    }
    if ($farmercode=='')
    {
        $cond=' and to_char(plotnumber) = '.$searchTerm;
    }
    else
    {
        if ($searchTerm=='**')
        {
            $cond=' and h.farmercode='.$farmercode;
        }
        else
        {
            $cond=' and to_char(plotnumber) = '.$searchTerm;
        }
    }
    $query = "select plotnumber
    ,f.farmercode
    ,farmernameeng
    ,farmernameuni
    ,f.farmercategorycode
    ,c.farmercategorynameeng
    ,c.farmercategorynameuni
    ,v.villagecode
    ,villagenameeng
    ,villagenameuni
    ,s.subvillagecode
    ,subvillagenameeng
    ,subvillagenameuni
    ,vr.varietycode
    ,vr.varietynameuni
    ,vr.varietynameeng
    ,h.gutnumber
    ,h.area
    ,irrigationsourcecode
    ,irrigationmethodcode
    ,caneseedcategorycode
    ,plantationmethodcode
    ,caneseedsourcecode
    ,plantationhangamcode
    from plantationheader h,farmer f,village v,subvillage s,farmercategory c,variety vr
    where h.farmercode=f.farmercode 
    and f.farmercategorycode=c.farmercategorycode  
    and h.villagecode=v.villagecode
    and h.villagecode=s.villagecode(+)
    and h.subvillagecode=s.subvillagecode(+)
    and h.varietycode=vr.varietycode(+)
    and seasoncode=".($seasoncode-10001).$cond." 
     order by plotnumber";
   $result = oci_parse($connection, $query); $r = oci_execute($result);
   $r = oci_execute($result);
   while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
   {
       $id = $row['PLOTNUMBER'];
       $farmercode= $row['FARMERCODE'];
       $farmercategorycode= $row['FARMERCATEGORYCODE'];
       $villagecode= $row['VILLAGECODE'];
       $subvillagecode= $row['SUBVILLAGECODE'];
       $gutnumber=$row['GUTNMBER'];
       $area=$row['AREA'];
       $varietycode = $row['VARIETYCODE'];
       $irrigationsourcecode=$row['IRRIGATIONSOURCECODE'];
       $irrigationmethodcode=$row['IRRIGATIONMETHODCODE'];
       $caneseedcategorycode=$row['CANESEEDCATEGORYCODE'];
       $plantationmethodcode=$row['PLANTATIONMETHODCODE'];
       $caneseedsourcecode=$row['CANESEEDSOURCECODE'];
       $plantationhangamcode=$row['PLANTATIONHANGAMCODE'];
       if ($_SESSION['lng'] == "English")
       {
           $name = $row['FARMERNAMEENG'];
           $farmercategory = $row['FARMERCATEGORYNAMEENG'];
           $village= $row['VILLAGENAMEENG'];
           $subvillage = $row['SUBVILLAGENAMEENG'];
           $varietyname = $row['VARIETYNAMEENG'];
       }
       else
       {
           $name = $row['FARMERNAMEUNI'];
           $farmercategory = $row['FARMERCATEGORYNAMEUNI'];
           $village= $row['VILLAGENAMEUNI'];
           $subvillage = $row['SUBVILLAGENAMEUNI'];
           $varietyname = $row['VARIETYNAMEUNI'];
       }
       $data[] = array( 
           'id' => $id
           ,'label' => $id.' - '.$name.' - '.$village.' - '.$gutnumber.' - '.$varietyname.' - '.$area
           ,'value' => $name
           ,'farmercode' => $farmercode
           ,'farmercategorycode' => $farmercategorycode
           ,'farmercategory' => $farmercategory
           ,'villagecode' => $villagecode
           ,'village' => $village
           ,'subvillagecode' => $subvillagecode
           ,'subvillage' => $subvillage
           ,'gutnumber' => $gutnumber
           ,'varietyname' => $varietyname
           ,'varietycode' => $varietycode
           ,'area' => $area
           ,'irrigationsourcecode' => $irrigationsourcecode
           ,'irrigationmethodcode' => $irrigationmethodcode
           ,'caneseedcategorycode' => $caneseedcategorycode
           ,'plantationmethodcode' => $plantationmethodcode
           ,'caneseedsourcecode' => $caneseedsourcecode
           ,'plantationhangamcode' => $plantationhangamcode
           );

   }
   //return json data
   echo json_encode($data);
?>