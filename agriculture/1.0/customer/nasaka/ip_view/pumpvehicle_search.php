<?php
    //This is generated by Swapp Software Application on 07/05/2019 05:06:02 PM for PHP
    require_once("../info/phpsqlajax_dbinfo.php");
    require_once("../info/phpgetloginview.php");
    require_once("../info/routine.php");
    require_once("../ip_model/harvestervehiclepair_db_oracle.php");
    $connection =swapp_connection();
    $searchTerm = $_GET['term'];
    $pumpcode = $_GET['pumpcode'];
    $transactiondate = $_GET['transactiondate'];
    if ($searchTerm=='')
    {
        $searchTerm = 'No Values';
    }
    $seasoncode = $_SESSION['yearperiodcode'];
    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    /* elseif (strlen($searchTerm)<1 and $searchTerm != '**')
    {
        exit;
    } */
    if ($transactiondate!='')
    {
        $dt=DateTime::createFromFormat('d/m/Y',$transactiondate)->format('d-M-y');
        $query0 ="select getpumprate(p_pump_code => {$pumpcode},
        p_ratedate => '".$dt."',
        p_flag => 1) purchaserate,
        getpumprate(p_pump_code => {$pumpcode},
        p_ratedate => '".$dt."',
        p_flag => 2) salerate
        from dual";
        $result0 = oci_parse($connection, $query0); 
        $r = oci_execute($result0);
        $cnt=0;
        if ($row0 = oci_fetch_array($result0,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $purchaserate=$row0['PURCHASERATE'];
            $salerate=$row0['SALERATE'];
        }
        else 
        {
            $purchaserate=0;
            $salerate=0;
        }
    }
    else 
        {
            $purchaserate=0;
            $salerate=0;
        }
   if ($searchTerm == '**')
   {
       $query = "select t.vehiclecode,t.vehiclenumber,t.vehiclecategorycode
       ,s.subcontractorcode,s.subcontractornameeng,s.subcontractornameuni
       ,c.contractorcode,c.contractornameeng,c.contractornameuni 
       from vehicle t,subcontractor s,contractor c,contractorcontract a
       where t.subcontractorcode=s.subcontractorcode
       and t.seasoncode=s.seasoncode
       and c.contractorcode=a.contractorcode
       and s.contractcode=a.contractcode
       and s.seasoncode=a.seasoncode
       and t.vehiclecategorycode=".$vehiclecategorycode."
        and t.seasoncode=".$seasoncode;
   }
   else
   {
       $query = "select t.vehiclecode,t.vehiclenumber,t.vehiclecategorycode
       ,s.subcontractorcode,s.subcontractornameeng,s.subcontractornameuni
       ,c.contractorcode,c.contractornameeng,c.contractornameuni 
       from vehicle t,subcontractor s,contractor c,contractorcontract a
       where t.subcontractorcode=s.subcontractorcode
       and t.seasoncode=s.seasoncode
       and c.contractorcode=a.contractorcode
       and s.contractcode=a.contractcode
       and s.seasoncode=a.seasoncode
       and  (upper(t.vehiclenumber) like upper('%".$searchTerm."%')
       or t.vehiclenumber like '%".$searchTerm."%'
       or to_char(t.vehiclecode) like '".$searchTerm."') and t.seasoncode=".$_SESSION['yearperiodcode'];
   }
   
   $result = oci_parse($connection, $query); $r = oci_execute($result);
   $cnt=0;
   while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
   {
    $cnt++;  
    $query1 = "select s.subcontractorcode,s.subcontractornameeng,s.subcontractornameuni
    ,h.harvestersubcategorynameeng,harvestersubcategorynameuni
    from harvestervehiclepair p,subcontractor s,harvestersubcategory h
    where p.seasoncode=".$seasoncode." and p.vehiclecode=".$row['VEHICLECODE'].
    " and p.harvestercode=s.subcontractorcode and p.seasoncode=s.seasoncode 
    and s.harvestersubcategorycode=h.harvestersubcategorycode";
    $result1 = oci_parse($connection, $query1); $r = oci_execute($result1);
    $r1 = oci_execute($result1);
    $row1 = oci_fetch_array($result1,OCI_ASSOC+OCI_RETURN_NULLS);
    $id = $row['VEHICLECODE'];
    if ($_SESSION['lng'] == "English")
    {
        $name = $row['VEHICLENUMBER'];
    }
    else
    {
        $name = $row['VEHICLENUMBER'];
    }
    $data[] = array( 
        'id' => $id
        ,'label' => $name
        ,'value' => $name
        ,'purchaserate' => $purchaserate
        ,'salerate' => $salerate
        );
}
/* if ($cnt==0)
{
    $data[] = array( 
        'id' => ''
        ,'label' => ''
        ,'value' => ''
        ,'purchaserate' => ''
        ,'salerate' => ''
        );
} */
//return json data
echo json_encode($data);
?>