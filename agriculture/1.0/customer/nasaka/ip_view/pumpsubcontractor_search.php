<?php
    //This is generated by Swapp Software Application on 18/05/2019 07:38:00 PM for PHP
    require_once("../info/phpsqlajax_dbinfo.php");
    require_once("../info/phpgetloginview.php");
    require_once("../info/routine.php");
    $connection =swapp_connection();
    $searchTerm = $_GET['term'];
    $pumpcode = $_GET['pumpcode'];
    $transactiondate = $_GET['transactiondate'];
    $seasoncode = $_SESSION['yearperiodcode'];
    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    elseif ((strlen($searchTerm)<3) and $searchTerm != '**')
    {
        exit;
    }
    if ($transactiondate!='')
    {
        $dt=DateTime::createFromFormat('d/m/Y',$transactiondate)->format('d-M-y');
        $query0 ="select getpumprate(p_pump_code => {$pumpcode},
        p_ratedate => '".$dt."',
        p_flag => 1) purchaserate,
        getpumprate(p_pump_code => {$pumpcode},
        p_ratedate => '".$dt."',
        p_flag => 2) salerate
        from dual";
        $result0 = oci_parse($connection, $query0); 
        $r = oci_execute($result0);
        $cnt=0;
        if ($row0 = oci_fetch_array($result0,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $purchaserate=$row0['PURCHASERATE'];
            $salerate=$row0['SALERATE'];
        }
        else 
        {
            $purchaserate=0;
            $salerate=0;
        }
    }
    else 
        {
            $purchaserate=0;
            $salerate=0;
        }

   if ($searchTerm == '**')
   {
       $query = "select s.subcontractorcode,s.subcontractornameeng,s.subcontractornameuni
        ,c.contractorcode,c.contractornameeng,c.contractornameuni,y.servicetrhrcatnameuni 
        ,y.servicetrhrcatnameuni,y.servicetrhrcatnameeng
        from contractorcontract t,subcontractor s,contractor c,servicetrhrcategory y
        where t.seasoncode=s.seasoncode and t.contractcode=s.contractcode
        and t.contractorcode=c.contractorcode and t.servicetrhrcategorycode=y.servicetrhrcategorycode 
        and y.servicetrhrcategorycode in (12)
        and s.seasoncode=".$seasoncode;
   }
   else
   {
       $query = "select s.subcontractorcode,s.subcontractornameeng,s.subcontractornameuni
        ,c.contractorcode,c.contractornameeng,c.contractornameuni
        ,y.servicetrhrcatnameuni,y.servicetrhrcatnameeng
        from contractorcontract t,subcontractor s,contractor c,servicetrhrcategory y
        where t.seasoncode=s.seasoncode and t.contractcode=s.contractcode
        and t.contractorcode=c.contractorcode and t.servicetrhrcategorycode=y.servicetrhrcategorycode 
        and s.seasoncode=".$seasoncode." and (upper(subcontractornameeng) like upper('%".$searchTerm."%')
       or subcontractornameuni like '%".$searchTerm."%'
       or to_char(subcontractorcode) like '".$searchTerm."') and y.servicetrhrcategorycode in (12)";
   }
   $result = oci_parse($connection, $query); 
   $r = oci_execute($result);
   while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
   {
       $id = $row['SUBCONTRACTORCODE'];
       $contractorcode = $row['CONTRACTORCODE'];
       if ($_SESSION['lng'] == "English")
       {
           $name = $row['SUBCONTRACTORNAMEENG'].' - '.$row['SERVICETRHRCATNAMEENG'].' - '.$row['CONTRACTORNAMEENG'];
           $contractorname = $row['CONTRACTORNAMEENG'];
       }
       else
       {
           $name = $row['SUBCONTRACTORNAMEUNI'].' - '.$row['SERVICETRHRCATNAMEUNI'].' - '.$row['CONTRACTORNAMEUNI'];
           $contractorname = $row['CONTRACTORNAMEUNI'];
                  }
       $data[] = array( 
           'id' => $id
           ,'label' => $name
           ,'value' => $name
           ,'contractorcode' => $contractorcode
           ,'contractorname' => $contractorname
           ,'purchaserate' => $purchaserate
           ,'salerate' => $salerate
           );
   }
   //return json data
   echo json_encode($data);
?>