<?php
    //This is generated by Swapp Software Application on 28/05/2019 07:19:54 PM for PHP
    require_once("../info/phpsqlajax_dbinfo.php");
    require_once("../info/phpgetloginview.php");
    require_once("../info/routine.php");
    $connection = swapp_connection();
    $searchTerm = $_GET['term'];
    $farmercode = $_GET['farmercode'];
    $seasoncode = $_SESSION['yearperiodcode'];
    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    elseif ((strlen($searchTerm)<3) and $searchTerm != '**')
    {
        exit;
    }
    if ($farmercode=='')
    {
        $cond=' and to_char(plotnumber) = '.$searchTerm;
    }
    else
    {
        if ($searchTerm=='**')
        {
            $cond=' and h.farmercode='.$farmercode;
        }
        else
        {
            $cond=' and to_char(plotnumber) = '.$searchTerm;
        }
    }
    $query = "select plotnumber
    ,f.farmercode
    ,farmernameeng
    ,farmernameuni
    ,f.farmercategorycode
    ,c.farmercategorynameeng
    ,c.farmercategorynameuni
    ,v.villagecode
    ,villagenameeng
    ,villagenameuni
    ,s.subvillagecode
    ,subvillagenameeng
    ,subvillagenameuni
    from plantationheader h,farmer f,village v,subvillage s,farmercategory c
    where h.farmercode=f.farmercode 
    and f.farmercategorycode=c.farmercategorycode  
    and h.villagecode=v.villagecode
    and h.villagecode=s.villagecode(+)
    and h.subvillagecode=s.subvillagecode(+)
    and seasoncode=".$seasoncode.$cond." 
     order by plotnumber";
   $result = oci_parse($connection, $query); $r = oci_execute($result);
   $r = oci_execute($result);
   while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
   {
       $id = $row['PLOTNUMBER'];
       $farmercode= $row['FARMERCODE'];
       $farmercategorycode= $row['FARMERCATEGORYCODE'];
       $villagecode= $row['VILLAGECODE'];
       $subvillagecode= $row['SUBVILLAGECODE'];
       if ($_SESSION['lng'] == "English")
       {
           $name = $row['FARMERNAMEENG'];
           $farmercategory = $row['FARMERCATEGORYNAMEENG'];
           $village= $row['VILLAGENAMEENG'];
           $subvillage = $row['SUBVILLAGENAMEENG'];
       }
       else
       {
           $name = $row['FARMERNAMEUNI'];
           $farmercategory = $row['FARMERCATEGORYNAMEUNI'];
           $village= $row['VILLAGENAMEUNI'];
           $subvillage = $row['SUBVILLAGENAMEUNI'];
       }
       $data[] = array( 
           'id' => $id
           ,'label' => $id.' - '.$name.' - '.$village
           ,'value' => $name
           ,'farmercode' => $farmercode
           ,'farmercategorycode' => $farmercategorycode
           ,'farmercategory' => $farmercategory
           ,'villagecode' => $villagecode
           ,'village' => $village
           ,'subvillagecode' => $subvillagecode
           ,'subvillage' => $subvillage
           );
   }
   //return json data
   echo json_encode($data);
?>