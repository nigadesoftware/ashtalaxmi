<?php
    //This is generated by Swapp Software Application on 28/05/2019 07:19:54 PM for PHP
    require_once("../info/phpsqlajax_dbinfo.php");
    require_once("../info/phpgetloginview.php");
    require_once("../info/routine.php");
    require_once("../info/marathi2english.php");
    $connection = swapp_connection();
    $searchTerm = $_GET['term'];
    $contractornameuni = $_GET['contractornameuni'];
    $isfarmer = $_GET['isfarmer'];
    $isplus=0;
    $dupfarmernameeng='';
    if ($isfarmer==1)
    {
    $query = "select farmercode,farmernameeng,villagenameeng from farmer f,village v 
    where f.villagecode=v.villagecode and upper(farmernameeng)='".strtoupper($searchTerm)."'";
        $result = oci_parse($connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $dupfarmernameeng = $row['FARMERCODE'].'-'.$row['FARMERNAMEENG'].', '.$row['VILLAGENAMEENG'];
        }
    }
        if (strpos($searchTerm,'+') > 0)
    {
        $isplus=1;
    }
    if ($pos=strrpos($searchTerm,' ')==false)
    {
        $contractornameuni = '';
    }
    else
    {
        if (($pos=strpos($searchTerm, ' ', strpos($searchTerm, ' ') + 1))==false)
        {
            $pos=strpos($contractornameuni, ' ');
            if ($pos!=false and $isplus==0)
            {
                $contractornameuni = substr($contractornameuni,0,$pos);
            }
            elseif ($pos!=false and $isplus==1)
            {
                $pos=strpos($contractornameuni, ' ', strpos($contractornameuni, ' ') + 1);
                if ($pos!=false)
                {
                    $contractornameuni = substr($contractornameuni,0,$pos);
                }
            }
        }
        else
        {
            $pos=strpos($contractornameuni, ' ', strpos($contractornameuni, ' ') + 1);
            if ($pos!=false and $isplus==0)
            {
                $contractornameuni = substr($contractornameuni,0,$pos);
            }

        }
    }

    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    elseif ((strlen($searchTerm)<3) and $searchTerm != '**')
    {
        exit;
    }
    elseif (substr($searchTerm,strlen($searchTerm)-1,1) == ' ')
    {
        exit;
    }
    if (strpos($searchTerm,'+') > 0)
    {
        $searchTerm=substr($searchTerm,0,strpos($searchTerm,'+'));
    }
    if ($isplus==0)
    {
        $query = "select nst_nasaka_db.englastwordnumber('".$searchTerm."') as wordnumber from dual";
        $result = oci_parse($connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $query1 = "select nst_nasaka_db.engword('".$searchTerm."',".$row['WORDNUMBER'].") as word from dual";
            $result1 = oci_parse($connection, $query1);
            $r = oci_execute($result1);
            if ($row1 = oci_fetch_array($result1,OCI_ASSOC+OCI_RETURN_NULLS))
            {
                if (strlen($row1['WORD'])<3)
                {
                    exit;
                }
                $query2 = "select T.NAME_UNI,T.NAME_ENG from nst_nasaka_db.name t
                where upper(trim(t.NAME_ENG)) like '".strtoupper($row1['WORD'])."%'";
                $result2 = oci_parse($connection, $query2);
                $r = oci_execute($result2);
                while ($row2 = oci_fetch_array($result2,OCI_ASSOC+OCI_RETURN_NULLS))
                {
                    //$q=strrpos($searchTerm," ");
                    $w=substr($searchTerm,0,strrpos($searchTerm," ")).' '.$row2['NAME_ENG'];
                    $data[] = array(  
                        'value' => trim($contractornameuni.' '.$row2['NAME_UNI']), 
                        'engvalue' => trim($w), 
                        'dupfarmernameeng' => $dupfarmernameeng
                    );
                }
            }
        }
    }
    else
    {
        $query2 = "select T.NAME_UNI,T.NAME_ENG from nst_nasaka_db.name t
        where isplus=1 order by isplussequence";
        $result2 = oci_parse($connection, $query2);
        $r = oci_execute($result2);
        while ($row2 = oci_fetch_array($result2,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $w=$searchTerm.$row2['NAME_ENG'];
            $data[] = array(  
                'value' => trim($contractornameuni.$row2['NAME_UNI']), 
                'engvalue' => trim($w),
                'dupfarmernameeng' => $dupfarmernameeng
            );
        }
    }
   //return json data
   echo json_encode($data);
?>