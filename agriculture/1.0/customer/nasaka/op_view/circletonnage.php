<?php
    //This is generated by Swapp Software Application on 06/06/2019 12:48:22 PM for PHP
    $connection=swapp_connection();
    $date=currentdate();
            //$date='02/03/2021';
            $dt=DateTime::createFromFormat('d/m/Y',$date)->format('d-M-Y');
           
    function swapp_database_settings(&$dbuser,&$host,&$dbname,&$pwd)
    {
        require("../info/phpsqlajax_dbinfo.php");
        // Opens a connection to a MySQL server
        $connection=mysqli_connect($hostname, $username, $password, $database);
        // Check connection
        if (mysqli_connect_errno())
        {
            echo "Communication Error";
        }
        mysqli_query($connection,'SET NAMES UTF8');
        $connection ->autocommit(FALSE);
        $query = "select * from databaseserver d,miscustomermodules c where d.miscustomerid=c.miscustomerid and d.miscustomerid=51170 and dbuser='nst_nasaka_agriculture'";
        $result = mysqli_query($connection,$query);
        if ($row = @mysqli_fetch_assoc($result))
        {
            $host = $row["host"];
            $dbname = $row["dbname"];
            $pwd = $row["dbpassword"];
        }
        $connection->close();
    }
    function swapp_connection()
    {
        require("../info/phpsqlajax_dbinfo.php");
        // Opens a connection to a MySQL server
        //$dbname = "scdbsnew";
        //$host = "192.168.1.254";
        //$dbname = "shivorclweb";
        //$dbname = "shivorcl";
        //$host = "localhost";
        //$host = "localhost";
        //$pwd="swapp123";
        //$pwd="swapp123";
        //$dbuser = "nst_agriculture";
        $dbuser = "nst_nasaka_agriculture";
        $host="NSSK_SERVER";
        //$host=gethostbyname(gethostname()).'';
        //$host = "192.168.1.100";
        $dbname="orcl";
        //$dbname="shivorcl";
        $pwd="swapp123";
        swapp_database_settings($dbuser,$host,$dbname,$pwd);
        $db= "(DESCRIPTION =
              (ADDRESS = (PROTOCOL = TCP)(HOST = ".$host.")(PORT = 1521))
              (CONNECT_DATA =
              (SERVER = DEDICATED)
                (SERVICE_NAME = ".$dbname.")
              )
           )";
        $conn = oci_connect($dbuser, $pwd, $db,"AL32UTF8");
        //$connection=mysqli_connect($hostname_rawmaterial, $username_rawmaterial, $password_rawmaterial, $database_rawmaterial);
        // Check connection
        if (!$conn)
        {
            $m = oci_error();
            echo $m['message'], "\n";
            exit;
        }
        else
        {
            //print "Connected to Oracle!";
        }
        return $conn;
    }
    function currentdate()
    {
        date_default_timezone_set("Asia/Kolkata");
        $dt = time();
        $dt = date('d/m/Y',$dt);
        date_default_timezone_set("UTC");
        return $dt;
    }

?>
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"></meta>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="../css/w3.css">
        <title>Contract</title>
        <link rel="stylesheet" href="../css/swapp123.css">
        <script src="../js/1.11.0/jquery.min.js">
         </script>
         <script>
            $(document).ready(function(){
             setInterval(function(){cache_clear()},3600000);
             });
             function cache_clear()
            {
             window.location.reload(true);
            }
        </script>
        <script>
                window.setTimeout(function () {
                window.location.reload();
        }, 30000);
        </script>
        <link rel="stylesheet" href="../css/ui/1.11.4/themes/smoothness/jquery-ui.css">
        <script src="../js/jquery-1.10.2.js"></script>
        <script src="../js/ui/1.11.4/jquery-ui.js"></script>

        <script type="text/javascript">
window.onload = function () {
	var chart = new CanvasJS.Chart("chartContainer",
	{
		theme: "light2",
		title:{
			text: "Circlewise Todate Crushing"
		},		
		data: [
		{       
			type: "pie",
			showInLegend: true,
			toolTipContent: "{y} - #percent %",
			legendText: "{indexLabel}",
			dataPoints: [
                <?php
                $query00 ="with today as (select circlecode,circlenameuni
                ,sum(netweight) netweight from(select c.circlecode,c.circlenameuni
                ,netweight
                from weightslip t,shift s,fieldslip f
                ,village v,circle c,farmer p,plantationheader h,plantationhangam g
                where t.shiftcode= s.shiftcode and 
                t.seasoncode=f.seasoncode and
                t.fieldslipnumber=f.fieldslipnumber
                and p.villagecode=v.villagecode
                and v.circlecode=c.circlecode
                and f.farmercode=p.farmercode
                and f.seasoncode=h.seasoncode
                and nvl(f.plotnumber,1)=h.plotnumber
                and h.plantationhangamcode=g.plantationhangamcode
                and t.weighmentdate='{$dt}' 
                and nvl(t.netweight,0)>0
                union all
                select c.circlecode,c.circlenameuni
                ,0  membenetweight
                from circle c
                )group by circlecode,circlenameuni)
                ,todate as (select circlecode,circlenameuni
                ,sum(netweight) netweight from(select c.circlecode,c.circlenameuni
                ,netweight
                from weightslip t,shift s,fieldslip f
                ,village v,circle c,farmer p,plantationheader h,plantationhangam g
                where t.shiftcode= s.shiftcode and 
                t.seasoncode=f.seasoncode and
                t.fieldslipnumber=f.fieldslipnumber
                and p.villagecode=v.villagecode
                and v.circlecode=c.circlecode
                and f.farmercode=p.farmercode
                and f.seasoncode=h.seasoncode
                and nvl(f.plotnumber,1)=h.plotnumber
                and h.plantationhangamcode=g.plantationhangamcode
                and t.weighmentdate<='{$dt}' 
                and t.seasoncode=20242025
                and nvl(t.netweight,0)>0
                union all
                select c.circlecode,c.circlenameuni
                ,0  membenetweight
                from circle c
                )group by circlecode,circlenameuni)
                ,summary  as (select sum(y.netweight) todaytonnage,sum(t.netweight) todatetonnage 
                from todate t,today y
                where t.circlecode=y.circlecode
                having sum(t.netweight)>0)
                ,daily as (select t.circlecode,t.circlenameuni
                ,sum(y.netweight) as todaytonnage
                ,sum(t.netweight) as todatetonnage
                from todate t,today y
                where t.circlecode=y.circlecode
                having sum(t.netweight)>0
                group by t.circlecode,t.circlenameuni)
                select d.circlecode,d.circlenameuni
                ,d.todaytonnage,case when s.todaytonnage<>0 then round(d.todaytonnage*100/s.todaytonnage,0) else 0 end todaycontriper
                ,d.todatetonnage,case when s.todatetonnage<>0 then round(d.todatetonnage*100/s.todatetonnage,0) else 0 end todatecontriper
                from daily d, summary s
                order by circlecode,circlenameuni";
    
               
                $result00 = oci_parse($connection, $query00);
                $r00 = oci_execute($result00);
                $i=0;
                while ($row00 = oci_fetch_array($result00,OCI_ASSOC+OCI_RETURN_NULLS))
                {
                    if ($i==0)
                        echo '{  y: '.$row00['TODATETONNAGE'].', indexLabel: "'.$row00['CIRCLENAMEUNI'].'" }';
                    else
                    echo ', {  y: '.$row00['TODATETONNAGE'].', indexLabel: "'.$row00['CIRCLENAMEUNI'].'" }';
                    $i++;
                }
                ?>
			]
		}
		]
	});
	chart.render();
}
</script>
<script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

    </head>
    <body>
        <nav "w3-container">
            <ul class="navbar">
                <li><a class="navbar" href="/index.php">Home</a><br/>
                <li><a class="navbar" href="../mis/entitymenu.php">Entity Menu</a><br/>
                <li><a class="navbar" href="/agriculture/1.0/customer/nasaka/op_view/shiftwisetonnage.php">Shiftwise Tonnage</a><br/>
                <li><a class="navbar" href="/agriculture/1.0/customer/nasaka/op_view/hourlytonnage.php">Hourly Tonnage</a><br/>
            </ul>
        </nav>
        <article class="w3-container">
    <?php
        echo '<section>';
        echo '<div id="chartContainer" style="height: 300px; width: 100%;"></div>';
        echo '<div style="width:1000px;float:left">';
        echo '<table border="0">';
        echo '<tr>';
        echo '<td></td>';
             echo '<div style="width:800px;float:left">';
            echo '<tr>';
            echo '<td><label class="thick">दिनांक : '.$date.' प्रोग्रेसिव्ह गटवार गळीत</label></td>';
            echo '</tr>';
            echo '<table border="0">';

            echo '<tr>';
            echo '<th width="20%" style="text-align:left;background:#FEC994;">विभाग</th>';
            echo '<th width="20%" style="text-align:right;background:#FEC994;">आज</th>';
            echo '<th width="20%" style="text-align:right;background:#FEC994;">आज %</th>';
            echo '<th width="20%" style="text-align:right;background:#FEC994;">आजअखेर</th>';
            echo '<th width="20%" style="text-align:right;background:#FEC994;">आजअखेर %</th>';
            echo '</tr>';
            
            $query0 ="with today as (select circlecode,circlenameuni
            ,sum(netweight) netweight from(select c.circlecode,c.circlenameuni
            ,netweight
            from weightslip t,shift s,fieldslip f
            ,village v,circle c,farmer p,plantationheader h,plantationhangam g
            where t.shiftcode= s.shiftcode and 
            t.seasoncode=f.seasoncode and
            t.fieldslipnumber=f.fieldslipnumber
            and p.villagecode=v.villagecode
            and v.circlecode=c.circlecode
            and f.farmercode=p.farmercode
            and f.seasoncode=h.seasoncode
            and nvl(f.plotnumber,1)=h.plotnumber
            and h.plantationhangamcode=g.plantationhangamcode
            and t.weighmentdate='{$dt}' 
            and nvl(t.netweight,0)>0
            union all
            select c.circlecode,c.circlenameuni
            ,0  membenetweight
            from circle c
            )group by circlecode,circlenameuni)
            ,todate as (select circlecode,circlenameuni
            ,sum(netweight) netweight from(select c.circlecode,c.circlenameuni
            ,netweight
            from weightslip t,shift s,fieldslip f
            ,village v,circle c,farmer p,plantationheader h,plantationhangam g
            where t.shiftcode= s.shiftcode and 
            t.seasoncode=f.seasoncode and
            t.fieldslipnumber=f.fieldslipnumber
            and p.villagecode=v.villagecode
            and v.circlecode=c.circlecode
            and f.farmercode=p.farmercode
            and f.seasoncode=h.seasoncode
            and nvl(f.plotnumber,1)=h.plotnumber
            and h.plantationhangamcode=g.plantationhangamcode
            and t.weighmentdate<='{$dt}' 
            and t.seasoncode=20242025
            and nvl(t.netweight,0)>0
            union all
            select c.circlecode,c.circlenameuni
            ,0  membenetweight
            from circle c
            )group by circlecode,circlenameuni)
            ,summary  as (select sum(y.netweight) todaytonnage,sum(t.netweight) todatetonnage 
            from todate t,today y
            where t.circlecode=y.circlecode
            having sum(t.netweight)>0)
            ,daily as (select t.circlecode,t.circlenameuni
            ,sum(y.netweight) as todaytonnage
            ,sum(t.netweight) as todatetonnage
            from todate t,today y
            where t.circlecode=y.circlecode
            having sum(t.netweight)>0
            group by t.circlecode,t.circlenameuni)
            select d.circlecode,d.circlenameuni
            ,d.todaytonnage,case when s.todaytonnage<>0 then round(d.todaytonnage*100/s.todaytonnage,0) else 0 end todaycontriper
            ,d.todatetonnage,case when s.todatetonnage<>0 then round(d.todatetonnage*100/s.todatetonnage,0) else 0 end todatecontriper
            from daily d, summary s
            order by circlecode,circlenameuni";

            $todaytonnage=0;
            $todatetonnage=0;
            $backgroundcolor1='#ECAFB4';
            $backgroundcolor2='#E1F8DC';
            $backgroundcolor3='#ACDDDE';
            $result0 = oci_parse($connection, $query0);
            $r0 = oci_execute($result0);
            while ($row0 = oci_fetch_array($result0,OCI_ASSOC+OCI_RETURN_NULLS))
            {
                    echo '<tr>';
                    echo '<td style="text-align:left;font-size:16px;background:'.$backgroundcolor1.';"><a >'.$row0['CIRCLENAMEUNI'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:'.$backgroundcolor2.';"><a >'.$row0['TODAYTONNAGE'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px"><a >'.$row0['TODAYCONTRIPER'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:'.$backgroundcolor3.'"><a >'.$row0['TODATETONNAGE'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px"><a >'.$row0['TODATECONTRIPER'].'</a></td>';
                    echo '</tr>';
                    

                $todaytonnage=$todaytonnage+$row0['TODAYTONNAGE'];
                $todatetonnage=$todatetonnage+$row0['TODATETONNAGE'];
                
            }
                $backgroundcolor='#FEC994';
                echo '<tr>';
                echo '<td style="text-align:left;font-size:16px;background:'.$backgroundcolor.';"><a ></a></td>';
                echo '<td style="text-align:right;font-size:16px;background:'.$backgroundcolor.';"><a >'.$todaytonnage.'</a></td>';
                echo '<td style="text-align:right;font-size:16px;background:'.$backgroundcolor.';"><a ></a></td>';
                echo '<td style="text-align:right;font-size:16px;background:'.$backgroundcolor.';"><a >'.$todatetonnage.'</a></td>';
                echo '<td style="text-align:right;font-size:16px;background:'.$backgroundcolor.'"><a ></a></td>';
                echo '</tr>';
            
            echo '</table>';
            echo '</div>';
            date_default_timezone_set('Asia/Kolkata');
                $date = date('d-m-Y h:i:s a');
                echo 'Report Date Time:'.$date;
            echo '<div style="width:800px;float:left">';
            echo '<table border="0">';
        echo '</section>';
    ?>
    </article>
    <footer>
    </footer>
    </body>
</html>

