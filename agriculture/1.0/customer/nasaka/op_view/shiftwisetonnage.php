<?php
    //This is generated by Swapp Software Application on 06/06/2019 12:48:22 PM for PHP
    $connection=swapp_connection();
    function swapp_database_settings(&$dbuser,&$host,&$dbname,&$pwd)
    {
        require("../info/phpsqlajax_dbinfo.php");
        // Opens a connection to a MySQL server
        $connection=mysqli_connect($hostname, $username, $password, $database);
        // Check connection
        if (mysqli_connect_errno())
        {
            echo "Communication Error";
        }
        mysqli_query($connection,'SET NAMES UTF8');
        $connection ->autocommit(FALSE);
        $query = "select * from databaseserver d,miscustomermodules c where d.miscustomerid=c.miscustomerid and d.miscustomerid=51170 and dbuser='nst_nasaka_agriculture'";
        $result = mysqli_query($connection,$query);
        if ($row = @mysqli_fetch_assoc($result))
        {
            $host = $row["host"];
            $dbname = $row["dbname"];
            $pwd = $row["dbpassword"];
        }
        $connection->close();
    }
    function swapp_connection()
    {
        require("../info/phpsqlajax_dbinfo.php");
        // Opens a connection to a MySQL server
        //$dbname = "scdbsnew";
        //$host = "192.168.1.254";
        //$dbname = "shivorclweb";
        //$dbname = "shivorcl";
        //$host = "localhost";
        //$host = "localhost";
        //$pwd="swapp123";
        //$pwd="swapp123";
        //$dbuser = "nst_agriculture";
        $dbuser = "nst_nasaka_agriculture";
        $host="NSSK_SERVER";
        //$host=gethostbyname(gethostname()).'';
        //$host = "192.168.1.100";
        $dbname="orcl";
        //$dbname="shivorcl";
        $pwd="swapp123";
        swapp_database_settings($dbuser,$host,$dbname,$pwd);
        $db= "(DESCRIPTION =
              (ADDRESS = (PROTOCOL = TCP)(HOST = ".$host.")(PORT = 1521))
              (CONNECT_DATA =
              (SERVER = DEDICATED)
                (SERVICE_NAME = ".$dbname.")
              )
           )";
        $conn = oci_connect($dbuser, $pwd, $db,"AL32UTF8");
        //$connection=mysqli_connect($hostname_rawmaterial, $username_rawmaterial, $password_rawmaterial, $database_rawmaterial);
        // Check connection
        if (!$conn)
        {
            $m = oci_error();
            echo $m['message'], "\n";
            exit;
        }
        else
        {
            //print "Connected to Oracle!";
        }
        return $conn;
    }
    function currentdate()
    {
        date_default_timezone_set("Asia/Kolkata");
        $dt = time();
        $dt = date('d/m/Y',$dt);
        date_default_timezone_set("UTC");
        return $dt;
    }

?>
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"></meta>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="../css/w3.css">
        <title>Contract</title>
        <link rel="stylesheet" href="../css/swapp123.css">
        <script src="../js/1.11.0/jquery.min.js">
         </script>
         <script>
            $(document).ready(function(){
             setInterval(function(){cache_clear()},3600000);
             });
             function cache_clear()
            {
             window.location.reload(true);
            }
        </script>
        <script>
                window.setTimeout(function () {
                window.location.reload();
        }, 30000);
        </script>
        <link rel="stylesheet" href="../css/ui/1.11.4/themes/smoothness/jquery-ui.css">
        <script src="../js/jquery-1.10.2.js"></script>
        <script src="../js/ui/1.11.4/jquery-ui.js"></script>
    </head>
    <body>
        <nav "w3-container">
            <ul class="navbar">
                <li><a class="navbar" href="/index.php">Home</a><br/>
                <li><a class="navbar" href="../mis/entitymenu.php">Entity Menu</a><br/>
                <li><a class="navbar" href="/agriculture/1.0/customer/nasaka/op_view/hourlytonnage.php">Hourly Tonnage</a><br/>
                <li><a class="navbar" href="/agriculture/1.0/customer/nasaka/op_view/circletonnage.php">Circlewise Tonnage</a><br/>
            </ul>
        </nav>
        <article class="w3-container">
    <?php
        echo '<section>';
        echo '<div style="width:800px;float:left">';
        echo '<table border="0">';
        echo '<tr>';
        echo '<td></td>';
            $date=currentdate();
            //$date='02/03/2021';
            $dt2=DateTime::createFromFormat('d/m/Y',$date)->format('d-M-Y');
            $dt1=date('d-M-Y', strtotime($dt2. ' - 1 days'));
            $dt=$dt1;
            $i=0;
            while ($i<2)
            {
                echo '<div style="width:800px;float:left">';
                //echo '<tr>';
                //echo '<td><label class="thick">दिनांक : '.$date.' शिफ्टनिहाय गळीत</label></td>';
                //echo '</tr>';
                echo '<table border="0">';
                $wtdt=DateTime::createFromFormat('d-M-Y',$dt)->format('d/m/Y');
                $query1 = "select getcrushingday(20242025,'".$dt."') crushingday from dual";
                $result1 = oci_parse($connection, $query1);
                $r1 = oci_execute($result1);
                if ($row1 = oci_fetch_array($result1,OCI_RETURN_NULLS))
                {
                    $crushingday=$row1['CRUSHINGDAY'];
                }
                echo '<tr>';
                echo '<th width="10%" style="text-align:left;background:#FEC994;">'.$wtdt.' CrDy: '.$crushingday.'</th>';
                echo '<th width="5%" style="text-align:right;background:#FEC994;">शिफ्ट 1 संख्या</th>';
                echo '<th width="10%" style="text-align:right;background:#FEC994;">शिफ्ट 1 टनेज</th>';
                echo '<th width="5%" style="text-align:right;background:#FEC994;">शिफ्ट 2 संख्या</th>';
                echo '<th width="10%" style="text-align:right;background:#FEC994;">शिफ्ट 2 टनेज</th>';
                echo '<th width="5%" style="text-align:right;background:#FEC994;">शिफ्ट 3 संख्या</th>';
                echo '<th width="10%" style="text-align:right;background:#FEC994;">शिफ्ट 3 टनेज</th>';
                echo '<th width="10%" style="text-align:right;background:#FEC994;">‌आज एकूण संख्या</th>';
                echo '<th width="10%" style="text-align:right;background:#FEC994;">‌आज एकूण</th>';
                echo '<th width="15%" style="text-align:right;background:#FEC994;">आजअखेर एकूण</th>';
                echo '</tr>';
                
                $query0 ="select weighmentdate,vehiclecategorycode,vehiclecategorynameuni
                ,sum(first_tonnage) first_tonnage,sum(second_tonnage) second_tonnage,sum(third_tonnage) third_tonnage,sum(total_tonnage) total_tonnage
                ,sum(first_cnt) first_cnt,sum(second_cnt) second_cnt,sum(third_cnt) third_cnt
                ,sum(first_cnt)+sum(second_cnt)+sum(third_cnt) total_cnt
                from (
                select t.weighmentdate,t.vehiclecategorycode,v.vehiclecategorynameuni
                ,t.first_tonnage,t.second_tonnage,t.third_tonnage,0 total_tonnage
                ,t.first_cnt,t.second_cnt,t.third_cnt
                                from SHIFTTONNAGE t,vehiclecategory v
                                where t.vehiclecategorycode=v.vehiclecategorycode(+) 
                                and t.weighmentdate='{$dt}' 
                union all
                select  to_date('{$dt}') weighmentdate,t.vehiclecategorycode,v.vehiclecategorynameuni
                ,0 first_tonnage,0 second_tonnage,0 third_tonnage,sum(t.total_tonnage) total_tonnage
                ,0 first_cnt,0 second_cnt,0 third_cnt
                                from SHIFTTONNAGE t,vehiclecategory v
                                where t.vehiclecategorycode=v.vehiclecategorycode(+) 
                                and t.weighmentdate<='{$dt}' 
                                and t.seasoncode=20242025
                group by t.vehiclecategorycode,v.vehiclecategorynameuni
                ) group by weighmentdate,vehiclecategorycode,vehiclecategorynameuni
                order by weighmentdate,vehiclecategorycode,vehiclecategorynameuni
                ";
                $shift1tonnage=0;
                $shift2tonnage=0;
                $shift3tonnage=0;
                $totaltonnage=0;
                $shift1cnt=0;
                $shift2cnt=0;
                $shift3cnt=0;
                $totalcnt=0;
                $result0 = oci_parse($connection, $query0);
                $r0 = oci_execute($result0);
                while ($row0 = oci_fetch_array($result0,OCI_ASSOC+OCI_RETURN_NULLS))
                {
                    $backgroundcolor="green";
                    echo '<tr>';
                    echo '<td style="text-align:left;font-size:16px;background:#ECAFB4;"><a >'.($row0['VEHICLECATEGORYNAMEUNI']==''?'हार्वेस्टर':$row0['VEHICLECATEGORYNAMEUNI']).'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:white;"><a >'.$row0['FIRST_CNT'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:white;"><a >'.$row0['FIRST_TONNAGE'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#E1F8DC;"><a >'.$row0['SECOND_CNT'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#E1F8DC;"><a >'.$row0['SECOND_TONNAGE'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:white"><a >'.$row0['THIRD_CNT'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:white"><a >'.$row0['THIRD_TONNAGE'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:white"><a >'.$row0['TOTAL_CNT'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#ACDDDE;"><a >'.($row0['FIRST_TONNAGE']+$row0['SECOND_TONNAGE']+$row0['THIRD_TONNAGE']).'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#FFFFE0"><a >'.$row0['TOTAL_TONNAGE'].'</a></td>';
                    echo '</tr>';
                    $shift1tonnage=$shift1tonnage+$row0['FIRST_TONNAGE'];
                    $shift2tonnage=$shift2tonnage+$row0['SECOND_TONNAGE'];
                    $shift3tonnage=$shift3tonnage+$row0['THIRD_TONNAGE'];
                    $totaltonnage=$totaltonnage+$row0['TOTAL_TONNAGE'];
                    $shift1cnt=$shift1cnt+$row0['FIRST_CNT'];
                    $shift2cnt=$shift2cnt+$row0['SECOND_CNT'];
                    $shift3cnt=$shift3cnt+$row0['THIRD_CNT'];
                    $totalcnt=$totalcnt+$row0['TOTAL_CNT'];
                }
                    echo '<tr>';
                    echo '<td style="text-align:left;font-size:16px;background:#A9BA9D;"><a >एकूण</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#A9BA9D;"><a >'.$shift1cnt.'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#A9BA9D;"><a >'.$shift1tonnage.'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#A9BA9D;"><a >'.$shift2cnt.'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#A9BA9D;"><a >'.$shift2tonnage.'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#A9BA9D;"><a >'.$shift3cnt.'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#A9BA9D;"><a >'.$shift3tonnage.'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#A9BA9D;"><a >'.$totalcnt.'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#A9BA9D;"><a >'.($shift1tonnage+$shift2tonnage+$shift3tonnage).'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#A9BA9D;"><a >'.$totaltonnage.'</a></td>';
                    echo '</tr>';
                echo '</table>';
                echo '</div>';
                echo '<div style="width:800px;float:left">';
                $dt=date('d-M-Y', strtotime($dt. ' + 1 days'));
                $i=$i+1;
            }
            echo '<div style="width:800px;float:left">';
                //echo '<tr>';
                //echo '<td><label class="thick">दिनांक : '.$date.' शिफ्टनिहाय गळीत</label></td>';
                //echo '</tr>';
                echo '<table border="0">';
                $wtdt=DateTime::createFromFormat('d-M-Y',$dt)->format('d/m/Y');
                echo '<tr>';
                echo '<th width="10%" style="text-align:left;background:#FEC994;">यार्ड शिल्लक</th>';
                echo '<th width="10%" style="text-align:right;background:#FEC994;">ट्रक</th>';
                echo '<th width="15%" style="text-align:right;background:#FEC994;">ट्रॅक्टर</th>';
                echo '<th width="15%" style="text-align:right;background:#FEC994;">ट्रॅक्टर टायर</th>';
                echo '<th width="15%" style="text-align:right;background:#FEC994;">बैलगाडी</th>';
                echo '<th width="15%" style="text-align:right;background:#FEC994;">हार्वेस्टर</th>';
                echo '<th width="15%" style="text-align:right;background:#FEC994;">एकूण</th>';
                echo '</tr>';
                
                $query0 ="select sum(case when vehiclecategorycode = 3 then 1 else 0 end)  bull_cnt
                ,sum(case when vehiclecategorycode = 3 then 1 else 0 end)  bull_ton
                ,sum(case when vehiclecategorycode = 4 then 1 else 0 end)  jugad_cnt
                ,sum(case when vehiclecategorycode = 4 then 0 else 0 end)  jugad_ton
                ,sum(case when servicetrhrcategorycode<>11 and vehiclecategorycode = 1 then 1 else 0 end)  truck_cnt
                ,sum(case when servicetrhrcategorycode<>11 and vehiclecategorycode = 1 then 0 else 0 end)  truck_ton
                ,sum(case when servicetrhrcategorycode<>11 and vehiclecategorycode = 2 then 1 else 0 end)  tractor_cnt
                ,sum(case when servicetrhrcategorycode<>11 and vehiclecategorycode = 2 then 0 else 0 end) tractor_ton
                ,sum(case when servicetrhrcategorycode=11 then 1 else 0 end)  harvester_cnt
                ,sum(case when servicetrhrcategorycode=11 then 0 else 0 end) harvester_ton
                ,sum(case when 1=1 then 1 else 0 end) tot_CNT
                ,0 tot_ton 
                from (select t.seasoncode,t.fieldslipnumber,t.fieldslipdate,c.servicetrhrcategorycode,t.vehiclecategorycode
                    from FIELDSLIP t,subcontractor s,contractorcontract c,vehicle v
                    where t.seasoncode=v.seasoncode
                    and t.vehiclecode=v.vehiclecode
                    and c.seasoncode=s.seasoncode and c.contractcode=s.contractcode
                    and s.seasoncode=v.seasoncode and s.subcontractorcode=v.subcontractorcode
                    and t.flag=0
                    union all
                    select t.seasoncode,t.fieldslipnumber,t.fieldslipdate,c.servicetrhrcategorycode,t.vehiclecategorycode
                    from FIELDSLIP t,subcontractor s,contractorcontract c,tyregadi v
                    where t.seasoncode=v.seasoncode
                    and t.tyregadicode=v.tyregadicode
                    and t.flag=0
                    and c.seasoncode=s.seasoncode and c.contractcode=s.contractcode
                    and s.seasoncode=v.seasoncode and s.subcontractorcode=v.subcontractorcode
                    )fs
                where fs.seasoncode=20242025 and trunc(fieldslipdate)<='".$dt."' 
                and (fs.seasoncode,fs.fieldslipnumber) in (
                select f.seasoncode,f.fieldslipnumber
                from fieldslip f
                where f.seasoncode=20242025
                minus
                select w.seasoncode,w.fieldslipnumber
                from weightslip w
                where fs.seasoncode=20242025 and weighmentdate<='".$dt."')";
                $shift1tonnage=0;
                $shift2tonnage=0;
                $shift3tonnage=0;
                $totaltonnage=0;
                $result0 = oci_parse($connection, $query0);
                $r0 = oci_execute($result0);
                while ($row0 = oci_fetch_array($result0,OCI_ASSOC+OCI_RETURN_NULLS))
                {
                    $backgroundcolor="green";
                    echo '<tr>';
                    echo '<td style="text-align:left;font-size:16px;background:#ECAFB4;"><a ></a></td>';
                    echo '<td style="text-align:left;font-size:16px;background:#ECAFB4;"><a >'.$row0['TRUCK_CNT'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:white;"><a >'.$row0['TRACTOR_CNT'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#E1F8DC;"><a >'.$row0['JUGAD_CNT'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#E1F8DC;"><a >'.$row0['BULL_CNT'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:white"><a >'.$row0['HARVESTER_CNT'].'</a></td>';
                    echo '<td style="text-align:right;font-size:16px;background:#ACDDDE;"><a >'.$row0['TOT_CNT'].'</a></td>';
                    echo '</tr>';
                }
                echo '</table>';
                echo '</div>';
                date_default_timezone_set('Asia/Kolkata');
                $date = date('d-m-Y h:i:s a');
                echo 'Report Date Time:'.$date;
                    echo '<table border="0">';
        echo '</section>';
    ?>
    </article>
    <footer>
    </footer>
    </body>
</html>

