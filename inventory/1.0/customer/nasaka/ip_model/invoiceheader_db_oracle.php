<?php
//This is generated by Nigade Software Technologies (opc) Private Limited 12/12/2020 10:34:19 am for PHP
require_once("../swappbase/formbase.php");
class invoiceheader extends swappform
{
    Public $transactionnumber;
    Public $transactiondate;
    Public $financialyear;
    Public $invoicenumber;
    Public $invoiceprefixnumber;
    Public $suppliercode;
    Public $suppliercodetextcombo;
    Public $supplierinvoicenumber;
    Public $supplierinvoicedate;
    Public $supplierinvoicetotal;
    Public $grossitemtotal;
    Public $grossgsttotal;
    Public $grossamount;
    Public $transportation;
    Public $netamount;
    Public $roundoff;
    Public $tcsamount;
    Public $grossdiscountamount;
    Public $grossdiscountedamount;
    Public $grosspackingforwardingamount;
    Public $grosstaxableamount;
    Public $vouchertransactionnumber;
    public function __construct(&$connection)
    {
     		 parent::__construct($connection);
         $this->transactionnumber='';
         $this->transactionnumbertextcombo='';
         $this->financialyear='';
         $this->financialyeartextcombo='';
         $this->invoicenumber='';
         $this->invoicenumbertextcombo='';
         $this->invoiceprefixnumber='';
         $this->invoiceprefixnumbertextcombo='';
         $this->suppliercode='';
         $this->suppliercodetextcombo='';
         $this->supplierinvoicenumber='';
         $this->supplierinvoicenumbertextcombo='';
         $this->supplierinvoicedate='';
         $this->supplierinvoicedatetextcombo='';
         $this->supplierinvoicetotal='';
         $this->supplierinvoicetotaltextcombo='';
         $this->grossitemtotal='';
         $this->grossitemtotaltextcombo='';
         $this->transportation='';
         $this->transportationtextcombo='';
         $this->netamount='';
         $this->netamounttextcombo='';
	   }
    public function entryvalidation()
    {
    		$this->start_validation();
        //$this->checkrequired($this->financialyear,'Financial Year ','आर्थिक वर्ष');
        //$this->checkrequired($this->invoicenumber,'Invoice Number ','बील क्रमांक');
        //$this->checkrequired($this->invoiceprefixnumber,'Invoice Prefix Number ','बील उपसर्ग क्रमांक');
        
        $this->checkrequired($this->transactiondate,'Trasnaction date ','व्यवहार तारीख');
        $this->checkrequired($this->suppliercode,'Supplier Code ','पुरवठाकर्ता कोड');
        $this->checkrequired($this->supplierinvoicenumber,'Supplier Invoice Number ','पुरवठादार बील क्रमांक');
        $this->checkrequired($this->supplierinvoicedate,'Supplier Invoice date ','पुरवठादार बील तारीख');
        $this->checkrequired($this->supplierinvoicetotal,'Supplier Invoice Total ','पुरवठादार बील रक्कम');
        //$this->checkrequired($this->grossitemtotal,'Gross Item Total ','एकूण आयटम');
        //$this->checkrequired($this->transportation,'Transportation ','वाहतूक');
        //$this->checkrequired($this->gstpercent,'GST %','जीएसटी%');
        $this->end_validation();
        return $this->invalidid;
	  }
    private function datavalidation()
    {
        $this->start_validation();
    		$this->invalidid=0;
    		$this->invalidmessagetext='Validated';
    		$this->end_validation();
    		return $this->invalidid;
    }
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
	    if ($this->transactionnumber == '')
        {
            $query = "select nvl(max(transactionnumber),0)+1 as transactionnumber from invoiceheader";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->transactionnumber = $row["TRANSACTIONNUMBER"];
        }
        if ($this->invoicenumber == '')
        {
            $query = "select nvl(max(invoicenumber),0)+1 as invoicenumber 
            from invoiceheader where financialyear=".$_SESSION['yearperiodcode'];
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->invoicenumber = $row["INVOICENUMBER"];
            $this->invoiceprefixnumber = $row["INVOICENUMBER"];
        } 
        
        if ($this->transactiondate!='')
        {
            $this->transactiondate = DateTime::createFromFormat('d/m/Y',$this->transactiondate)->format('d-M-Y');
        }
        if ($this->supplierinvoicedate!='')
        {
            $this->supplierinvoicedate = DateTime::createFromFormat('d/m/Y',$this->supplierinvoicedate)->format('d-M-Y');
        }
        $this->financialyear = $_SESSION['yearperiodcode'];

        $query = "
            insert into invoiceheader(
            transactionnumber
            ,transactiondate
            ,financialyear
            ,invoicenumber
            ,invoiceprefixnumber
            ,suppliercode
            ,supplierinvoicenumber
            ,supplierinvoicedate
            ,supplierinvoicetotal
            ,grossitemtotal
            ,transportation
            ,netamount
            ,gstpercent
            ,roundoff
            ,tcsamount
            ,grossdiscountamount
            ,grossdiscountedamount
            ,grosspackingforwardingamount
            ,grosstaxableamount
	        )
	        values (
            ".$this->invl($this->transactionnumber,true)."
            ,".$this->invl($this->transactiondate,false)."
            ,".$this->invl($this->financialyear,true)."
            ,".$this->invl($this->invoicenumber,true)."
            ,".$this->invl($this->invoiceprefixnumber,true)."
            ,".$this->invl($this->suppliercode,true,true)."
            ,".$this->invl($this->supplierinvoicenumber,true)."
            ,".$this->invl($this->supplierinvoicedate,false)."
            ,".$this->invl($this->supplierinvoicetotal,true)."
            ,".$this->invl($this->grossitemtotal,true)."
            ,".$this->invl($this->transportation,true)."
            ,".$this->invl($this->netamount,true)."
            ,".$this->invl($this->gstpercent,true)."
            ,".$this->invl($this->roundoff,true)."
            ,".$this->invl($this->tcsamount,true)."
            ,".$this->invl($this->grossdiscountamount,true)."
            ,".$this->invl($this->grossdiscountedamount,true)."
            ,".$this->invl($this->grosspackingforwardingamount,true)."
            ,".$this->invl($this->grosstaxableamount,true)."
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='';
		    if ($this->transactiondate!='' and $this->transactiondate!=0)
		    {
                if ($this->transactiondate!='')
                {
                    $this->transactiondate = DateTime::createFromFormat('d/m/Y',$this->transactiondate)->format('d-M-Y');
                } 
                if ($cond=='')
			      {
				        $cond="t.transactiondate = '".$this->transactionnumber."'";
			       }
			       else
			       {
				         $cond=$cond." and t.transactiondate = '".$this->transactionnumber."'";
			       }
		    }
		    if ($this->suppliercode!='' and $this->suppliercode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.suppliercode = ".$this->suppliercode;
			       }
			       else
			       {
				         $cond=$cond." and t.suppliercode = ".$this->suppliercode;
			       }
		    }
            if ($this->supplierinvoicenumber!='' and $this->supplierinvoicenumber!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.supplierinvoicenumber = ".$this->supplierinvoicenumber;
			       }
			       else
			       {
				         $cond=$cond." and t.supplierinvoicenumber = ".$this->supplierinvoicenumber;
			       }
		    }
            if ($this->invoicenumber!='' and $this->invoicenumber!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.invoicenumber = ".$this->invoicenumber;
			       }
			       else
			       {
				         $cond=$cond." and t.invoicenumber = ".$this->invoicenumber;
			       }
		    }
            if ($this->supplierinvoicedate!='' and $this->supplierinvoicedate!=0)
		    {
                if ($this->supplierinvoicedate!='')
                {
                    $this->supplierinvoicedate = DateTime::createFromFormat('d/m/Y',$this->supplierinvoicedate)->format('d-M-Y');
                } 
                if ($cond=='')
			      {
				        $cond="t.supplierinvoicedate = '".$this->supplierinvoicedate."'";
			       }
			       else
			       {
				         $cond=$cond." and t.supplierinvoicedate = '".$this->supplierinvoicedate."'";
			       }
		    }
        if ($cond!='')
		    {
		        $query = "select t.*,s.suppliernameeng
                ,(select v.totaldebit from purchaseaccountbridge p,nst_nasaka_finance.voucherheader v
                where p.accounttransactionnumber=v.transactionnumber and p.purchasetransactionnumber=t.transactionnumber) debit
                ,(select v.totalcredit from purchaseaccountbridge p,nst_nasaka_finance.voucherheader v
                where p.accounttransactionnumber=v.transactionnumber and p.purchasetransactionnumber=t.transactionnumber) credit
                from invoiceheader t,supplier s 
                where t.financialyear=".$_SESSION['yearperiodcode']." and t.suppliercode=s.suppliercode and ".$cond." order by transactionnumber";
			    $result = oci_parse($this->connection, $query);
                $r = oci_execute($result);
			    return $result;
		     }
		     else
		     {
		        $query = "select t.*,s.suppliernameeng 
                ,(select v.totaldebit from purchaseaccountbridge p,nst_nasaka_finance.voucherheader v
                where p.accounttransactionnumber=v.transactionnumber and p.purchasetransactionnumber=t.transactionnumber) debit
                ,(select v.totalcredit from purchaseaccountbridge p,nst_nasaka_finance.voucherheader v
                where p.accounttransactionnumber=v.transactionnumber and p.purchasetransactionnumber=t.transactionnumber) credit
                from invoiceheader t,supplier s
                where t.financialyear=".$_SESSION['yearperiodcode']." and t.suppliercode=s.suppliercode
                order by transactionnumber";
			    $result = oci_parse($this->connection, $query);
                $r = oci_execute($result);
			    return $result;
		     }
	  }
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        if ($this->transactiondate!='')
        {
            $this->transactiondate = DateTime::createFromFormat('d/m/Y',$this->transactiondate)->format('d-M-Y');
        }
        $this->supplierinvoicedate = DateTime::createFromFormat('d/m/Y',$this->supplierinvoicedate)->format('d-M-Y');
        $query = "
        update invoiceheader set 
        financialyear = ".$this->invl($this->financialyear,true,true)."
        ,transactiondate = ".$this->invl($this->transactiondate,false)."
        ,invoicenumber = ".$this->invl($this->invoicenumber,true,true)."
        ,invoiceprefixnumber = ".$this->invl($this->invoiceprefixnumber,true,true)."
        ,suppliercode = ".$this->invl($this->suppliercode,true,true)."
        ,supplierinvoicenumber = ".$this->invl($this->supplierinvoicenumber,true,true)."
        ,supplierinvoicedate =".$this->invl($this->supplierinvoicedate,false)."
        ,supplierinvoicetotal = ".$this->invl($this->supplierinvoicetotal,true,true)."
        ,grossitemtotal = ".$this->invl($this->grossitemtotal,true,true)."
        ,transportation = ".$this->invl($this->transportation,true,true)."
        ,netamount = ".$this->invl($this->netamount,true,true)."
        ,gstpercent = ".$this->invl($this->gstpercent,true,true)."
        ,roundoff = ".$this->invl($this->roundoff,true,true)."
        ,tcsamount= ".$this->invl($this->tcsamount,true,true)."
        ,grossdiscountamount= ".$this->invl($this->grossdiscountamount,true,true)."
        ,grossdiscountedamount= ".$this->invl($this->grossdiscountedamount,true,true)."
        ,grosspackingforwardingamount= ".$this->invl($this->grosspackingforwardingamount,true,true)."
        ,grosstaxableamount= ".$this->invl($this->grosstaxableamount,true,true)."
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->supplierinvoicedate = DateTime::createFromFormat('d/m/Y',$this->supplierinvoicedate)->format('d-M-Y');
        $query = "
        delete from invoiceheader
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
             return 1;
             exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        transactionnumber
        ,to_char(transactiondate,'dd/mm/yyyy') transactiondate
        ,financialyear
        ,invoicenumber
        ,invoiceprefixnumber
        ,suppliercode
        ,supplierinvoicenumber
        ,supplierinvoicedate
        ,supplierinvoicetotal
        ,grossitemtotal
        ,grossdiscountedamount
        ,grosspackingforwardingamount
        ,grosstaxableamount
        ,grossgsttotal
        ,grossamount
        ,transportation
        ,netamount
        ,gstpercent
        ,roundoff
        ,tcsamount
        ,purchaseordertransnumber
        ,(select a.accounttransactionnumber from INVOICEHEADER t,purchaseaccountbridge a
        where t.transactionnumber=a.purchasetransactionnumber and t.transactionnumber=$this->transactionnumber) vouchertransactionnumber
        from invoiceheader where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->transactionnumber = $row['TRANSACTIONNUMBER'];
                $this->transactiondate = $row['TRANSACTIONDATE'];
                $this->financialyear = $row['FINANCIALYEAR'];
                $this->invoicenumber = $row['INVOICENUMBER'];
                $this->invoiceprefixnumber = $row['INVOICEPREFIXNUMBER'];
                $this->suppliercode = $row['SUPPLIERCODE'];
                $this->supplierinvoicenumber = $row['SUPPLIERINVOICENUMBER'];
                $this->supplierinvoicedate = DateTime::createFromFormat('d-M-y',$row['SUPPLIERINVOICEDATE'])->format('d/m/Y');
                $this->supplierinvoicetotal = $row['SUPPLIERINVOICETOTAL'];
                $this->grossitemtotal = $row['GROSSITEMTOTAL'];
                $this->grossdiscountedamount = $row['GROSSDISCOUNTEDAMOUNT'];
                $this->grosspackingforwardingamount = $row['GROSSPACKINGFORWARDINGAMOUNT'];
                $this->grosstaxableamount = $row['GROSSTAXABLEAMOUNT'];
                $this->grossgsttotal = $row['GROSSGSTTOTAL'];
                $this->grossamount = $row['GROSSAMOUNT'];
                $this->transportation = $row['TRANSPORTATION'];
                $this->netamount = $row['NETAMOUNT'];
                $this->suppliercodetextcombo = $this->textcomboname($connection=$this->connection,$table='SUPPLIER',$datafield='SUPPLIERCODE',$datafieldvalue=$row['SUPPLIERCODE'],$engfield='SUPPLIERNAMEENG',$unicodefield='SUPPLIERNAMEUNI');
                $this->purchaseordertransnumber = $row['PURCHASEORDERTRANSNUMBER'];
                $this->purchaseordertransnumbertextcombo = $this->textcomboname($connection=$this->connection,$table='PURCHESORDERHEADER',$datafield='TRANSACTIONNUMBER',$datafieldvalue=$row['PURCHASEORDERTRANSNUMBER'],$engfield='PURCHESORDERNUMBER',$unicodefield='PURCHESORDERNUMBER');
                $this->gstpercent = $row['GSTPERCENT'];
                $this->roundoff = $row['ROUNDOFF'];
                $this->tcsamount = $row['TCSAMOUNT'];
                $this->vouchertransactionnumber = $row['VOUCHERTRANSACTIONNUMBER'];
                $this->found=true;
                return true;
        }
        else
        {
        return false;
        }
    }
    Public function voucherposting($action)
    {
        $ret=1;
        if ($action==1)
        {
            if ($this->invoicenumber == '')
            {
                $query = "select nvl(max(invoicenumber),0)+1 as invoicenumber 
                from invoiceheader where financialyear=".$_SESSION['yearperiodcode'];
                $result = oci_parse($this->connection, $query);
                $r = oci_execute($result);
                $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
                $this->invoicenumber = $row["INVOICENUMBER"];
                $this->invoiceprefixnumber = $row["INVOICENUMBER"];
                $query = "
                update invoiceheader 
                set 
                invoicenumber = ".$this->invl($this->invoicenumber,true,true)."
                ,invoiceprefixnumber = ".$this->invl($this->invoiceprefixnumber,true,true)."
                where 
                transactionnumber = ".$this->invl($this->transactionnumber,true)."
                ";
                $result = oci_parse($this->connection, $query);
                if (oci_execute($result,OCI_NO_AUTO_COMMIT))
                {
                    $ret=1;
                }
                else
                {
                    $ret=0;
                }
            }
        }   
         if ($ret==1)
        {
            $transactionnumber=$this->transactionnumber;
            $act=$action;
            $sql = 'BEGIN purchase_bill_posting(:p_purchasetransactionnumber,:p_action,:p_ret); END;';
            $result = oci_parse($this->connection,$sql);
            oci_bind_by_name($result,':p_purchasetransactionnumber',$transactionnumber,20,SQLT_INT);
            oci_bind_by_name($result,':p_action',$act,10,SQLT_INT);
            oci_bind_by_name($result,':p_ret',$p_ret,10,SQLT_INT);
            oci_execute($result);
            if ($p_ret==1)
            {
                return 1;
            }
            else
            {
                return 0;
            }
        }
        else
        {
            return 0;
        }
        exit;
    }

    public function fetchgrnall()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "       select d.transactionnumber
        ,h.goodsreceiptnotenumber,d.serialnumber,to_char(h.goodreceiptdate,'dd/mm/yyyy') goodreceiptdate
        from invoicegrndetail d,goodsreceiptheader h
        where d.grntransactionnumber=h.transactionnumber
        and d.transactionnumber = ".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        return $result;
    }

    public function fetchall()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select t.serialnumber,i.itemcode,i.itemnameeng,t.quantity,t.rate,t.amount,t.gstrate,t.totalgstamount,t.itemtotal
        from INVOICEITEMDETAIL t,item i
        where t.itemcode=i.itemcode
        and t.transactionnumber= ".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        return $result;
    }
}
?>

