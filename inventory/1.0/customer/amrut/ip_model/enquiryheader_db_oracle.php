<?php
//This is generated by Nigade Software Technologies (opc) Private Limited 12/12/2020 10:10:11 am for PHP
require_once("../swappbase/formbase.php");
class enquiryheader extends swappform
{
    Public $transactionnumber;
    Public $financialyear;
    Public $enquirynumber;
    Public $enquirydate;
    Public $enquiryprefixnumber;
    Public $departmentcode;
    public $purpose;
    public function __construct(&$connection)
    {
     		 parent::__construct($connection);
         $this->transactionnumber='';
         $this->transactionnumbertextcombo='';
         $this->financialyear='';
         $this->financialyeartextcombo='';
         $this->enquirynumber='';
         $this->enquirynumbertextcombo='';
         $this->enquirydate='';
         $this->enquirydatetextcombo='';
         $this->enquiryprefixnumber='';
         $this->enquiryprefixnumbertextcombo='';
         $this->departmentcode='';
         $this->departmentcodetextcombo='';
         $this->purpose='';
	   }
    public function entryvalidation()
    {
    		$this->start_validation();
        //$this->checkrequired($this->financialyear,'Financial Year','आर्थिक वर्ष');
        //$this->checkrequired($this->enquirynumber,'Enquiry Number','चौकशी क्रमांक');
        $this->checkrequired($this->enquirydate,'Enquiry Date','चौकशीची तारीख');
        //$this->checkrequired($this->enquiryprefixnumber,'Enquiry Prefix Number','चौकशी उपसर्ग क्रमांक');
        $this->checkrequired($this->departmentcode,'Department','विभाग');
        $this->end_validation();
        return $this->invalidid;
	  }
    private function datavalidation()
    {
        $this->start_validation();
    		$this->invalidid=0;
    		$this->invalidmessagetext='Validated';
    		$this->end_validation();
    		return $this->invalidid;
    }
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->financialyear = $_SESSION['yearperiodcode'];
	    if ($this->transactionnumber == '')
        {
            $query = "select nvl(max(transactionnumber),0)+1 as transactionnumber from enquiryheader";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->transactionnumber = $row["TRANSACTIONNUMBER"];
        }
        if ($this->financialyear != '')
        {
            $query = "select nvl(max(enquirynumber),0)+1 as enquirynumber 
            from enquiryheader 
            where financialyear=".$this->financialyear;
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->enquirynumber = $row["ENQUIRYNUMBER"];
            $this->enquiryprefixnumber = $row["ENQUIRYNUMBER"];
        }
        if ($this->enquirydate!='')
        {
            $this->enquirydate = DateTime::createFromFormat('d/m/Y',$this->enquirydate)->format('d-M-Y');
        }
        
        $query = "
            insert into enquiryheader(
            transactionnumber
            ,financialyear
            ,enquirynumber
            ,enquirydate
            ,enquiryprefixnumber
            ,departmentcode
            ,purpose
	        )
	        values (
            ".$this->invl($this->transactionnumber,true)."
            ,".$this->invl($this->financialyear,true)."
            ,".$this->invl($this->enquirynumber,true)."
            ,".$this->invl($this->enquirydate,false)."
            ,".$this->invl($this->enquiryprefixnumber,false)."
            ,".$this->invl($this->departmentcode,true)."
            ,".$this->invl($this->purpose,false)."
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='';
            if ($this->enquirynumber!='' and $this->enquirynumber!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.enquirynumber = ".$this->enquirynumber;
			       }
			       else
			       {
				         $cond=$cond." and t.enquirynumber = ".$this->enquirynumber;
			       }
		    }
            if ($cond!='')
            {
                $cond=$cond." and t.financialyear = ".$_SESSION['yearperiodcode'];
                $query = "select t.* from enquiryheader t where ".$cond." order by transactionnumber";
			      $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
			      return $result;
		     }
		     else
		     {
                $cond=$cond." t.financialyear = ".$_SESSION['yearperiodcode'];
		         $query = "select t.* from enquiryheader t where ".$cond." order by transactionnumber";
			       $result = oci_parse($this->connection, $query);
             $r = oci_execute($result);
			       return $result;
		     }
	  }
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->enquirydate = DateTime::createFromFormat('d/m/Y',$this->enquirydate)->format('d-M-Y');
        $query = "
        update enquiryheader set 
        financialyear = ".$this->invl($this->financialyear,true,true)."
        ,enquirynumber = ".$this->invl($this->enquirynumber,true,true)."
        ,enquirydate =".$this->invl($this->enquirydate,false)."
        ,enquiryprefixnumber =".$this->invl($this->enquiryprefixnumber,false)."
        ,departmentcode = ".$this->invl($this->departmentcode,true,true)."
        ,purpose = ".$this->invl($this->purpose,false)."
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->enquirydate = DateTime::createFromFormat('d/m/Y',$this->enquirydate)->format('d-M-Y');
        $query = "
        delete from enquiryheader
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
             return 1;
             exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        transactionnumber
        ,financialyear
        ,enquirynumber
        ,enquirydate
        ,enquiryprefixnumber
        ,departmentcode
        ,purpose
        from enquiryheader where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->transactionnumber = $row['TRANSACTIONNUMBER'];
                $this->financialyear = $row['FINANCIALYEAR'];
                $this->enquirynumber = $row['ENQUIRYNUMBER'];
                $this->enquirydate = DateTime::createFromFormat('d-M-y',$row['ENQUIRYDATE'])->format('d/m/Y');
                $this->enquiryprefixnumber = $row['ENQUIRYPREFIXNUMBER'];
                $this->departmentcode = $row['DEPARTMENTCODE'];
                $this->departmentcodetextcombo = $this->textcomboname($connection=$this->connection,$table='DEPARTMENT',$datafield='DEPARTMENTCODE',$datafieldvalue=$row['DEPARTMENTCODE'],$engfield='DEPARTMENTNAMEENG',$unicodefield='DEPARTMENTNAMEUNI');
                $this->purpose = $row['PURPOSE'];
                $this->found=true;
                return true;
        }
        else
        {
        return false;
        }
    }
    

    public function fetchallrequisition()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select r.transactionnumber,h.requisitionnumber,to_char(h.requisitiondate,'dd/mm/yyyy')  requisitiondate
        ,r.serialnumber
        ,s.sectionnameeng
        ,s.sectionnameuni
        from enquiryrequisitiondetail r,requisitionheader h,section s 
        where r.requisitiontransaction=h.transactionnumber and h.sectioncode=s.sectioncode
        and r.transactionnumber = ".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        return $result;
    }

    public function fetchallenquirysupplier()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select h.transactionnumber
        ,r.serialnumber
        ,s.suppliercode
        ,s.suppliernameeng
        ,s.suppliernameuni
        from enquirysupplierdetail r,enquiryrequisitiondetail d,requisitionheader h,supplier s 
        where r.transactionnumber=d.transactionnumber 
        and d.requisitiontransaction=h.transactionnumber and r.suppliercode=s.suppliercode
        and r.transactionnumber=".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        return $result;
    }

    public function fetchallsupplier()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select h.transactionnumber
        ,r.serialnumber
        ,s.suppliercode
        ,s.suppliernameeng
        ,s.suppliernameuni
        ,q.transactionnumber qtransactionnumber
        ,(select sum(d.discountedrate*quotedquantity)
        from quotationitemdetail d
        where d.transactionnumber=q.transactionnumber) suppliervalue
        ,(select min(suppliervalue) 
        from (
        select h.transactionnumber
                ,r.serialnumber
                ,s.suppliercode
                ,s.suppliernameeng
                ,s.suppliernameuni
                ,q.transactionnumber qtransactionnumber
                ,(select sum(d.discountedrate*quotedquantity)
                from quotationitemdetail d
                where d.transactionnumber=q.transactionnumber) suppliervalue
                from enquiryrequisitiondetail e,enquirysupplierdetail r,requisitionheader h,supplier s 
                ,quotationheader q
                where e.transactionnumber=r.transactionnumber 
                and e.requisitiontransaction=h.transactionnumber and r.suppliercode=s.suppliercode
                and r.transactionnumber=q.enqtransactionnumber and r.suppliercode=q.suppliercode
                and r.transactionnumber = ".$this->invl($this->transactionnumber,true).")) minsuppliervalue
        from enquiryrequisitiondetail e, enquirysupplierdetail r,requisitionheader h,supplier s 
        ,quotationheader q
        where e.transactionnumber=r.transactionnumber 
        and e.requisitiontransaction=h.transactionnumber and r.suppliercode=s.suppliercode
        and r.transactionnumber=q.enqtransactionnumber and r.suppliercode=q.suppliercode
        and r.transactionnumber = ".$this->invl($this->transactionnumber,true);
        
        $result = oci_parse($this->connection, $query);
        return $result;
    }
    public function fetchquotationterm($qtransactionnumber)
    {
        $query="select t.deliveryplace,t.deliveryperiod,t.paymentterms,t.gst,t.pandf,t.remark 
        from QUOTATIONHEADER t
        where t.transactionnumber={$qtransactionnumber}";
        $result = oci_parse($this->connection, $query);
        return $result;

    }
    public function fetchallitem()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "
        select s.itemcode
        ,s.itemnameeng
        ,r.enquiryquantity
        ,u.unitnameeng
        from enquiryitemdetail r,enquiryheader h,item s,unit u 
        where r.transactionnumber=h.transactionnumber 
        and r.itemcode=s.itemcode
        and s.unitcode=u.unitcode
        and h.transactionnumber = ".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        return $result;
    }

    public function fetchquotationitem($transactionnumber,$suppliercode,$itemcode)
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select t.transactionnumber,d.quotationrate,d.discountedrate,d.discountpercent,d.make,d.serialnumber
        ,(select nvl(min(d.discountedrate),9999999999) 
        from quotationheader t,quotationitemdetail d
        where t.transactionnumber=d.transactionnumber 
        and t.enqtransactionnumber=".$this->invl($transactionnumber,true)." 
        and d.itemcode=".$itemcode.") mindiscountedrate
        from quotationheader t,quotationitemdetail d
        where t.transactionnumber=d.transactionnumber 
        and t.enqtransactionnumber=".$this->invl($transactionnumber,true).
        " and t.suppliercode=".$suppliercode."
        and d.itemcode=".$itemcode;
        $result = oci_parse($this->connection, $query);
        return $result;
    }

    public function fetchenquirycostvalue()
    {
        $query="select sum(enquiryquantity*discountedrate) costvalue
        from (
        select e.itemcode,e.enquiryquantity,min(i.discountedrate) discountedrate
                from quotationheader q,quotationitemdetail i,enquiryitemdetail e
                where q.transactionnumber=i.transactionnumber
                and q.enqtransactionnumber=e.transactionnumber 
                and i.itemcode=e.itemcode
                and e.transactionnumber = {$this->transactionnumber}
                group by e.itemcode,e.enquiryquantity)";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            return $row['COSTVALUE'];
        }      
        else
            return 0;
    }
    public function fetchdepartment($sectioncode)
    {
        $query="select d.departmentnameeng
        from section s,department d
        where s.departmentcode=d.departmentcode 
        and  s.sectioncode=".$sectioncode;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            return $row['DEPARTMENTNAMEENG'];
        }      
        else
            return '';
    }
}
?>

