<?php
//This is generated by Nigade Software Technologies (opc) Private Limited 12/12/2020 10:11:25 am for PHP
require_once("../swappbase/formbase.php");
class quotationheader extends swappform
{
    Public $transactionnumber;
    Public $financialyear;
    Public $enqtransactionnumber;
    Public $suppliercode;
    Public $quotationnumber;
    Public $quotationdate;
    Public $employeecode;
    Public $employeecodetextcombo;
    public $discountpercent;
    public $deliveryplace;
    public $deliveryperiod;
    public $paymentterms;
    public $gst;
    public $pandf;
    public $remark;

    public function __construct(&$connection)
    {
     		 parent::__construct($connection);
         $this->transactionnumber='';
         $this->transactionnumbertextcombo='';
         $this->financialyear='';
         $this->financialyeartextcombo='';
         $this->enqtransactionnumber='';
         $this->enqtransactionnumbertextcombo='';
         $this->suppliercode='';
         $this->suppliercodetextcombo='';
         $this->quotationnumber='';
         $this->quotationnumbertextcombo='';
         $this->quotationdate='';
         $this->quotationdatetextcombo='';
         $this->employeecode='';
         $this->employeecodetextcombo='';
	   }
    public function entryvalidation()
    {
    		$this->start_validation();
        //$this->checkrequired($this->financialyear,'Financial Year','आर्थिक वर्ष');
        $this->checkrequired($this->enqtransactionnumber,'Enquiry Transaction Number','चौकशी व्यवहार क्रमांक');
        $this->checkrequired($this->suppliercode,'Supplier Code','पुरवठाकर्ता कोड');
        $this->checkrequired($this->quotationnumber,'Quotation Number','कोटेशन क्रमांक');
        $this->checkrequired($this->quotationdate,'Quotation Date','कोटेशन तारीख');
        $this->checkrequired($this->employeecode,'Employee Code','कर्मचारी कोड');
        $this->end_validation();
        return $this->invalidid;
	  }
    private function datavalidation()
    {
        $this->start_validation();
    		$this->invalidid=0;
    		$this->invalidmessagetext='Validated';
    		$this->end_validation();
    		return $this->invalidid;
    }
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
	    //if ($this->transactionnumber == '')
        //{
            $query = "select nvl(max(transactionnumber),0)+1 as transactionnumber from quotationheader";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->transactionnumber = $row["TRANSACTIONNUMBER"];
            $this->financialyear = $_SESSION['yearperiodcode'];
        //}
        if ($this->quotationdate!='')
        {
            $this->quotationdate = DateTime::createFromFormat('d/m/Y',$this->quotationdate)->format('d-M-Y');
        }
        $query = "
            insert into quotationheader(
            transactionnumber
            ,financialyear
            ,enqtransactionnumber
            ,suppliercode
            ,quotationnumber
            ,quotationdate
            ,employeecode
            ,discountpercent
            ,deliveryplace
            ,deliveryperiod
            ,paymentterms
            ,gst
            ,pandf
            ,remark
	        )
	        values (
            ".$this->invl($this->transactionnumber,true)."
            ,".$this->invl($this->financialyear,true)."
            ,".$this->invl($this->enqtransactionnumber,true)."
            ,".$this->invl($this->suppliercode,true)."
            ,".$this->invl($this->quotationnumber,false)."
            ,".$this->invl($this->quotationdate,false)."
            ,".$this->invl($this->employeecode,true,true)."
            ,".$this->invl($this->discountpercent,true,true)."
            ,".$this->invl($this->deliveryplace,false)."
            ,".$this->invl($this->deliveryperiod,false)."
            ,".$this->invl($this->paymentterms,false)."
            ,".$this->invl($this->gst,false)."
            ,".$this->invl($this->pandf,false)."
            ,".$this->invl($this->remark,false)."
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            $query1 = "insert into quotationitemdetail
                (transactionnumber, serialnumber, enquirydetailserialnumber, itemcode, quotedquantity, itemspecification)
                select ".$this->transactionnumber.",h.serialnumber,h.serialnumber, h.itemcode,h.enquiryquantity,h.itemspecification
                 from enquiryitemdetail h,item i 
                 where h.transactionnumber=".$this->enqtransactionnumber." and h.itemcode=i.itemcode
                 order by h.serialnumber";
            $result1 = oci_parse($this->connection, $query1);
            if (oci_execute($result1,OCI_NO_AUTO_COMMIT))
            {     
                return 1;
                exit;
            }
            else
            {
                return 0;
                exit;
            }    
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	{
        $this->dataoperationmode = operationmode::Select;
        $cond='';
        if ($this->quotationnumber!='' and $this->quotationnumber!=0)
        {
            if ($cond=='')
            {
                $cond="t.quotationnumber = ".$this->quotationnumber;
            }
            else
            {
                $cond=$cond." and t.quotationnumber = ".$this->quotationnumber;
            }
        }
        if ($this->quotationdate!='')
        {
            $quotationdate = DateTime::createFromFormat('d/m/Y',$this->quotationdate)->format('d-M-Y');  
            if ($cond=='')
            {
                $cond="t.quotationdate = '".$quotationdate."'";
            }
            else
            {
                $cond=$cond." and t.quotationdate = '".$quotationdate."'";
            }
        }
        if ($this->suppliercode!='' and $this->suppliercode!=0)
        {
                if ($cond=='')
                {
                    $cond="t.suppliercode = ".$this->suppliercode;
                }
                else
                {
                        $cond=$cond." and t.suppliercode = ".$this->suppliercode;
                }
        }
        if ($this->employeecode!='' and $this->employeecode!=0)
        {
                if ($cond=='')
                {
                    $cond="t.employeecode = ".$this->employeecode;
                }
                else
                {
                        $cond=$cond." and t.employeecode = ".$this->employeecode;
                }
        }
        if ($cond!='')
        {
            $query = "select t.*,s.suppliernameeng,h.enquirynumber from quotationheader t,enquiryheader h,supplier s
            where t.enqtransactionnumber=h.transactionnumber
            and t.suppliercode=s.suppliercode and ".$cond." 
            order by t.transactionnumber";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            return $result;
        }
        else
        {
            $query = "select t.*,s.suppliernameeng,h.enquirynumber from quotationheader t,enquiryheader h,supplier s
            where t.enqtransactionnumber=h.transactionnumber
            and t.suppliercode=s.suppliercode order by t.transactionnumber";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            return $result;
        }
	}
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->quotationdate = DateTime::createFromFormat('d/m/Y',$this->quotationdate)->format('d-M-Y');
        $query = "
        update quotationheader set 
        financialyear = ".$this->invl($this->financialyear,true,true)."
        ,enqtransactionnumber = ".$this->invl($this->enqtransactionnumber,true,true)."
        ,suppliercode = ".$this->invl($this->suppliercode,true,true)."
        ,quotationnumber =".$this->invl($this->quotationnumber,false)."
        ,quotationdate =".$this->invl($this->quotationdate,false)."
        ,employeecode = ".$this->invl($this->employeecode,true,true)."
        ,discountpercent= ".$this->invl($this->discountpercent,true,true)."
        ,deliveryplace= ".$this->invl($this->deliveryplace,false)."
        ,deliveryperiod= ".$this->invl($this->deliveryperiod,false)."
        ,paymentterms= ".$this->invl($this->paymentterms,false)."
        ,gst= ".$this->invl($this->gst,false)."
        ,pandf= ".$this->invl($this->pandf,false)."
        ,remark= ".$this->invl($this->remark,false)."
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        /* if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        } */
        //$this->quotationdate = DateTime::createFromFormat('d/m/Y',$this->quotationdate)->format('d-M-Y');
        $query = "
        delete from quotationheader
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
             return 1;
             exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        transactionnumber
        ,financialyear
        ,enqtransactionnumber
        ,suppliercode
        ,quotationnumber
        ,quotationdate
        ,employeecode
        ,discountpercent
        ,deliveryplace
        ,deliveryperiod
        ,paymentterms
        ,gst
        ,pandf
        ,remark
        from quotationheader where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->transactionnumber = $row['TRANSACTIONNUMBER'];
                $this->financialyear = $row['FINANCIALYEAR'];
                $this->enqtransactionnumber = $row['ENQTRANSACTIONNUMBER'];
                $this->enqtransactionnumbertextcombo = $this->textcomboname($connection=$this->connection,$table='ENQUIRYHEADER',$datafield='TRANSACTIONNUMBER',$datafieldvalue=$row['ENQTRANSACTIONNUMBER'],$engfield='ENQUIRYNUMBER',$unicodefield='ENQUIRYNUMBER');
                $this->suppliercode = $row['SUPPLIERCODE'];
                $this->suppliercodetextcombo = $this->textcomboname($connection=$this->connection,$table='SUPPLIER',$datafield='SUPPLIERCODE',$datafieldvalue=$row['SUPPLIERCODE'],$engfield='SUPPLIERNAMEENG',$unicodefield='SUPPLIERNAMEUNI');
                $this->employeecodetextcombo = $this->textcomboname($connection=$this->connection,$table='EMPLOYEE',$datafield='EMPLOYEECODE',$datafieldvalue=$row['EMPLOYEECODE'],$engfield='EMPLOYEENAMEENG',$unicodefield='EMPLOYEENAMEUNI');
                $this->quotationnumber = $row['QUOTATIONNUMBER'];
                $this->quotationdate = DateTime::createFromFormat('d-M-y',$row['QUOTATIONDATE'])->format('d/m/Y');
                $this->employeecode = $row['EMPLOYEECODE'];
                $this->employeecodetextcombo = $this->textcomboname($connection=$this->connection,$table='EMPLOYEE',$datafield='EMPLOYEECODE',$datafieldvalue=$row['EMPLOYEECODE'],$engfield='EMPLOYEENAMEENG',$unicodefield='EMPLOYEENAMEUNI');
                $this->discountpercent =$row['DISCOUNTPERCENT'];
                $this->deliveryplace =$row['DELIVERYPLACE'];
                $this->deliveryperiod =$row['DELIVERYPERIOD'];
                $this->paymentterms =$row['PAYMENTTERMS'];
                $this->gst =$row['GST'];
                $this->pandf =$row['PANDF'];
                $this->remark =$row['REMARK'];
                $this->found=true;
                return true;
        }
        else
        {
        return false;
        }
    }
    public function fetchall()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select t.serialnumber,t.itemcode,i.itemnameeng,t.quotedquantity,t.quotationrate,t.discountedrate,t.make,t.itemspecification
        from QUOTATIONITEMDETAIL t,item i
        where t.itemcode=i.itemcode
        and t.transactionnumber=".$this->transactionnumber;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        return $result;
    }
    
    Public function effectivediscountrate()
    {
            $sql = 'BEGIN effectivediscountrate(:p_transactionnumber); END;';
            $result = oci_parse($this->connection,$sql);
            oci_bind_by_name($result,':p_transactionnumber',$this->transactionnumber,20,SQLT_INT);
            $ret=oci_execute($result);
            return $ret;
    }
}
?>

