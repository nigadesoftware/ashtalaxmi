<?php
    //This is generated by Swapp Software Application on 11/11/2018 06:54:27 PM for PHP
    require("../info/phpgetloginview.php");
    include("../info/ncryptdcrypt.php");
    require("../info/routine.php");
    include_once("../ip_model/voucherheader_db_oracle.php");
    include_once("../ip_model/voucherdetail_db_oracle.php");
    $connection=swapp_connection();
    $voucherheader1 = new voucherheader($connection);
    $voucherheader1->transactionnumber = $_POST["transactionnumber"];
    $voucherheader1->legalentitycode = $_POST["legalentitycode"];
    $voucherheader1->yearperiodcode = $_POST["yearperiodcode"];
    $voucherheader1->vouchersubtypecode = $_POST["vouchersubtypecode"];
    $voucherheader1->vouchernumber = $_POST["vouchernumber"];
    $voucherheader1->vouchernumberbasevalue = $_POST["vouchernumberbasevalue"];
    $voucherheader1->vouchernumberprefixsufix = $_POST["vouchernumberprefixsufix"];
    $voucherheader1->voucherdate = $_POST["voucherdate"];
    $voucherheader1->description = $_POST["description"];
    $voucherheader1->narration = $_POST["narration"];
    $voucherheader1->vouchernumberseriesid = $_POST["vouchernumberseriesid"];
    $voucherheader1->applicationnumber = $_POST["applicationnumber"];
    $flag_de = fnDecrypt($_GET['flag']);
  switch ($_POST['btn'])
  {
    case 'Add':
      $ret = $voucherheader1->insert();
      if ($ret==1)
      {
        oci_commit($connection);
        //$vouchersubtypecode_en = fnEncrypt($voucherheader1->vouchersubtypecode);
        //echo '<span class="w3-container" style="background-color:#0a0;color:#ff8;text-align:left;">Voucher Header is added successfully</span></br>';
        //echo '<a href="../ip_view/voucherdetail.php?transactionnumber='.$transactionnumber_en.'">New Voucher Detail</a></br>';
        $transactionnumber_en = fnEncrypt($voucherheader1->transactionnumber);
        if (in_array($voucherheader1->vouchersubtypecode,array(2,3,6,8,9)))
        {
            header("Location: ../ip_view/voucherchequedddetail.php?transactionnumber='.$transactionnumber_en.'");
        }
        else
        {
            header("Location: ../ip_view/voucherdetail.php?transactionnumber='.$transactionnumber_en.'");
        }
      }
      else
      {
        oci_rollback($connection);
        echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
        echo '<button onclick="history.go(-1);">Back </button>';
      }
      break;
    case 'Change':
      $voucherheader1->transactionnumber = $_POST["transactionnumber"];
      $ret = $voucherheader1->update();
      if ($ret==1)
      {
        oci_commit($connection);
        $transactionnumber_en = fnEncrypt($voucherheader1->transactionnumber);
        $vouchersubtypecode_en = fnEncrypt($voucherheader1->vouchersubtypecode);
        $flag_en = fnEncrypt('Display');
        echo '<span class="w3-container" style="background-color:#0a0;color:#ff8;text-align:left;">Voucher Header is Updated successfully</span></br>';  
        echo '<a href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'&transactionnumber='.$transactionnumber_en.'&flag='.$flag_en.'">Find Voucher Header</a></br>';
      }
      else
      {
        oci_rollback($connection);
        echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
	    echo '<button onclick="history.go(-1);">Back </button>';
      }
		break;
	case 'Display':
      $voucherheader1->transactionnumber = $_POST["transactionnumber"];
      $vouchersubtypecode_en= fnEncrypt($voucherheader1->vouchersubtypecode);
      include("../mis/list.php");
      echo '<nav "w3-container">';
      echo '    <ul class="navbar">';
      echo '    <li><a class="navbar" href="../mis/entitymenu.php">Entity Menu</a><br/>';
      $flag_en = fnEncrypt('Query');
      echo '    <li><a class="navbar" href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'">New Voucher Header</a>';
      echo '    <li><a class="navbar" href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'&flag='.$flag_en.'">Find Voucher Header</a>';
      echo '<li><a style="color:#f48" class="navbar" href="../../../../../sqlproc/logout.php">Log Out</a><br/>';
      echo '    </ul>';
      echo '  </nav>';
      echo '<section>';
      echo '<table border="0" >';
      echo '<tr>';
      echo '<td><label for="" class="thick">List of Voucher Header</label></td>';
      echo '</tr>';
			$result1 = $voucherheader1->display();
			if ($voucherheader1->Get_invalidid()==0)
			{
        $vouchersubtypecode_en= fnEncrypt($voucherheader1->vouchersubtypecode);
        $flag_en = fnEncrypt('Display');
				while ($row1 = oci_fetch_array($result1,OCI_ASSOC+OCI_RETURN_NULLS))
				{
                    if ($row1['VOUCHERDATE']!='')
                    {
                        $voucherdate = DateTime::createFromFormat('d-M-y',$row1['VOUCHERDATE'])->format('d/m/Y');
                    }
                    $voucherstatus = $row1['APPROVALSTATUS'];
                    if ($row1['VOUCHERNUMBER']=='')
                    {
                        if ($row1['TOTALDEBIT']==$row1['TOTALCREDIT'] and $row1['TOTALDEBIT']>0)
                        {
                            $approvalstatusdesc = 'Pending for Generation';
                        }
                        else
                        {
                            $approvalstatusdesc = 'Incomplete Voucher';
                        }
                    }
                    elseif ($row1['APPROVALSTATUS']=='1')
                    {
                        $approvalstatusdesc = 'Pending for First Stage Approval';
                    }
                    elseif ($row1['APPROVALSTATUS']=='2')
                    {
                        $approvalstatusdesc = 'Pending for Second Stage Approval';
                    }
                    elseif ($row1['APPROVALSTATUS']=='3')
                    {
                        $approvalstatusdesc = 'Pending for Third Stage Approval';
                    }
                    elseif ($row1['APPROVALSTATUS']=='4')
                    {
                        $approvalstatusdesc = 'Pending for Fourth Stage Approval';
                    }
                    elseif ($row1['APPROVALSTATUS']=='9')
                    {
                        $approvalstatusdesc = 'Voucher Approved';
                    }
                    elseif ($row1['APPROVALSTATUS']=='-1')
                    {
                        $approvalstatusdesc = 'First Stage Disapproval for '.$row1['DISAPPROVALREASON'];
                    }
                    elseif ($row1['APPROVALSTATUS']=='-2')
                    {
                        $approvalstatusdesc = 'Second Stage Disapproval for '.$row1['DISAPPROVALREASON'];
                    }
                    elseif ($row1['APPROVALSTATUS']=='-3')
                    {
                        $approvalstatusdesc = 'Third Stage Disapproval for '.$row1['DISAPPROVALREASON'];
                    }
                    elseif ($row1['APPROVALSTATUS']=='-4')
                    {
                        $approvalstatusdesc = 'Fourth Stage Disapproval for '.$row1['DISAPPROVALREASON'];
                    }
                    if ($_SESSION['lng']=='English')
					{
                        echo '<tr>';
						echo '<td><a href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'&transactionnumber='.fnEncrypt($row1['TRANSACTIONNUMBER']).'&flag='.$flag_en.'">'.$row1['TRANSACTIONNUMBER'].' '.$row1['VOUCHENUMBERPREFIXSUFIX'].'-'.$voucherdate.'-'.$row1['VOUCHERNUMBERPREFIXSUFIX'].'-'.$row1['TOTALDEBIT'].'-'.$row1['TOTALCREDIT'].'-'.$approvalstatusdesc.' '.$row1['DESCR_ENG'].'</td>';
                        echo '</tr>';
					}
					else
					{
                        echo '<tr>';
                        if ($row1['APPROVALSTATUS']==9)
                        {
                            echo '<td style="color:green;"><a href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'&transactionnumber='.fnEncrypt($row1['TRANSACTIONNUMBER']).'&flag='.$flag_en.'">'.$row1['TRANSACTIONNUMBER'].' '.$row1['VOUCHENUMBERPREFIXSUFIX'].'-'.$voucherdate.'-'.$row1['VOUCHERNUMBERPREFIXSUFIX'].'-'.$row1['TOTALDEBIT'].'-'.$row1['TOTALCREDIT'].'-'.$approvalstatusdesc.' '.$row1['DESCR_ENG'].'</td>';
                        }
                        elseif ($row1['APPROVALSTATUS']<0)
                        {
                            echo '<td style="color:red;"><a href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'&transactionnumber='.fnEncrypt($row1['TRANSACTIONNUMBER']).'&flag='.$flag_en.'">'.$row1['TRANSACTIONNUMBER'].' '.$row1['VOUCHENUMBERPREFIXSUFIX'].'-'.$voucherdate.'-'.$row1['VOUCHERNUMBERPREFIXSUFIX'].'-'.$row1['TOTALDEBIT'].'-'.$row1['TOTALCREDIT'].'-'.$approvalstatusdesc.' '.$row1['DESCR_ENG'].'</td>';
                        }
                        elseif ($row1['APPROVALSTATUS']>0 and $row1['APPROVALSTATUS']<9)
                        {
                            echo '<td style="color:black;"><a href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'&transactionnumber='.fnEncrypt($row1['TRANSACTIONNUMBER']).'&flag='.$flag_en.'">'.$row1['TRANSACTIONNUMBER'].' '.$row1['VOUCHENUMBERPREFIXSUFIX'].'-'.$voucherdate.'-'.$row1['VOUCHERNUMBERPREFIXSUFIX'].'-'.$row1['TOTALDEBIT'].'-'.$row1['TOTALCREDIT'].'-'.$approvalstatusdesc.' '.$row1['DESCR_ENG'].'</td>';
                        }
                        else
                        {
                            if ($row1['TOTALDEBIT']==$row1['TOTALCREDIT'] and $row1['TOTALDEBIT']>0)
                            {
                                echo '<td style="color:blue;"><a href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'&transactionnumber='.fnEncrypt($row1['TRANSACTIONNUMBER']).'&flag='.$flag_en.'">'.$row1['TRANSACTIONNUMBER'].' '.$row1['VOUCHENUMBERPREFIXSUFIX'].'-'.$voucherdate.'-'.$row1['VOUCHERNUMBERPREFIXSUFIX'].'-'.$row1['TOTALDEBIT'].'-'.$row1['TOTALCREDIT'].'-'.$approvalstatusdesc.' '.$row1['DESCR_ENG'].'</td>';
                            }
                            else
                            {
                                echo '<td style="color:violet;"><a href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'&transactionnumber='.fnEncrypt($row1['TRANSACTIONNUMBER']).'&flag='.$flag_en.'">'.$row1['TRANSACTIONNUMBER'].' '.$row1['VOUCHENUMBERPREFIXSUFIX'].'-'.$voucherdate.'-'.$row1['VOUCHERNUMBERPREFIXSUFIX'].'-'.$row1['TOTALDEBIT'].'-'.$row1['TOTALCREDIT'].'-'.$approvalstatusdesc.' '.$row1['DESCR_ENG'].'</td>';
                            }
                        }
                        echo '</tr>';
					}
				}	
			}
			else
			{
				echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
			}
			break;
	case 'Delete':
      $voucherdetail1 = new voucherdetail($connection);
      $voucherdetail1->transactionnumber = $_POST["transactionnumber"];
      $voucherchequedddetail1 = new voucherdetail($connection);
      $voucherchequedddetail1->transactionnumber = $_POST["transactionnumber"];
      $voucherheader1->transactionnumber = $_POST["transactionnumber"];
			$ret1 = $voucherdetail1->deleteall();
      if ($ret1 == 1)
			{
          $ret2 = $voucherchequedddetail1->deleteall();
          if ($ret2 == 1)
			    {
              $ret = $voucherheader1->delete();
              if ($ret == 1)
              {
                  oci_commit($connection);
                  $vouchersubtypecode_en= fnEncrypt($voucherheader1->vouchersubtypecode);
                  $flag_en = fnEncrypt('Query');
                  echo '<span class="w3-container" style="background-color:#0a0;color:#ff8;text-align:left;">Voucher Header is Deleted Successfully</span></br>';
                  echo '<a href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'&flag='.$flag_en.'">Find Voucher Header</a></br>';
              }
              else
              {
                  oci_rollback($connection);
                  echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
                  echo '<a href="../ip_view/voucherheader.php">Find voucherheader</a></br>';
                  echo '<button onclick="history.go(-1);">Back </button>';
              }
          }
          else
          {
              oci_rollback($connection);
              echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
              echo '<a href="../ip_view/voucherheader.php">Find voucherheader</a></br>';
              echo '<button onclick="history.go(-1);">Back </button>';
          }
      }
      else
      {
          oci_rollback($connection);
          echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
          echo '<a href="../ip_view/voucherheader.php">Find voucherheader</a></br>';
          echo '<button onclick="history.go(-1);">Back </button>';
      }
	break;
    case 'Generate':
		  $voucherheader1->transactionnumber = $_POST["transactionnumber"];
      if ($voucherheader1->fetch())
      {
          $ret = $voucherheader1->generatevouchernumber();
          if ($ret==1)
          {
              $ret = $voucherheader1->updatenextapprovalstage(1);
              if ($ret==1)
              {
                  oci_commit($connection);
                  $transactionnumber_en = fnEncrypt($voucherheader1->transactionnumber);
                  $vouchersubtypecode_en= fnEncrypt($voucherheader1->vouchersubtypecode);
                  $flag_en = fnEncrypt('Display');
                  echo '<span class="w3-container" style="background-color:#0a0;color:#ff8;text-align:left;">Voucher is generated successfully</span></br>';  
                  echo '<a href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'&transactionnumber='.$transactionnumber_en.'&flag='.$flag_en.'">Find Voucher Header</a></br>';
              }
              else
              {
                  oci_rollback($connection);
                  echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
                  echo '<button onclick="history.go(-1);">Back </button>';
              }
          }
          else
          {
              oci_rollback($connection);
              echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
              echo '<button onclick="history.go(-1);">Back </button>';
          }
      }
      break;
      case 'Approval':
            $voucherheader1->transactionnumber = $_POST["transactionnumber"];
            if ($voucherheader1->vouchersubtypecode==5)
            {
                if ($voucherheader1->voucherdate!='')
                {
                    $ret = $voucherheader1->update();
                    if ($ret==1)
                    {
                        oci_commit($connection);
                    }
                }
            }
            if ($_SESSION['responsibilitycode']==683297845124527)
            {
                $actioncode=4;
            }
            elseif ($_SESSION['responsibilitycode']==123461861)
            {
                $actioncode=5;
            }
            if ($_SESSION['responsibilitycode']==123462178)
            {
                $actioncode=6;
            }
            if ($voucherheader1->fetch())
            {
                $ret = $voucherheader1->updatenextapprovalstage($actioncode);
                if ($ret==1)
                {
                    if ($voucherheader1->approvalstatus == 9)
                    {
                        $ret = $voucherheader1->generatevouchernumber();
                        if ($ret==1)
                        {
                            oci_commit($connection);
                            $transactionnumber_en = fnEncrypt($voucherheader1->transactionnumber);
                            $voucherdate = DateTime::createFromFormat('d-M-Y',$voucherheader1->voucherdate)->format('d-M-y');
                            $voucherdate_en = fnEncrypt($voucherdate);
                            $vouchersubtypecode_en = fnEncrypt($voucherheader1->vouchersubtypecode);
                            $flag_en = fnEncrypt("Approval");
                            header("Location: ../ip_view/voucherheader.php?transactionnumber=".$transactionnumber_en."&voucherdate=".$voucherdate_en."&vouchersubtypecode=".$vouchersubtypecode_en."&flag=".$flag_en);
                        }
                        else
                        {
                            oci_rollback($connection);
                            echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
                            echo '<button onclick="history.go(-1);">Back </button>';        
                        }
                    }
                    else
                    {
                        oci_commit($connection);
                        if ($voucherheader1->voucherdate!='')
                        {
                            $voucherdate = DateTime::createFromFormat('d/m/Y',$voucherheader1->voucherdate)->format('d-M-y');
                        }
                        else
                        {
                            $voucherdate = '';
                        }
                        $voucherdate_en = fnEncrypt($voucherdate);
                        $vouchersubtypecode_en = fnEncrypt($voucherheader1->vouchersubtypecode);
                        $flag_en = fnEncrypt("Approval");
                        header("Location: ../ip_view/voucherapproval.php?voucherdate=".$voucherdate_en."&vouchersubtypecode=".$vouchersubtypecode_en."&flag=".$flag_en);
                    }
                    
                }
                else
                {
                    oci_rollback($connection);
                    echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
                    echo '<button onclick="history.go(-1);">Back </button>';
                }
            }
            break;
       case 'Disapproval':
		    $voucherheader1->transactionnumber = $_POST["transactionnumber"];
            $voucherheader1->disapprovalreason = $_POST["disapprovalreason"];
            if ($voucherheader1->fetch())
            {
                if ($_SESSION['responsibilitycode']==683297845124527)
                {
                    $actioncode=11;
                }
                elseif ($_SESSION['responsibilitycode']==123461861)
                {
                    $actioncode=12;
                }
                if ($_SESSION['responsibilitycode']==123462178)
                {
                    $actioncode=13;
                }
                $ret = $voucherheader1->updatecurrentdisapprovalstage($actioncode);
                if ($ret==1)
                {
                    oci_commit($connection);
                    if ($voucherheader1->voucherdate!='')
                    {
                        $voucherdate = DateTime::createFromFormat('d/m/Y',$voucherheader1->voucherdate)->format('d-M-y');
                    }
                    else
                    {
                        $voucherdate = '';
                    }
                    //$voucherdate = DateTime::createFromFormat('d/m/Y',$voucherheader1->voucherdate)->format('d-M-y');
                    $voucherdate_en = fnEncrypt($voucherdate);
                    $vouchersubtypecode_en = fnEncrypt($voucherheader1->vouchersubtypecode);
                    $flag_en = fnEncrypt("Approval");
                    header("Location: ../ip_view/voucherapproval.php?voucherdate=".$voucherdate_en."&vouchersubtypecode=".$vouchersubtypecode_en."&flag=".$flag_en);
                }
                else
                {
                    oci_rollback($connection);
                    echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
                    echo '<button onclick="history.go(-1);">Back </button>';
                }
            }
            break; 
      case 'Unlock':
        $voucherheader1->transactionnumber = $_POST["transactionnumber"];
        if ($voucherheader1->fetch())
        {
            $ret = $voucherheader1->unlockvoucher();
            if ($ret==1)
            {
                oci_commit($connection);
                $transactionnumber_en = fnEncrypt($voucherheader1->transactionnumber);
                $vouchersubtypecode_en= fnEncrypt($voucherheader1->vouchersubtypecode);
                $flag_en = fnEncrypt('Display');
                echo '<span class="w3-container" style="background-color:#0a0;color:#ff8;text-align:left;">Voucher is Unlocked for Correction successfully</span></br>';  
                echo '<a href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'&transactionnumber='.$transactionnumber_en.'&flag='.$flag_en.'">Find Voucher Header</a></br>';
            }
            else
            {
                oci_rollback($connection);
                echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
                echo '<button onclick="history.go(-1);">Back </button>';
            }
        }
        break;
      case 'Re-Send for Approval':
        $voucherheader1->transactionnumber = $_POST["transactionnumber"];
        if ($voucherheader1->fetch())
        {
            $ret = $voucherheader1->lockvoucher();
            if ($ret==1)
            {
                oci_commit($connection);
                $transactionnumber_en = fnEncrypt($voucherheader1->transactionnumber);
                $vouchersubtypecode_en= fnEncrypt($voucherheader1->vouchersubtypecode);
                $flag_en = fnEncrypt('Display');
                echo '<span class="w3-container" style="background-color:#0a0;color:#ff8;text-align:left;">Voucher is sent for approval successfully</span></br>';  
                echo '<a href="../ip_view/voucherheader.php?vouchersubtypecode='.$vouchersubtypecode_en.'&transactionnumber='.$transactionnumber_en.'&flag='.$flag_en.'">Find Voucher Header</a></br>';
            }
            else
            {
                oci_rollback($connection);
                echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
                echo '<button onclick="history.go(-1);">Back </button>';
            }
        }
      else
      {
          oci_rollback($connection);
          echo '<span style="background-color:#f44;color:#ff8;text-align:left;">'.$voucherheader1->Get_invalidmessagetext().'</span></br>';
          echo '<button onclick="history.go(-1);">Back </button>';
      }
			break;
    default:
			echo 'Communication Error';
			break;
	}

