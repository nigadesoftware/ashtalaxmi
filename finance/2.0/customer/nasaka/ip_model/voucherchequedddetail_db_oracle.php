<?php
//This is generated by Swapp Software Application on 23/11/2018 04:19:16 PM for PHP
include("../swappbase/formbase.php");
include_once("../ip_model/voucherdetail_db_oracle.php");
class voucherchequedddetail extends swappform
{
    Public $transactionnumber;
    Public $bankaccountcode;
    Public $funddocumentcode;
    Public $funddocumentdate;
    Public $funddocumentnumber;
    Public $funddocumentamount;
    Public $draweebank;
    public $oppositeaccountcode;
    public $oppositesubledgercode;
    public $bankcommission;
    Public $oppositeledgerbalance;
    Public $oppositesubledgerbalance;
    Public $bankledgerbalance;
    Public $payee;
    public function __construct(&$connection)
    {
     	 parent::__construct($connection);
         $this->transactionnumber='';
         $this->bankaccountcode='';
         $this->funddocumentcode='';
         $this->funddocumentdate='';
         $this->funddocumentnumber='';
         $this->funddocumentamount='';
         $this->draweebank='';
         $this->oppositeaccountcode='';
         $this->oppositesubledger='';
	   }
    private function entryvalidation()
    {
    	$this->start_validation();
        $this->checkrequired($this->bankaccountcode,'Bank account code');
        if (($this->vouchersubtypecode()==5 and $this->voucherapprovalstatus($this->transactionnumber)==2) or ($this->vouchersubtypecode()!=5))
        {
            $this->checkrequired($this->funddocumentcode,'Fund document code');
            $this->checkrequired($this->funddocumentdate,'Fund document date');
            $this->checkrequired($this->funddocumentnumber,'Fund document number');
            if ($this->vouchersubtypecode()==5)
            {
                $this->checkrequired($this->payee,'Payee');
            }
        }
        $this->checkrequired($this->funddocumentamount,'Fund document amount');
        if ($this->vouchersubtypecode()==2)
        {
            $this->checkrequired($this->draweebank,'Draweebank');
        }
        if ($this->vouchersubtypecode()==3 or $this->vouchersubtypecode()==6)
        {
            $this->checkrequired($this->oppositeaccountcode,'Account Code');
            if ($this->bankaccountcode == $this->oppositeaccountcode)
            {
                $this->invalidid=-123;
    		    $this->invalidmessagetext='Bank account and Account should be different';
            }
        }
        if ($this->vouchersubtypecode()==9)
        {
            $this->checkrequired($this->oppositeaccountcode,'Transfer Bank account code');
            if ($this->bankaccountcode == $this->oppositeaccountcode)
            {
                $this->invalidid=-123;
    		    $this->invalidmessagetext='Bank account and Transfer bank should be different';
            }
        }
        if ($this->vouchersubtypecode()==8 or $this->vouchersubtypecode()==9)
        {
            $this->checkrequired($this->payee,'Payee');
        }
        $this->end_validation();
        return $this->invalidid;
	  }
    private function datavalidation()
    {
        $this->start_validation();
    		$this->invalidid=0;
    		$this->invalidmessagetext='Validated';
    		$this->end_validation();
    		return $this->invalidid;
    }
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        if ($this->funddocumentdate!='')
        {
            $this->funddocumentdate = DateTime::createFromFormat('d/m/Y',$this->funddocumentdate)->format('d-M-Y');
        }
        $this->detailserialnumber= $this->chequedddetailserialnumber();
        $query = "
            insert into voucherchequedddetail(
            transactionnumber
            ,bankaccountcode
            ,funddocumentcode
            ,funddocumentdate
            ,funddocumentnumber
            ,funddocumentamount
            ,draweebank
            ,oppositeaccountcode
            ,oppositesubledgercode
            ,detailserialnumber
            ,bankcommission
            ,payee
	        )
	        values (
            ".$this->invl($this->transactionnumber,true)."
            ,".$this->invl($this->bankaccountcode,true,true)."
            ,".$this->invl($this->funddocumentcode,true,true)."
            ,".$this->invl($this->funddocumentdate,false)."
            ,".$this->invl($this->funddocumentnumber,true)."
            ,".$this->invl($this->funddocumentamount,true)."
            ,".$this->invl($this->draweebank,false)."
            ,".$this->invl($this->oppositeaccountcode,false)."
            ,".$this->invl($this->oppositesubledgercode,false)."
            ,".$this->invl($this->detailserialnumber,true)."
            ,".$this->invl($this->bankcommission,true)."
            ,".$this->invl($this->payee,false)."
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='';
		    if ($this->bankaccountcode!='' and $this->bankaccountcode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.bankaccountcode = ".$this->bankaccountcode;
			       }
			       else
			       {
				         $cond=$cond." and t.bankaccountcode = ".$this->bankaccountcode;
			       }
		    }
		    if ($this->funddocumentcode!='' and $this->funddocumentcode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.funddocumentcode = ".$this->funddocumentcode;
			       }
			       else
			       {
				         $cond=$cond." and t.funddocumentcode = ".$this->funddocumentcode;
			       }
		    }
		    if ($this->funddocumentdate!='')
		    {
			      $this->funddocumentdate = DateTime::createFromFormat('d/m/Y',$this->funddocumentdate)->format('d-M-Y');
			      if ($cond=='')
			      {
				        $cond="t.funddocumentdate = '".$this->funddocumentdate."'";
			       }
			       else
			       {
				         $cond=$cond." and t.funddocumentdate = '".$this->funddocumentdate."'";
			       }
		    }
		    if ($this->funddocumentnumber!='' and $this->funddocumentnumber!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.funddocumentnumber = ".$this->funddocumentnumber;
			       }
			       else
			       {
				         $cond=$cond." and t.funddocumentnumber = ".$this->funddocumentnumber;
			       }
		    }
		    if ($this->funddocumentamount!='' and $this->funddocumentamount!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.funddocumentamount = ".$this->funddocumentamount;
			       }
			       else
			       {
				         $cond=$cond." and t.funddocumentamount = ".$this->funddocumentamount;
			       }
		    }
		    if ($this->draweebank!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.draweebank like '%".$this->draweebank."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.draweebank like '%".$this->draweebank."%'";
			       }
		    }
        if ($cond!='')
		    {
		        $query = "select t.* from voucherchequedddetail t where ".$cond." order by transactionnumber";
			      $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
			      return $result;
		     }
		     else
		     {
		         $query = "select t.* from voucherchequedddetail t order by transactionnumber";
			       $result = oci_parse($this->connection, $query);
             $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
			       return $result;
		     }
	  }
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        if ($this->funddocumentdate!='')
        $this->funddocumentdate = DateTime::createFromFormat('d/m/Y',$this->funddocumentdate)->format('d-M-Y');
        else
        $this->funddocumentdate ='';
        $query = "
        update voucherchequedddetail set 
        bankaccountcode = ".$this->invl($this->bankaccountcode,true)."
        ,funddocumentcode = ".$this->invl($this->funddocumentcode,true)."
        ,funddocumentdate =".$this->invl($this->funddocumentdate,false)."
        ,funddocumentnumber = ".$this->invl($this->funddocumentnumber,true)."
        ,funddocumentamount = ".$this->invl($this->funddocumentamount,true)."
        ,draweebank =".$this->invl($this->draweebank,false)."
        ,oppositeaccountcode =".$this->invl($this->oppositeaccountcode,false)."
        ,oppositesubledgercode =".$this->invl($this->oppositesubledgercode,false)."
        ,bankcommission =".$this->invl($this->bankcommission,false)."
        ,payee=".$this->invl($this->payee,false)."
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $query = "
        delete from voucherchequedddetail
        where 
        transactionnumber =".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
             return 1;
             exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        transactionnumber
        ,bankaccountcode
        ,funddocumentcode
        ,funddocumentdate
        ,funddocumentnumber
        ,funddocumentamount
        ,draweebank
        ,oppositeaccountcode
        ,oppositesubledgercode
        ,bankcommission
        ,payee
        ,case when oppositeaccountcode is not null then
        accountclosingbalance(".$_SESSION['yearperiodcode'].",oppositeaccountcode)
        else
        0 end as oppositeledgerbalance
        ,case when oppositesubledgercode is not null then
        subaccountclosingbalance(".$_SESSION['yearperiodcode'].",oppositeaccountcode,oppositesubledgercode)
        else
        0 end as oppositesubledgerbalance
        ,case when bankaccountcode is not null then
        accountclosingbalance(".$_SESSION['yearperiodcode'].",bankaccountcode)
        else
        0 end as bankledgerbalance
        from voucherchequedddetail where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->transactionnumber = $row['TRANSACTIONNUMBER'];
                $this->bankaccountcode = $row['BANKACCOUNTCODE'];
                $this->funddocumentcode = $row['FUNDDOCUMENTCODE'];
                if ($row['FUNDDOCUMENTDATE']!='')
                $this->funddocumentdate = DateTime::createFromFormat('d-M-y',$row['FUNDDOCUMENTDATE'])->format('d/m/Y');
                else
                $this->funddocumentdate = '';
                //$this->funddocumentdate = $row['FUNDDOCUMENTDATE'];
                $this->funddocumentnumber = $row['FUNDDOCUMENTNUMBER'];
                $this->funddocumentamount = $row['FUNDDOCUMENTAMOUNT'];
                $this->draweebank = $row['DRAWEEBANK'];
                $this->oppositeaccountcode = $row['OPPOSITEACCOUNTCODE'];
                $this->oppositesubledgercode = $row['OPPOSITESUBLEDGERCODE'];
                $this->bankcommission = $row['BANKCOMMISSION'];
                $this->payee = $row['PAYEE'];
                if ($row['OPPOSITELEDGERBALANCE']>=0)
                {
                    $this->oppositeledgerbalance=round($row['OPPOSITELEDGERBALANCE'],2).' Dr';
                }
                elseif ($row['OPPOSITELEDGERBALANCE']<0)
                {
                    $this->oppositeledgerbalance=abs(round($row['OPPOSITELEDGERBALANCE'],2)).' Cr';
                }
                if ($row['OPPOSITESUBLEDGERBALANCE']>0)
                {
                    $this->oppositesubledgerbalance=round($row['OPPOSITESUBLEDGERBALANCE'],2).' Dr';
                }
                elseif ($row['OPPOSITESUBLEDGERBALANCE']<0)
                {
                    $this->oppositesubledgerbalance=abs(round($row['OPPOSITESUBLEDGERBALANCE'],2)).' Cr';
                }
                else
                {
                    $this->oppositesubledgerbalance=' ';
                }
                if ($row['BANKLEDGERBALANCE']>=0)
                {
                    $this->bankledgerbalance=round($row['BANKLEDGERBALANCE'],2).' Dr';
                }
                elseif ($row['BANKLEDGERBALANCE']<0)
                {
                    $this->bankledgerbalance=abs(round($row['BANKLEDGERBALANCE'],2)).' Cr';
                }
                $this->found=true;
                return true;
        }
        else
        {
        return false;
        }
    }
    public function deleteall()
    {
        $this->dataoperationmode = operationmode::Delete;
        if ($this->transactionnumber <= 0)
        {
            return 0;
            exit;
        }
        $query = "
        delete from voucherchequedddetail
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function vouchersubtypecode()
    {
        $query = "select 
        vouchersubtypecode
        from voucherheader 
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                return $row['VOUCHERSUBTYPECODE'];
        }
        else
        {
                return 0;
        }
    }
    public function bankdetailserialnumber()
    {
        $query = "select detailserialnumber
        from voucherdetail h
        where h.accountcode=".$this->bankaccountcode." and h.transactionnumber=".$this->transactionnumber; 
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            return $row['DETAILSERIALNUMBER'];
        }
        else
        {
            return 0;
        }
    }

    public function chequedddetailserialnumber()
    {
        $query = "select nvl(max(detailserialnumber),0)
        from voucherchequedddetail h
        where h.transactionnumber=".$this->transactionnumber; 
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            return $row['DETAILSERIALNUMBER']+1;
        }
        else
        {
            return 1;
        }
    }
    public function updatebankdetail()
    {
        $query = "select h.vouchersubtypecode
        from voucherheader h
        where 
        h.vouchersubtypecode in (2,5,8)
        and h.transactionnumber=".$this->transactionnumber."
        group by h.vouchersubtypecode";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $bankdetailserialnumber = $this->bankdetailserialnumber();
            $voucherdetail1 = new voucherdetail($this->connection);
            $voucherdetail1->transactionnumber = $this->transactionnumber;
            $voucherdetail1->accountcode = $this->bankaccountcode;
            //$voucherdetail1->costcentrecode = 1;
            if ($row['VOUCHERSUBTYPECODE']==2)
            {
                $voucherdetail1->debit = $this->funddocumentamount;
                $voucherdetail1->credit = null;
                $voucherdetail1->subledgercode = null;
            }
            elseif ($row['VOUCHERSUBTYPECODE']==5 or $row['VOUCHERSUBTYPECODE']==8)
            {
                $voucherdetail1->credit = $this->funddocumentamount;
                $voucherdetail1->debit = null;
                $voucherdetail1->subledgercode = null;
            }
            if ($bankdetailserialnumber==0)
            {
                $query1 = "select nvl(max(detailserialnumber),0)+1 as detailserialnumber 
                from voucherdetail
                where transactionnumber=".$this->transactionnumber;
                $result1 = oci_parse($this->connection, $query1);
                $r1 = oci_execute($result1,OCI_NO_AUTO_COMMIT);
                $row1 = oci_fetch_array($result1,OCI_ASSOC+OCI_RETURN_NULLS);
                $voucherdetail1->detailserialnumber = $row1["DETAILSERIALNUMBER"];
                if ($voucherdetail1->insert() == 1)
                {
                    if ($voucherdetail1->updateheader()==1)
                    {
                        return 1;
                        exit;
                    }
                    else
                    {
                        return 0;
                        exit;
                    }
                }
                else
                {
                    return 0;
                    exit;
                }
            }
            else
            {
                $voucherdetail1->detailserialnumber = $bankdetailserialnumber;
                if ($voucherdetail1->update() == 1)
                {
                    if ($voucherdetail1->updateheader()==1)
                    {
                        return 1;
                        exit;
                    }
                    else
                    {
                        return 0;
                        exit;
                    }
                }
                else
                {
                    return 0;
                    exit;
                }
            }
        }
        else
        {
            return -1;
            exit;
        }
    }
    public function updatebankcashdetail()
    {
        $query = "select h.vouchersubtypecode
        from voucherheader h
        where 
        h.vouchersubtypecode in (8)
        and h.transactionnumber=".$this->transactionnumber."
        group by h.vouchersubtypecode";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $voucherdetail1 = new voucherdetail($this->connection);
            $voucherdetail1->transactionnumber=$this->transactionnumber;
            $cashdetailserialnumber = $voucherdetail1->cashdetailserialnumber();
            $voucherdetail1->accountcode = $voucherdetail1->cashaccountcode();
            if ($row['VOUCHERSUBTYPECODE']==8)
            {
                $voucherdetail1->debit = $this->funddocumentamount;
                $voucherdetail1->credit = null;
                $voucherdetail1->subledgercode = null;
            }
            $voucherdetail1->detailserialnumber = 1;
            //$voucherdetail1->costcentrecode = 1;
            if ($cashdetailserialnumber==0)
            {
                if ($voucherdetail1->insert() == 1)
                {
                    return 1;
                    exit;
                }
                else
                {
                    return 0;
                    exit;
                }
            }
            else
            {
                if ($voucherdetail1->update() == 1)
                {
                    return 1;
                    exit;
                }
                else
                {
                    return 0;
                    exit;
                }
            }
        }
    }

    public function updatebankbankdetail()
    {
        $query = "select h.vouchersubtypecode
        from voucherheader h
        where 
        h.vouchersubtypecode in (2,3,5,6,9)
        and h.transactionnumber=".$this->transactionnumber."
        group by h.vouchersubtypecode";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $voucherdetail1 = new voucherdetail($this->connection);
            $voucherdetail1->transactionnumber=$this->transactionnumber;
            $bankdetailserialnumber = $this->bankdetailserialnumber();
            $voucherdetail1->accountcode = $this->bankaccountcode;
            if ($row['VOUCHERSUBTYPECODE']==5 or $row['VOUCHERSUBTYPECODE']==6 or $row['VOUCHERSUBTYPECODE']==9)
            {
                $voucherdetail1->credit = $this->funddocumentamount;
                $voucherdetail1->debit = null;
            }
            elseif ($row['VOUCHERSUBTYPECODE']==2 or $row['VOUCHERSUBTYPECODE']==3)
            {
                $voucherdetail1->debit = $this->funddocumentamount;
                $voucherdetail1->credit = null;                
            }
            
            $voucherdetail1->subledgercode = null;
            $voucherdetail1->detailserialnumber = 1;
            //$voucherdetail1->costcentrecode = 1;

            $voucherdetail2 = new voucherdetail($this->connection);
            $voucherdetail2->transactionnumber=$this->transactionnumber;
            $voucherdetail2->accountcode = $this->oppositeaccountcode;
            if ($row['VOUCHERSUBTYPECODE']==5 or $row['VOUCHERSUBTYPECODE']==6 or $row['VOUCHERSUBTYPECODE']==9)
            {
                if ($row['VOUCHERSUBTYPECODE']==5 or $row['VOUCHERSUBTYPECODE']==9)
                {
                    if ($this->bankcommission == 0)
                    {
                        $voucherdetail2->debit = $this->funddocumentamount;
                    }
                    else
                    {
                        $voucherdetail2->debit = $this->funddocumentamount-$this->bankcommission;
                    }
                }
                else
                {
                    $voucherdetail2->debit = $this->funddocumentamount;
                }
                $voucherdetail2->credit = null;
            }
            elseif ($row['VOUCHERSUBTYPECODE']==2 or $row['VOUCHERSUBTYPECODE']==3)
            {
                $voucherdetail2->credit = $this->funddocumentamount;
                $voucherdetail2->debit = null;                
            }
            if ($row['VOUCHERSUBTYPECODE']==2 or $row['VOUCHERSUBTYPECODE']==5)
            {
                $voucherdetail2->subledgercode = $this->oppositesubledgercode;
            }
            else
            {
                $voucherdetail2->subledgercode = null;
            }
            $voucherdetail2->detailserialnumber = 2;
            //$voucherdetail2->costcentrecode = 1;

            if (($row['VOUCHERSUBTYPECODE']==5 or $row['VOUCHERSUBTYPECODE']==9) and $this->bankcommission > 0)
            {
                $voucherdetail3 = new voucherdetail($this->connection);
                $voucherdetail3->transactionnumber=$this->transactionnumber;
                $voucherdetail3->accountcode = 1304006;
                $voucherdetail3->debit = $this->bankcommission;
                $voucherdetail3->credit = null;
                $voucherdetail3->subledgercode = null;
                $voucherdetail3->detailserialnumber = 3;
                //$voucherdetail3->costcentrecode = 1;
            }            

            if ($bankdetailserialnumber==0)
            {
                if ($voucherdetail1->insert() == 1)
                {
                    if ($voucherdetail2->insert() == 1)
                    {
                        $ret = 1;
                        if (($row['VOUCHERSUBTYPECODE']==5 or $row['VOUCHERSUBTYPECODE']==9) and $this->bankcommission > 0)
                        {
                            $ret = $voucherdetail3->insert();
                        }
                        if ($ret==1)
                        {
                            if ($voucherdetail1->updateheader()==1)
                            {
                                return 1;
                                exit;
                            }
                            else
                            {
                                return 0;
                                exit;
                            }
                        }
                        else
                        {
                            return 0;
                            exit;
                        }
                    }
                    else
                    {
                        return 0;
                        exit;
                    }
                }
                else
                {
                    return 0;
                    exit;
                }
            }
            else
            {
                if ($voucherdetail1->update() == 1)
                {
                    if ($voucherdetail2->update() == 1)
                    {
                        $ret = 1;
                        if (($row['VOUCHERSUBTYPECODE']==5 or $row['VOUCHERSUBTYPECODE']==9) and $this->bankcommission > 0)
                        {
                            $ret = $voucherdetail3->update();
                        }
                        if ($ret==1)
                        {
                            if ($voucherdetail1->updateheader()==1)
                            {
                                return 1;
                                exit;
                            }
                            else
                            {
                                return 0;
                                exit;
                            }
                        }
                        else
                        {
                            return 0;
                            exit;
                        }
                    }
                    else
                    {
                        return 0;
                        exit;
                    }
                }
                else
                {
                    return 0;
                    exit;
                }
            }
        }
    }
    function deletedetail()
    {
        $query = "select h.vouchersubtypecode
        from voucherheader h
        where 
        h.vouchersubtypecode in (2,3,5,6,9)
        and h.transactionnumber=".$this->transactionnumber."
        group by h.vouchersubtypecode";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $voucherdetail1 = new voucherdetail($this->connection);
            $voucherdetail1->transactionnumber = $this->transactionnumber;
            if ($this->oppositeaccountcode !='')
            {
                $ret = $voucherdetail1->deleteall();
                if ($ret ==1)
                {
                    if ($voucherdetail1->updateheader()==1)
                    {
                        return 1;
                        exit;
                    }
                    else
                    {
                        return 0;
                        exit;
                    }
                }
                else
                {
                    return 0;
                }
            }
            else
            {
                //$voucherdetail1->detailserialnumber=1;
                $voucherdetail1->accountcode=$this->bankaccountcode;
                $voucherdetail1->fetchbyaccountcode();
                if ($voucherdetail1->accountcode == $this->bankaccountcode)
                {
                    $ret = $voucherdetail1->delete();
                    if ($ret ==1)
                    {
                        if ($voucherdetail1->updateheader()==1)
                        {
                            return 1;
                            exit;
                        }
                        else
                        {
                            return 0;
                            exit;
                        }
                    }
                    else
                    {
                        return 0;
                    }
                }
                else
                {
                    return 0;
                }
            }
        }
        else
        {
            return -1;
        }
    }
    function voucherapprovalstatus($transactionnumber)
    {
        $query = "select nvl(approvalstatus,0) as approvalstatus
        from nst_nasaka_finance.voucherheader h
        where h.transactionnumber=".$transactionnumber;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            return $row['APPROVALSTATUS'];
        }
        else
        {
            return 0;    
        }
    }
    function voucherdebittotal($transactionnumber)
    {
        $query = "select sum(h.debit) as debit
        from nst_nasaka_finance.voucherdetail h
        where h.transactionnumber=".$transactionnumber;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            return $row['DEBIT'];
        }
        else
        {
            return 0;    
        }
    }

}
?>

