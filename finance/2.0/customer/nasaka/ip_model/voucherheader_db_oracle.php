<?php
//This is generated by Swapp Software Application on 11/11/2018 04:47:25 PM for PHP
include_once("../swappbase/formbase.php");
include_once("../ip_model/voucheractiondetail_db_oracle.php");
//include_once("../info/swapproutine.php");
class voucherheader extends swappform
{
    Public $transactionnumber;
    Public $legalentitycode;
    Public $yearperiodcode;
    Public $vouchersubtypecode;
    public $vouchernumberbasevalue;
    Public $vouchernumber;
    Public $vouchernumberprefixsufix;
    Public $voucherdate;
    Public $description;
    Public $narration;
    Public $approvalstatus;
    Public $vouchernumberseriesid;
    Public $applicationnumber;
    public $totaldebit;
    public $totalcredit;
    Public $cashbalance;

    public function __construct(&$connection)
    {
     	 parent::__construct($connection);
         $this->transactionnumber='';
         $this->legalentitycode='';
         $this->yearperiodcode='';
         $this->vouchersubtypecode='';
         $this->vouchernumber='';
         $this->vouchernumberprefixsufix='';
         $this->voucherdate='';
         $this->description='';
         $this->narration='';
         $this->approvalstatus='';
         $this->vouchernumberseriesid='';
         $this->applicationnumber='';
         $this->totaldebit=0;
         $this->totalcredit=0;
	   }
    private function entryvalidation()
    {
        $this->start_validation();
        if ($this->vouchersubtypecode!=4 and $this->vouchersubtypecode!=5)
        {
            $this->checkrequired($this->voucherdate,'Voucher Date');
        }
        elseif ($this->dataoperationmode == operationmode::Insert)
        {
            $this->voucherdate = '';
        }
        if ($this->vouchersubtypecode_de==1 or $this->vouchersubtypecode_de==2 or $this->vouchersubtypecode_de==4)
        {
            $this->checkrequired($this->description,'Description');
        }
        $this->checkrequired($this->narration,'Narration');
        $this->end_validation();
        return $this->invalidid;
	}
    private function datavalidation()
    {
        $this->start_validation();
    		$this->invalidid=0;
    		$this->invalidmessagetext='Validated';
    		$this->end_validation();
    		return $this->invalidid;
    }

    public function generatevouchernumber()
	{
            if ($this->voucherdate=='')
            {
                $this->voucherdate = currentdate();
            }
            if (!isset($this->vouchernumber) or $this->vouchernumber == '' )
            {
                $query = "select nvl(d.vouchernumberprefix,'') as vouchernumberprefix,periodresetcategorycode from vouchernumberseries d where d.vouchernumberseriesid=".$this->vouchernumberseriesid;
                $result = oci_parse($this->connection, $query);
                $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
                if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
                {
                    $voucherdate = DateTime::createFromFormat('d/m/Y',$this->voucherdate)->format('d-M-Y');
                    switch ($row['PERIODRESETCATEGORYCODE'])
                    {
                        case 1:
                        {
                            $prefix = $row["VOUCHERNUMBERPREFIX"];
                            $query_12 = "select nvl(max(vouchernumber),0)+1 as vouchernumber,vouchernumberbasevalue('".$voucherdate."',1) as vouchernumberbasevalue  from voucherheader where yearperiodcode=".$this->yearperiodcode." and vouchernumberbasevalue=vouchernumberbasevalue('".$voucherdate."',1) and vouchernumberseriesid=".$this->vouchernumberseriesid;
                            $result_12 = oci_parse($this->connection, $query_12);
                            $r = oci_execute($result_12,OCI_NO_AUTO_COMMIT);
                            $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                            $this->vouchernumber = $row_12["VOUCHERNUMBER"];
                            $this->vouchernumberprefixsufix = $prefix.str_pad($row_12["VOUCHERNUMBER"],5,'0',STR_PAD_LEFT);
                            $this->vouchernumberbasevalue = $row_12["VOUCHERNUMBERBASEVALUE"];
                            break;
                        }
                        case 2:
                        {
                            $prefix = $row["VOUCHERNUMBERPREFIX"];
                            $query_12 = "select nvl(max(vouchernumber),0)+1 as vouchernumber,vouchernumberbasevalue('".$voucherdate."',2) as vouchernumberbasevalue from voucherheader where yearperiodcode=".$this->yearperiodcode." and vouchernumberbasevalue=vouchernumberbasevalue('".$voucherdate."',2) and vouchernumberseriesid=".$this->vouchernumberseriesid;
                            $result_12 = oci_parse($this->connection, $query_12);
                            $r = oci_execute($result_12,OCI_NO_AUTO_COMMIT);
                            $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                            $this->vouchernumber = $row_12["VOUCHERNUMBER"];
                            $this->vouchernumberprefixsufix = $prefix.str_pad($row_12["VOUCHERNUMBER"],5,'0',STR_PAD_LEFT);
                            $this->vouchernumberbasevalue = $row_12["VOUCHERNUMBERBASEVALUE"];
                            break;
                        }
                        case 3:
                        {
                            $prefix = $row["VOUCHERNUMBERPREFIX"];
                            $query_12 = "select nvl(max(vouchernumber),0)+1 as vouchernumber,vouchernumberbasevalue('".$voucherdate."',3) as vouchernumberbasevalue from voucherheader where yearperiodcode=".$this->yearperiodcode." and vouchernumberbasevalue=vouchernumberbasevalue('".$voucherdate."',3) and vouchernumberseriesid=".$this->vouchernumberseriesid;
                            $result_12 = oci_parse($this->connection, $query_12);
                            $r = oci_execute($result_12,OCI_NO_AUTO_COMMIT);
                            $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                            $this->vouchernumber = $row_12["VOUCHERNUMBER"];
                            $this->vouchernumberprefixsufix = $prefix.str_pad($row_12["VOUCHERNUMBER"],5,'0',STR_PAD_LEFT);
                            $this->vouchernumberbasevalue = $row_12["VOUCHERNUMBERBASEVALUE"];
                            break;
                        }
                        case 4:
                        {
                            $prefix = $row["VOUCHERNUMBERPREFIX"];
                            $query_12 = "select nvl(max(vouchernumber),0)+1 as vouchernumber,vouchernumberbasevalue('".$voucherdate."',4) as vouchernumberbasevalue from voucherheader where yearperiodcode=".$this->yearperiodcode." and vouchernumberbasevalue=vouchernumberbasevalue('".$voucherdate."',4) and vouchernumberseriesid=".$this->vouchernumberseriesid;
                            $result_12 = oci_parse($this->connection, $query_12);
                            $r = oci_execute($result_12,OCI_NO_AUTO_COMMIT);
                            $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                            $this->vouchernumber = $row_12["VOUCHERNUMBER"];
                            $this->vouchernumberprefixsufix = $prefix.str_pad($row_12["VOUCHERNUMBER"],5,'0',STR_PAD_LEFT);
                            $this->vouchernumberbasevalue = $row_12["VOUCHERNUMBERBASEVALUE"];
                            break;
                        }
                    }
                    $ret = $this->update();
                    if ($ret==1)
                    {
                        if ($this->approvalstatus='')
                        {
                            $voucheractiondetail1 = new voucheractiondetail($this->connection);
                            $voucheractiondetail1->transactionnumber = $this->transactionnumber;
                            $voucheractiondetail1->usercode = $_SESSION['usersid'];
                            $voucheractiondetail1->actioncode = 10;
                            $ret = $voucheractiondetail1->insert();
                            if ($ret == 1)
                            {
                                return 1;
                                exit;
                            }
                            else
                            {
                                return 0;
                                exit;
                            }
                        }
                        else
                        {
                            return 1;
                            exit;
                        }
                    }
                    else
                    {
                        return 0;
                        $this->invalidid=-200;
                        $this->invalidmessagetext='Communication Error';
                        exit;
                    }
                }
                else
                {
                    return 0;
                    $this->invalidid=-200;
                    $this->invalidmessagetext='Communication Error';
                    exit;
                }
            }
            else
            {
                /*$query = "select vouchernumber,vouchernumberprefixsufix from voucherheader d where d.transactionid=".$this->transactionid;
                $result = oci_parse($this->connection, $query);
                $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
                if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
                {
                    $this->vouchernumber = $row["VOUCHERNUMBER"];
                    $this->vouchernumberprefixsufix = $row["VOUCHERNUMBER_SUFFPREF"];
                }*/
                $ret = $this->update();
                if ($ret==1)
                {
                    if ($this->voucherstatus='')
                    {
                        $voucheractiondetail1 = new voucheractiondetail($this->connection);
                        $voucheractiondetail1->transactionnumber = $this->transactionnumber;
                        $voucheractiondetail1->usercode = $_SESSION['usersid'];
                        $voucheractiondetail1->actioncode = 10;
                        $ret = $voucheractiondetail1->insert();
                        if ($ret == 1)
                        {
                            return 1;
                            exit;
                        }
                        else
                        {
                            return 0;
                            exit;
                        }
                    }
                    else
                    {
                        return 1;
                        exit;
                    }
                }
                else
                {
                    return 1;
                    exit;
                }
            }
	}


    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
	    if ($this->transactionnumber == '')
        {
            $prefix = $this->yearperiodcode . '%';

            $query = "
                SELECT CASE
                        WHEN NVL(MAX(transactionnumber), 0) = 0
                        THEN TO_NUMBER(".$this->yearperiodcode." || '000001')
                        ELSE NVL(MAX(transactionnumber), 0) + 1
                    END AS transactionnumber
                FROM voucherheader
                WHERE TO_CHAR(transactionnumber) LIKE '".$prefix."'
            ";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->transactionnumber = $row["TRANSACTIONNUMBER"];
        }
        
        $query1 = "select s.vouchernumberseriesid
        from vouchersubtype s
        where vouchernumberseriesid is not null and vouchersubtypecode=".$this->vouchersubtypecode;
        $result1 = oci_parse($this->connection, $query1);
        $r1 = oci_execute($result1,OCI_NO_AUTO_COMMIT);
        if ($row1 = oci_fetch_array($result1,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $this->vouchernumberseriesid = $row1["VOUCHERNUMBERSERIESID"];
        }
        else
        {
            $this->invalidid=-210;
            $this->invalidmessagetext='Voucher Series not defined';
            return 0;
            exit;
        }

        if ($this->voucherdate!='')
        {
            $this->voucherdate = DateTime::createFromFormat('d/m/Y',$this->voucherdate)->format('d-M-Y');
            if (isdateinperiod_financialyear($this->voucherdate)==0)
            {
                $this->invalidid=-211;
                $this->invalidmessagetext='Voucher Date not in the Financial Year';
                return 0;
                exit;         
            }
        }
        
        $query = "
            insert into voucherheader(
            transactionnumber
            ,legalentitycode
            ,yearperiodcode
            ,vouchersubtypecode
            ,vouchernumber
            ,vouchernumberprefixsufix
            ,voucherdate
            ,description
            ,narration
            ,approvalstatus
            ,vouchernumberseriesid
            ,applicationnumber
	        )
	        values (
            ".$this->invl($this->transactionnumber,true)."
            ,".$this->invl($this->legalentitycode,true)."
            ,".$this->invl($this->yearperiodcode,true)."
            ,".$this->invl($this->vouchersubtypecode,true)."
            ,".$this->invl($this->vouchernumber,true)."
            ,".$this->invl($this->vouchernumberprefixsufix,false)."
            ,".$this->invl($this->voucherdate,false)."
            ,".$this->invl($this->description,false)."
            ,".$this->invl($this->narration,false)."
            ,".$this->invl($this->approvalstatus,true)."
            ,".$this->invl($this->vouchernumberseriesid,true)."
            ,".$this->invl($this->applicationnumber,true,true)."
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            if ($this->approvalstatus=='')
            {
                $voucheractiondetail1 = new voucheractiondetail($this->connection);
                $voucheractiondetail1->transactionnumber = $this->transactionnumber;
                $voucheractiondetail1->usercode = $_SESSION['usersid'];
                $voucheractiondetail1->actioncode = 1;
                $ret = $voucheractiondetail1->insert();
                if ($ret == 1)
                {
                    return 1;
                    exit;
                }
                else
                {
                    return 0;
                    exit;
                }
            }
            else
            {
                return 1;
                exit;
            }
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='';
		    if ($this->transactionnumber!='' and $this->transactionnumber!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.transactionnumber = ".$this->transactionnumber;
			       }
			       else
			       {
				         $cond=$cond." and t.transactionnumber = ".$this->transactionnumber;
			       }
		    }
		    if ($this->vouchernumberprefixsufix!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.vouchernumberprefixsufix like '%".$this->vouchernumberprefixsufix."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.vouchernumberprefixsufix like '%".$this->vouchernumberprefixsufix."%'";
			       }
		    }
		    if ($this->voucherdate!='')
		    {
			      $this->voucherdate = DateTime::createFromFormat('d/m/Y',$this->voucherdate)->format('d-M-Y');
			      if ($cond=='')
			      {
				        $cond="t.voucherdate = '".$this->voucherdate."'";
			       }
			       else
			       {
				         $cond=$cond." and t.voucherdate = '".$this->voucherdate."'";
			       }
		    }
		    if ($this->narration!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.narration like '%".$this->narration."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.narration like '%".$this->narration."%'";
			       }
		    }
		    if ($this->applicationnumber!='' and $this->applicationnumber!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.applicationnumber = ".$this->applicationnumber;
			       }
			       else
			       {
				         $cond=$cond." and t.applicationnumber = ".$this->applicationnumber;
			       }
		    }
            if ($cond!='')
		    {
		        $query = "select t.*,case when t.refbillperiodtrnno is not null then nst_nasaka_agriculture.BILLPERIODSHORTDESC(refbillperiodtrnno) end descr_uni,case when t.refbillperiodtrnno is not null then nst_nasaka_agriculture.BILLPERIODSHORTDESC(refbillperiodtrnno,1) end descr_eng from voucherheader t where vouchersubtypecode=".$this->vouchersubtypecode." and yearperiodcode=".$_SESSION['yearperiodcode']." and ".$cond." order by decode(t.approvalstatus, -4,1,-3,2,-2,3,-1,4,null,5,1,6,2,7,3,8,4,9,9,10,11) asc,voucherdate desc,transactionnumber";
			    $result = oci_parse($this->connection, $query);
                $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
			    return $result;
		    }
		    else
		    {
		        $query = "select t.*,case when t.refbillperiodtrnno is not null then nst_nasaka_agriculture.BILLPERIODSHORTDESC(refbillperiodtrnno) end descr_uni,case when t.refbillperiodtrnno is not null then nst_nasaka_agriculture.BILLPERIODSHORTDESC(refbillperiodtrnno,1) end descr_eng from voucherheader t where vouchersubtypecode=".$this->vouchersubtypecode."  and yearperiodcode=".$_SESSION['yearperiodcode']." order by decode(t.approvalstatus, -4,1,-3,2,-2,3,-1,4,null,5,1,6,2,7,3,8,4,9,9,10,11) asc,voucherdate desc,transactionnumber";
			    $result = oci_parse($this->connection, $query);
                $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
			    return $result;
		    }
	  }
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        if ($this->voucherdate!='')
        {
            $this->voucherdate = DateTime::createFromFormat('d/m/Y',$this->voucherdate)->format('d-M-Y');
        }
        $query = "
        update nst_nasaka_finance.voucherheader set 
        legalentitycode = ".$this->invl($this->legalentitycode,true)."
        ,yearperiodcode =".$this->invl($this->yearperiodcode,false)."
        ,vouchersubtypecode = ".$this->invl($this->vouchersubtypecode,true)."
        ,vouchernumber = ".$this->invl($this->vouchernumber,true)."
        ,vouchernumberprefixsufix =".$this->invl($this->vouchernumberprefixsufix,false)."
        ,voucherdate =".$this->invl($this->voucherdate,false)."
        ,description =".$this->invl($this->description,false)."
        ,narration =".$this->invl($this->narration,false)."
        ,approvalstatus=".$this->invl($this->approvalstatus,true)."
        ,applicationnumber = ".$this->invl($this->applicationnumber,true)."
        ,vouchernumberbasevalue = ".$this->invl($this->vouchernumberbasevalue,false)."
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            //if ($this->voucherstatus>=1)
            //{
                $voucheractiondetail1 = new voucheractiondetail($this->connection);
                $voucheractiondetail1->transactionnumber = $this->transactionnumber;
                $voucheractiondetail1->usercode = $_SESSION['usersid'];
                $voucheractiondetail1->actioncode = 2;
                $ret = $voucheractiondetail1->insert();
                if ($ret == 1)
                {
                    return 1;
                    exit;
                }
                else
                {
                    return 0;
                    exit;
                }
            //}
            //else
            //{
                //return 1;
                //exit;
            //}
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        /* if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        } */
        if ($this->voucherdate != '')
        {
            $this->voucherdate = DateTime::createFromFormat('d/m/Y',$this->voucherdate)->format('d-M-Y');
        }
        $query1 = "
        delete from nst_nasaka_finance.voucherchequedddetail
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $query2 = "
        delete from nst_nasaka_finance.voucherdetail
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $query = "
        delete from nst_nasaka_finance.voucherheader
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result1 = oci_parse($this->connection, $query1);
        if (oci_execute($result1,OCI_NO_AUTO_COMMIT))
        {
            $result2 = oci_parse($this->connection, $query2);
            if (oci_execute($result2,OCI_NO_AUTO_COMMIT))
            {
                $result = oci_parse($this->connection, $query);
                if (oci_execute($result,OCI_NO_AUTO_COMMIT))
                {
                    //if ($this->voucherstatus>=1)
                    //{
                        $voucheractiondetail1 = new voucheractiondetail($this->connection);
                        $voucheractiondetail1->transactionnumber = $this->transactionnumber;
                        $voucheractiondetail1->usercode = $_SESSION['usersid'];
                        $voucheractiondetail1->actioncode = 3;
                        $ret = $voucheractiondetail1->insert();
                        if ($ret == 1)
                        {
                            return 1;
                            exit;
                        }
                        else
                        {
                            return 0;
                            exit;
                        }
                    //}
                    //else
                    //{
                        //return 1;
                        //exit;
                    //}
                }
                else
                {
                    return 0;
                    exit;
                }
            }
            else
            {
                return 0;
                exit;
            }
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        transactionnumber
        ,legalentitycode
        ,yearperiodcode
        ,vouchersubtypecode
        ,vouchernumber
        ,vouchernumberbasevalue
        ,vouchernumberprefixsufix
        ,voucherdate
        ,description
        ,narration
        ,approvalstatus
        ,vouchernumberseriesid
        ,applicationnumber
        ,totalcredit
        ,totaldebit
        ,(select accountclosingbalance(".$_SESSION['yearperiodcode'].",a.cashaccountcode) as cashbalance
        from accountcontroltable a) as cashbalance
        from nst_nasaka_finance.voucherheader where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->transactionnumber = $row['TRANSACTIONNUMBER'];
                $this->legalentitycode = $row['LEGALENTITYCODE'];
                $this->yearperiodcode = $row['YEARPERIODCODE'];
                $this->vouchersubtypecode = $row['VOUCHERSUBTYPECODE'];
                $this->vouchernumber = $row['VOUCHERNUMBER'];
                $this->vouchernumberbasevalue = $row['VOUCHERNUMBERBASEVALUE'];
                $this->vouchernumberprefixsufix = $row['VOUCHERNUMBERPREFIXSUFIX'];
                if ($row['VOUCHERDATE']!='')
                {
                    $this->voucherdate = DateTime::createFromFormat('d-M-y',$row['VOUCHERDATE'])->format('d/m/Y');
                }
                //$this->voucherdate = $row['VOUCHERDATE'];
                $this->description = $row['DESCRIPTION'];
                $this->narration = $row['NARRATION'];
                if ($row['APPROVALSTATUS']==0)
                {
                    $this->approvalstatus = '';
                }
                else
                {
                    $this->approvalstatus = $row['APPROVALSTATUS'];
                }
                $this->vouchernumberseriesid = $row['VOUCHERNUMBERSERIESID'];
                $this->applicationnumber = $row['APPLICATIONNUMBER'];
                $this->totalcredit = $row['TOTALCREDIT'];
                $this->totaldebit = $row['TOTALDEBIT'];
                if ($row['CASHBALANCE']>=0)
                {
                    $this->cashbalance=round($row['CASHBALANCE'],2).' Dr';
                }
                elseif ($row['CASHBALANCE']<0)
                {
                    $this->cashbalance=abs(round($row['CASHBALANCE'],2)).' Cr';
                }
                $this->found=true;
                return true;
        }
        else
        {   
            $this->cashbal();
            return false;
        }
    }
    public function cashbal()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select accountclosingbalance(".$_SESSION['yearperiodcode'].",a.cashaccountcode) as cashbalance
        from accountcontroltable a";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                if ($row['CASHBALANCE']>=0)
                {
                    $this->cashbalance=round($row['CASHBALANCE'],2).' Dr';
                }
                elseif ($row['CASHBALANCE']<0)
                {
                    $this->cashbalance=abs(round($row['CASHBALANCE'],2)).' Cr';
                }
        }
    }
    
    public function updatenextapprovalstage($actioncode)
    {
        if ($this->approvalstatus == '')
        {
            //$responsibilitycode = 0;
            $approvalstatus=0;
        }
        else
        {
            $approvalstatus=$this->approvalstatus;
        }
        $responsibilitycode = $_SESSION['responsibilitycode'];
        if ($this->vouchersubtypecode==14)
        {
            $query = "select 1 as stageserialnumber,1 as isfinalstage 
            from dual";
        }
        else
        {
            $query = "select stageserialnumber,isfinalstage 
            from nst_nasaka_finance.voucherapprovalstagedetail d
            where (d.voucherapprovalstagecode,d.stageserialnumber) 
            in (select v.voucherapprovalstagecode,min(t.stageserialnumber) as stageserialnumber
            from nst_nasaka_finance.voucherapprovalstage v,nst_nasaka_finance.voucherapprovalstagedetail t
            where v.voucherapprovalstagecode=t.voucherapprovalstagecode
            and v.vouchersubtypecode=".$this->invl($this->vouchersubtypecode,true)."
            and t.stageserialnumber>".$approvalstatus." 
            and t.responsibilitycode=".$responsibilitycode."
            group by v.voucherapprovalstagecode)";
        }
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            if ($row['ISFINALSTAGE']==1)
            {
                $this->approvalstatus = 9;
            }
            else
            {
                $this->approvalstatus = $row['STAGESERIALNUMBER'];
            }
            $query = "update nst_nasaka_finance.voucherheader v
            set v.approvalstatus=".$this->approvalstatus."
            where v.transactionnumber=".$this->transactionnumber;
            $result = oci_parse($this->connection, $query);
            if (oci_execute($result,OCI_NO_AUTO_COMMIT))
            {
                $voucheractiondetail1 = new voucheractiondetail($this->connection);
                $voucheractiondetail1->transactionnumber = $this->transactionnumber;
                $voucheractiondetail1->usercode = $_SESSION['usersid'];
                if ($approvalstatus == 9)
                {
                    $voucheractiondetail1->actioncode = 7;
                }
                else
                {
                    $voucheractiondetail1->actioncode = $actioncode;
                }
                $ret = $voucheractiondetail1->insert();
                if ($ret == 1)
                {
                    return 1;
                    exit;
                }
                else
                {
                    return 0;
                    exit;
                }
            }
            else
            {
                return 0;
                exit;
            }
        }
        else
        {
            return 0;
        }
    }
    public function updatecurrentdisapprovalstage($actioncode)
    {
        if ($this->approvalstatus==9)
        {
            return 0;
            exit;
        }
        if ($this->approvalstatus == '')
        {
            $responsibilitycode = 0;
            $approvalstatus=0;
        }
        else
        {
            $responsibilitycode = $_SESSION['responsibilitycode'];
            $approvalstatus=$this->approvalstatus;
        }
        $query = "update nst_nasaka_finance.voucherheader v
        set v.approvalstatus=".($this->approvalstatus*-1).",
            v.disapprovalreason=".$this->invl($this->disapprovalreason,false)."
        where v.transactionnumber=".$this->transactionnumber;
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            $voucheractiondetail1 = new voucheractiondetail($this->connection);
            $voucheractiondetail1->transactionnumber = $this->transactionnumber;
            $voucheractiondetail1->usercode = $_SESSION['usersid'];
            $voucheractiondetail1->actioncode = $actioncode;
            $ret = $voucheractiondetail1->insert();
            if ($ret == 1)
            {
                return 1;
                exit;
            }
            else
            {
                return 0;
                exit;
            }
        }
        else
        {
            return 0;
            exit;
        }
    }
    function isoppositeaccount()
    {
         $query = "select t.oppositeaccountcode 
         from nst_nasaka_finance.voucherchequedddetail t
         ,nst_nasaka_finance.voucherheader h
         where  t.transactionnumber=h.transactionnumber 
         and t.transactionnumber=".$this->transactionnumber;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
           if ($row['OPPOSITEACCOUNTCODE']>0)
            {
                return 1;
            }
            else
            {
               return 0; 
            }
        }
        else
        {
            return 0;    
        }
    }
    public function unlockvoucher()
    {
        $query = "update nst_nasaka_finance.voucherheader v 
        set v.approvalstatus=-1 
        where v.transactionnumber=".$this->transactionnumber;
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            //if ($this->voucherstatus>=1)
            //{
                $voucheractiondetail1 = new voucheractiondetail($this->connection);
                $voucheractiondetail1->transactionnumber = $this->transactionnumber;
                $voucheractiondetail1->usercode = $_SESSION['usersid'];
                $voucheractiondetail1->actioncode = 9;
                $ret = $voucheractiondetail1->insert();
                if ($ret == 1)
                {
                    return 1;
                    exit;
                }
                else
                {
                    return 0;
                    exit;
                }
            //}
            //else
            //{
            //    return 1;
            //    exit;
            //}
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function lockvoucher()
    {
        $query = "update nst_nasaka_finance.voucherheader v 
        set v.approvalstatus=null
        where v.transactionnumber=".$this->transactionnumber." 
        and v.approvalstatus=-1
        and v.vouchernumberprefixsufix is not null";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            //if ($this->voucherstatus>=1)
            //{
                $voucheractiondetail1 = new voucheractiondetail($this->connection);
                $voucheractiondetail1->transactionnumber = $this->transactionnumber;
                $voucheractiondetail1->usercode = $_SESSION['usersid'];
                $voucheractiondetail1->actioncode = 8;
                $ret = $voucheractiondetail1->insert();
                if ($ret == 1)
                {
                    return 1;
                    exit;
                }
                else
                {
                    return 0;
                    exit;
                }
            //}
            //else
            //{
            //    return 1;
            //    exit;
            //}
        }
        else
        {
            return 0;
            exit;
        }
    }
    function ischequenoentered()
    {
         $query = "select count(*) as cnt 
         from nst_nasaka_finance.voucherchequedddetail t
         ,nst_nasaka_finance.voucherheader h
         where funddocumentcode=1 and funddocumentnumber is null and t.transactionnumber=h.transactionnumber 
         and t.transactionnumber=".$this->transactionnumber;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
           if ($row['OPPOSITEACCOUNTCODE']>0)
            {
                return 1;
            }
            else
            {
               return 0; 
            }
        }
        else
        {
            return 0;    
        }
    }
}
?>

