<?php
//This is generated by Nigade Software Technologies (opc) Private Limited 03/09/2022 03:59:12 pm for PHP
require_once("../swappbase/formbase.php");
class employeetransaction extends swappform
{
    Public $transactionnumber;
    Public $employeecode;
    Public $transactioncategorycode;
    Public $fromdate;
    Public $basic;
    Public $gradecode;
    Public $gradecodetextcombo;
    Public $sectioncode;
    Public $sectioncodetextcombo;
    Public $pfcode;
    Public $pfcodetextcombo;
    Public $todate;
    public $employeecategorycode;
    public $salarypercent;
    public $designationcode;
    public function __construct(&$connection)
    {
     		 parent::__construct($connection);
         $this->transactionnumber='';
         $this->transactionnumbertextcombo='';
         $this->employeecode='';
         $this->employeecodetextcombo='';
         $this->transactioncategorycode='';
         $this->transactioncategorycodetextcombo='';
         $this->fromdate='';
         $this->fromdatetextcombo='';
         $this->basic='';
         $this->basictextcombo='';
         $this->gradecode='';
         $this->gradecodetextcombo='';
         $this->sectioncode='';
         $this->sectioncodetextcombo='';
         $this->pfcode='';
         $this->pfcodetextcombo='';
         $this->todate='';
         $this->todatetextcombo='';
	   }
    public function entryvalidation()
    {
    		$this->start_validation();
        $this->checkrequired($this->employeecode,'Employee Code','कर्मचारी कोड');
        $this->checkrequired($this->transactioncategorycode,'Transaction Category','व्यवहार प्रकार');
        $this->checkrequired($this->fromdate,'From Date','दिनांक पासून');
        $this->checkrequired($this->basic,'Basic','मूळ पगार');
        $this->checkrequired($this->gradecode,'Grade Pay','श्रेणी');
        $this->checkrequired($this->sectioncode,'Section','विभाग');
        $this->checkrequired($this->pfcode,'PF','पीएफ');
        $this->checkrequired($this->employeecategorycode,'Employee Category','कर्मचारी प्रकार');
        //$this->checkrequired($this->salarypercent,'Salary Percent','पगार टक्के');
        $this->checkrequired($this->designationcode,'Designation','हुद्दा');
        //$this->checkrequired($this->todate,'To Date','दिनांक पर्यंत');
        $this->end_validation();
        return $this->invalidid;
	  }
    private function datavalidation()
    {
        $this->start_validation();
    		$this->invalidid=0;
    		$this->invalidmessagetext='Validated';
    		$this->end_validation();
    		return $this->invalidid;
    }
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
	    if ($this->transactionnumber == '')
        {
            $query = "select nvl(max(transactionnumber),0)+1 as transactionnumber from employeetransaction";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->transactionnumber = $row["TRANSACTIONNUMBER"];
        }
        if ($this->fromdate!='')
        {
            $this->fromdate = DateTime::createFromFormat('d/m/Y',$this->fromdate)->format('d-M-Y');
        }
        if ($this->todate!='')
        {
            $this->todate = DateTime::createFromFormat('d/m/Y',$this->todate)->format('d-M-Y');
        }
        $query = "
            insert into employeetransaction(
            transactionnumber
            ,employeecode
            ,transactioncategorycode
            ,fromdate
            ,basic
            ,gradecode
            ,sectioncode
            ,pfcode
            ,todate
            ,employeecategorycode
            ,salarypercent
            ,designationcode
	        )
	        values (
            ".$this->invl($this->transactionnumber,true)."
            ,".$this->invl($this->employeecode,true)."
            ,".$this->invl($this->transactioncategorycode,true,true)."
            ,".$this->invl($this->fromdate,false)."
            ,".$this->invl($this->basic,true)."
            ,".$this->invl($this->gradecode,true,true)."
            ,".$this->invl($this->sectioncode,true,true)."
            ,".$this->invl($this->pfcode,true,true)."
            ,".$this->invl($this->todate,false)."
            ,".$this->invl($this->employeecategorycode,true,true)."
            ,".$this->invl($this->salarypercent,true,true)."
            ,".$this->invl($this->designationcode,true,true)."
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            $query1 = "update employeetransaction t
            set t.todate=(select case when fromdate is not null then fromdate-1 else null  end
            from (select max(fromdate) fromdate
                    from employeetransaction where 
                    employeecode=".$this->employeecode.") m)
             where 
              employeecode=".$this->employeecode." and todate is null and t.transactionnumber<>".$this->transactionnumber;
            $result1 = oci_parse($this->connection, $query1);
            if (oci_execute($result1,OCI_NO_AUTO_COMMIT))
            {  
                $query2 = "update employeetransaction e
                set e.todate=(select (select tt.FROMDATE-1 from vw_emptran tt
                where srno=cnt and tt.EMPLOYEECODE=t.EMPLOYEECODE ) todate from vw_emptran t
                where srno<>cnt and todate is null and t.TRANSACTIONNUMBER=e.transactionnumber
               union all 
                select null todate from vw_emptran t
                where srno=cnt and todate is not null and t.TRANSACTIONNUMBER=e.transactionnumber)
               where e.transactionnumber in (select transactionnumber from vw_emptran t
                where srno<>cnt and todate is null 
               union all 
                select transactionnumber from vw_emptran t
                where srno=cnt and todate is not null)";
                $result2 = oci_parse($this->connection, $query2);
                if (oci_execute($result1,OCI_NO_AUTO_COMMIT))
                {
                    $query = "
                insert into employeeallowance (
                employeecode
                ,serialnumber
                ,allowancecode
                ,fromdate
                ,todate
                ,rate
                ,ratecategorycode
                )
                select
                ".$this->employeecode."
                ,t.serialnumber
                ,t.allowancecode
                ,t.fromdate
                ,t.todate
                ,t.rate
                ,t.ratecategorycode
                from EMPLOYEEALLOWANCE t,employeetransaction e
                where t.employeecode=e.employeecode and e.employeecode in(6,2,324,5,530)
                and e.sectioncode=20
                 and e.employeecategorycode=".$this->invl($this->employeecategorycode,true,true)."
                order by t.serialnumber
                ";
                 $result = oci_parse($this->connection, $query);
                 oci_execute($result);
                 return 1;
                 exit;
                }
                else
                {
                    return 0;
                    exit;
                }
            }
            else
            {
                return 0;
                exit;
            }

            //----------
           
            //------------
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='';
		    if ($this->transactioncategorycode!='' and $this->transactioncategorycode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.transactioncategorycode = ".$this->transactioncategorycode;
			       }
			       else
			       {
				         $cond=$cond." and t.transactioncategorycode = ".$this->transactioncategorycode;
			       }
		    }
        if ($cond!='')
		    {
		        $query = "select t.* from employeetransaction t where ".$cond." order by transactionnumber";
			      $result = oci_parse($this->connection, $query);
            $r = oci_execute($result);
			      return $result;
		     }
		     else
		     {
		         $query = "select t.* from employeetransaction t order by transactionnumber";
			       $result = oci_parse($this->connection, $query);
             $r = oci_execute($result);
			       return $result;
		     }
	  }
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->fromdate = DateTime::createFromFormat('d/m/Y',$this->fromdate)->format('d-M-Y');
        if ($this->todate!='')
        $this->todate = DateTime::createFromFormat('d/m/Y',$this->todate)->format('d-M-Y');
        $query = "
        update employeetransaction set 
        employeecode = ".$this->invl($this->employeecode,true,true)."
        ,transactioncategorycode = ".$this->invl($this->transactioncategorycode,true,true)."
        ,fromdate =".$this->invl($this->fromdate,false)."
        ,basic = ".$this->invl($this->basic,true,true)."
        ,gradecode = ".$this->invl($this->gradecode,true,true)."
        ,sectioncode = ".$this->invl($this->sectioncode,true,true)."
        ,pfcode = ".$this->invl($this->pfcode,true,true)."
        ,todate =".$this->invl($this->todate,false)."
        ,employeecategorycode= ".$this->invl($this->employeecategorycode,true,true)."
        ,salarypercent= ".$this->invl($this->salarypercent,true,true)."
        ,designationcode= ".$this->invl($this->designationcode,true,true)."
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        /* if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        } */
        //$this->fromdate = DateTime::createFromFormat('d/m/Y',$this->fromdate)->format('d-M-Y');
        //$this->todate = DateTime::createFromFormat('d/m/Y',$this->todate)->format('d-M-Y');
        $query = "
        delete from employeetransaction
        where 
        transactionnumber =".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            $query = "
            update employeetransaction set 
            todate = null
            where 
            transactionnumber = ".$this->getlasttranaction();
            $result = oci_parse($this->connection, $query);
            if (oci_execute($result,OCI_NO_AUTO_COMMIT))
            {
                return 1;
                exit;
            }
            else
            {
                return 0;
                exit;
            }
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        transactionnumber
        ,employeecode
        ,transactioncategorycode
        ,fromdate
        ,todate
        ,basic
        ,gradecode
        ,sectioncode
        ,pfcode
        ,employeecategorycode
        ,salarypercent
        ,designationcode
        from employeetransaction where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->transactionnumber = $row['TRANSACTIONNUMBER'];
                $this->employeecode = $row['EMPLOYEECODE'];
                $this->transactioncategorycode = $row['TRANSACTIONCATEGORYCODE'];
                $this->fromdate = DateTime::createFromFormat('d-M-y',$row['FROMDATE'])->format('d/m/Y');
                if ($row['TODATE'] !='')
                $this->todate = DateTime::createFromFormat('d-M-y',$row['TODATE'])->format('d/m/Y');
                $this->basic = $row['BASIC'];
                $this->gradecode = $row['GRADECODE'];
                $this->sectioncode = $row['SECTIONCODE'];
                $this->pfcode = $row['PFCODE'];
                $this->employeecategorycode = $row['EMPLOYEECATEGORYCODE'];
                $this->gradecodetextcombo = $this->textcomboname($connection=$this->connection,$table='GRADE',$datafield='GRADECODE',$datafieldvalue=$row['GRADECODE'],$engfield='GRADENAMEENG',$unicodefield='GRADENAMEUNI');
                $this->pfcodetextcombo = $this->textcomboname($connection=$this->connection,$table='PFAPPLICABLE',$datafield='PFAPPLICABLECODE',$datafieldvalue=$row['PFCODE'],$engfield='PFAPPLICABLENAMEENG',$unicodefield='PFAPPLICABLENAMEUNI');
                $this->sectioncodetextcombo = $this->textcomboname($connection=$this->connection,$table='SECTIONMASTER',$datafield='SECTIONCODE',$datafieldvalue=$row['SECTIONCODE'],$engfield='SECTIONNAMEENG',$unicodefield='SECTIONNAMEUNI');
                $this->employeecategorycodetextcombo = $this->textcomboname($connection=$this->connection,$table='EMPLOYEECATEGORY',$datafield='EMPLOYEECATEGORYCODE',$datafieldvalue=$row['EMPLOYEECATEGORYCODE'],$engfield='EMPLOYEECATEGORYNAMEENG',$unicodefield='EMPLOYEECATEGORYNAMEUNI');
                $this->salarypercent = $row['SALARYPERCENT'];
                $this->designationcode= $row['DESIGNATIONCODE'];
                $this->designationcodetextcombo = $this->textcomboname($connection=$this->connection,$table='designation',$datafield='designationCODE',$datafieldvalue=$row['DESIGNATIONCODE'],$engfield='DESIGNATIONNAMEENG',$unicodefield='DESIGNATIONNAMEUNI');
                $this->found=true;
                return true;
        }
        else
        {
        return false;
        }
    }
    public function fetchall($employeecode)
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        transactionnumber
        ,to_char(fromdate,'dd/mm/yyyy') fromdate
        ,c.transactioncategorynameuni
        ,c.transactioncategorynameeng
        ,e.basic
        from employeetransaction e,
        transactioncategory c
        where 
        e.transactioncategorycode=c.transactioncategorycode 
        and e.employeecode = ".$this->invl($employeecode,true)."
        order by fromdate desc,transactionnumber desc";
        $result = oci_parse($this->connection, $query);
        return $result;
    }
    public function fetchlast($employeecode)
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "with mxdate as (select max(fromdate) fromdate
        from employeetransaction where 
        employeecode=".$this->invl($employeecode,true).")
        ,mxtrn as (select max(t.transactionnumber) trnnumber from employeetransaction t,mxdate d 
        where 
        employeecode=".$this->invl($employeecode,true)." and t.fromdate=d.fromdate)
        select t.*   
        from employeetransaction t,mxtrn d 
        where 
        employeecode=".$this->invl($employeecode,true)." and t.transactionnumber=d.trnnumber";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
                $this->transactionnumber = $row['TRANSACTIONNUMBER'];
                $this->employeecode = $row['EMPLOYEECODE'];
                $this->transactioncategorycode = $row['TRANSACTIONCATEGORYCODE'];
                //$this->fromdate = DateTime::createFromFormat('d-M-y',$row['FROMDATE'])->format('d/m/Y');
                if ($row['TODATE']!='')
                $this->todate = DateTime::createFromFormat('d-M-y',$row['TODATE'])->format('d/m/Y');
                $this->basic = $row['BASIC'];
                $this->gradecode = $row['GRADECODE'];
                $this->sectioncode = $row['SECTIONCODE'];
                $this->pfcode = $row['PFCODE'];
                $this->gradecodetextcombo = $this->textcomboname($connection=$this->connection,$table='GRADE',$datafield='GRADECODE',$datafieldvalue=$row['GRADECODE'],$engfield='GRADENAMEENG',$unicodefield='GRADENAMEUNI');
                $this->pfcodetextcombo = $this->textcomboname($connection=$this->connection,$table='PFAPPLICABLE',$datafield='PFAPPLICABLECODE',$datafieldvalue=$row['PFCODE'],$engfield='PFAPPLICABLENAMEENG',$unicodefield='PFAPPLICABLENAMEUNI');
                $this->sectioncodetextcombo = $this->textcomboname($connection=$this->connection,$table='SECTIONMASTER',$datafield='SECTIONCODE',$datafieldvalue=$row['SECTIONCODE'],$engfield='SECTIONNAMEENG',$unicodefield='SECTIONNAMEUNI');
                $this->salarypercent = $row['SALARYPERCENT'];
                $this->employeecategorycodetextcombo = $this->textcomboname($connection=$this->connection,$table='EMPLOYEECATEGORY',$datafield='EMPLOYEECATEGORYCODE',$datafieldvalue=$row['EMPLOYEECATEGORYCODE'],$engfield='EMPLOYEECATEGORYNAMEENG',$unicodefield='EMPLOYEECATEGORYNAMEUNI');
                $this->employeecategorycode = $row['EMPLOYEECATEGORYCODE'];
                $this->designationcodetextcombo = $this->textcomboname($connection=$this->connection,$table='designation',$datafield='DESIGNATIONCODE',$datafieldvalue=$row['DESIGNATIONCODE'],$engfield='DESIGNATIONNAMEENG',$unicodefield='DESIGNATIONNAMEUNI');
                $this->designationcode = $row['DESIGNATIONCODE'];
                $this->found=true;
                return true;
        }
        else
        {
        return false;
        }
    }
    public function seasonbreakemployee($employeecategorycode,$date)
    {
        $query = "select employeecode from 
        (select e.employeecode
        ,lastemployeecategory(e.employeecode) employeecategorycode 
        from employeemaster e) t
        where t.employeecategorycode=".$employeecategorycode;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            if ($this->fetchlast($row['EMPLOYEECODE'])==true)
            {
                if ($this->transactioncategorycode!=7 and $this->transactioncategorycode!=5 and $this->transactioncategorycode!=6 and $this->transactioncategorycode!=10 and $this->transactioncategorycode!=4)
                {
                    $this->transactionnumber='';
                    $this->fromdate = $date;
                    $this->todate = '';
                    $this->transactioncategorycode = 7;
                    $ret = $this->insert();
                    if ($ret==0)
                    {
                        return 0;
                        exit;
                    }
                }
            }
        }
        return 1;
    }
    public function islasttranaction()
    {
        $query = "select max(t.transactionnumber) transactionnumber 
        from EMPLOYEETRANSACTION t
        where t.employeecode=".$this->employeecode;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            if ($row['TRANSACTIONNUMBER'] == $this->transactionnumber)
            {
                return 1;
            }
            else
            {
                return 0;
            }
        }
        else
        {
            return 0;
        }
    }
    public function getlasttranaction()
    {
        $query = "select max(t.transactionnumber) transactionnumber 
        from EMPLOYEETRANSACTION t
        where t.employeecode=".$this->employeecode;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            return $row['TRANSACTIONNUMBER'];
        }
        else
        {
            return 0;
        }
    }
}
?>

