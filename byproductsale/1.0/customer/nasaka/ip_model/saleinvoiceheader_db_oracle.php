<?php
//This is generated by Swapp Software Application on 17/03/2019 11:12:38 AM for PHP
require_once("../swappbase/formbase.php");
require_once("../ip_model/goodspurchaser_db_oracle.php");
class saleinvoiceheader extends swappform
{
    Public $transactionnumber;
    Public $goodscategorycode;
    Public $salecategorycode;
    Public $yearperiodcode;
    Public $saleinvoicenumberseriesid;
    Public $saleinvoicenumberbasevalue;
    Public $invoicenumber;
    Public $invoicenumberpresuf;
    Public $invoicedate;
    Public $purchasercode;
    Public $shippingpartycode;
    Public $preparationtime;
    Public $removaltime;
    Public $vehiclenumber;
    Public $drivername;
    Public $driverlicenseno;
    Public $cgstamount;
    Public $sgstamount;
    Public $igstamount;
    Public $ugstamount;
    Public $vatamount;
    Public $tcsamount;
    Public $totaltaxamount;
    Public $grossamount;
    Public $taxableamount;
    Public $weightslipnumber;
    Public $loadweight;
    Public $emptyweight;
    Public $netweight;

    public $purchaser;
    public $shiftto;
    public $broker;
    Public $salecategorynameeng;
    Public $salecategorynameuni;
    public $acknumber;
    Public $irnnumber;
    Public $ackdate;
    public function __construct(&$connection)
    {
     	 parent::__construct($connection);
         $this->transactionnumber='';
         $this->goodscategorycode='';
         $this->salecategorycode='';
         $this->yearperiodcode='';
         $this->invoicenumber='';
         $this->invoicenumberpresuf='';
         $this->invoicedate='';
         $this->purchasercode='';
         $this->shippingpartycode='';
         $this->preparationtime='';
         $this->removaltime='';
         $this->vehiclenumber='';
         $this->drivername='';
         $this->driverlicenseno='';
	}
    private function entryvalidation()
    {
    	$this->start_validation();
        $this->checkrequired($this->invoicedate,'Invoice Date');
        $this->checkrequired($this->purchasercode,'Purchaser Name');
        $this->checkrequired($this->preparationtime,'Preparation Time');
        $this->checkrequired($this->removaltime,'Removal Time');
        $this->checkrequired($this->salecategorycode,'Sale Category');
        $this->end_validation();
        return $this->invalidid;
	  }
    private function datavalidation()
    {
        $this->start_validation();
        /* if ($this->balance($this->purchasercode)>=0)
        {
            $this->invalidid=-250;
            $this->invalidmessagetext='Insufficient Balance';
        }
        else */
        if ($this->salecategorycode==0)
        {
            $this->invalidid=-250;
            $this->invalidmessagetext='Sale Category Not Selected';
        }
        else
        {
            $this->invalidid=0;
            $this->invalidmessagetext='Validated';
        }
        
        $this->end_validation();
        return $this->invalidid;
    }
    public function generatesaleinvoicenumber()
	{
        if (!isset($this->invoicenumber) or $this->invoicenumber == '' )
        {
            $query = "select nvl(d.salenumberprefix,'') as salenumberprefix,periodresetcategorycode,transactioncategorycode from salenumberseries d where d.salenumberseriesid=".$this->saleinvoicenumberseriesid." and d.goodscategorycode=".$this->goodscategorycode;
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
            if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
            {
                switch ($row['PERIODRESETCATEGORYCODE'])
                {
                    case 1:
                    {
                        $prefix = $row["SALENUMBERPREFIX"];
                        //Sale invoice transactioncategorycode=2
                        if ($row['TRANSACTIONCATEGORYCODE']==4)
                        {
                            //$invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
                            $query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,salenumberbasevalue('".$this->invoicedate."',1) as invoicenumberbasevalue  from saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and saleinvoicenumberbasevalue=salenumberbasevalue('".$this->invoicedate."',1) and saleinvoicenumberseriesid=".$this->saleinvoicenumberseriesid;
                        }
                        
                        $result_12 = oci_parse($this->connection, $query_12);
                        $r = oci_execute($result_12);
                        $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                        $THIS->invoicenumber = $ROW_12["INVOICENUMBER"];
                        $this->invoicenumberpresuf = $prefix.str_pad($row_12["INVOICENUMBER"],5,'0',STR_PAD_LEFT);
                        $this->invoicenumberbasevalue = $row_12["INVOICENUMBERBASEVALUE"];
                        break;
                    }
                    case 2:
                    {
                        $prefix = $row["SALENUMBERPREFIX"];
                        //Sale invoice transactioncategorycode=2
                        if ($row['TRANSACTIONCATEGORYCODE']==4)
                        {
                            //$invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
                            $query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,salenumberbasevalue('".$this->invoicedate."',2) as invoicenumberbasevalue  from saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and saleinvoicenumberbasevalue=salenumberbasevalue('".$this->invoicedate."',2) and saleinvoicenumberseriesid=".$this->saleinvoicenumberseriesid;
                        }
                        
                        //$query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,salenumberbasevalue('".$saledate."',2) as invoicenumberbasevalue from saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and invoicenumberbasevalue=salenumberbasevalue('".$saledate."',2) and invoicenumberseriesid=".$this->invoicenumberseriesid;
                        $result_12 = oci_parse($this->connection, $query_12);
                        $r = oci_execute($result_12);
                        $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                        $this->invoicenumber = $row_12["INVOICENUMBER"];
                        $this->invoicenumberpresuf = $prefix.str_pad($row_12["INVOICENUMBER"],5,'0',STR_PAD_LEFT);
                        $this->invoicenumberbasevalue = $row_12["INVOICENUMBERBASEVALUE"];
                        break;
                    }
                    case 3:
                    {
                        $prefix = $row["SALENUMBERPREFIX"];
                        //Sale invoice transactioncategorycode=2
                        if ($row['TRANSACTIONCATEGORYCODE']==4)
                        {
                            //$invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
                            $query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,salenumberbasevalue('".$this->invoicedate."',3) as invoicenumberbasevalue  from saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and saleinvoicenumberbasevalue=salenumberbasevalue('".$this->invoicedate."',3) and saleinvoicenumberseriesid=".$this->saleinvoicenumberseriesid;
                        }
                        //$query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,salenumberbasevalue('".$saledate."',3) as invoicenumberbasevalue from saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and invoicenumberbasevalue=salenumberbasevalue('".$saledate."',3) and invoicenumberseriesid=".$this->invoicenumberseriesid;
                        $result_12 = oci_parse($this->connection, $query_12);
                        $r = oci_execute($result_12);
                        $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                        $this->invoicenumber = $row_12["INVOICENUMBER"];
                        $this->invoicenumberpresuf = $prefix.str_pad($row_12["INVOICENUMBER"],5,'0',STR_PAD_LEFT);
                        $this->invoicenumberbasevalue = $row_12["INVOICENUMBERBASEVALUE"];
                        break;
                    }
                    case 4:
                    {
                        $prefix = $row["SALENUMBERPREFIX"];
                        if ($row['TRANSACTIONCATEGORYCODE']==4)
                        {
                            if ($this->goodscategorycode==2)
                            {
                                $invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
                            }
                            else
                            {
                                $invoicedate=$this->invoicedate;
                            }
                            $query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,salenumberbasevalue('".$invoicedate."',4) as invoicenumberbasevalue  from saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and saleinvoicenumberbasevalue=salenumberbasevalue('".$invoicedate."',4) and saleinvoicenumberseriesid=".$this->saleinvoicenumberseriesid;
                        }
                        /* if ($row['TRANSACTIONCATEGORYCODE']==6)
                        {
                            //$invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
                            $query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,salenumberbasevalue('".$this->invoicedate."',4) as invoicenumberbasevalue  from saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and saleinvoicenumberbasevalue=salenumberbasevalue('".$this->invoicedate."',4) and saleinvoicenumberseriesid=".$this->saleinvoicenumberseriesid;
                        } */
                        //$query_12 = "select nvl(max(invoicenumber),0)+1 as invoicenumber,salenumberbasevalue('".$saledate."',4) as invoicenumberbasevalue from saleinvoiceheader where yearperiodcode=".$this->yearperiodcode." and invoicenumberbasevalue=salenumberbasevalue('".$saledate."',4) and invoicenumberseriesid=".$this->invoicenumberseriesid;
                        $result_12 = oci_parse($this->connection, $query_12);
                        $r = oci_execute($result_12);
                        $row_12 = oci_fetch_array($result_12,OCI_ASSOC+OCI_RETURN_NULLS);
                        $this->invoicenumber = $row_12["INVOICENUMBER"];
                        $this->invoicenumberpresuf = $prefix.'/'.substr($this->yearperiodcode,2,2).substr($this->yearperiodcode,6,2).'/'.str_pad($row_12["INVOICENUMBER"],5,'0',STR_PAD_LEFT);
                        $this->saleinvoicenumberbasevalue = $row_12["INVOICENUMBERBASEVALUE"];
                        break;
                    }
                }
                return 1;
                exit;
            }
            else
            {
                return 0;
                exit;
            }
        }
        else
        {
            return 0;
            exit;
        }
	}
    public function insert()
    {
        $this->dataoperationmode = operationmode::Insert;
	    if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        if ($this->saleinvoicenumberseriesid == '')
        {
            $query = "select s.saleinvoicenumberseriesid
            from salecategory s
            where salecategorycode=".$this->salecategorycode;
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->saleinvoicenumberseriesid = $row["SALEINVOICENUMBERSERIESID"];
        }
	    if ($this->transactionnumber == '')
        {
            $query = "select nvl(max(transactionnumber),0)+1 as transactionnumber from saleinvoiceheader";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
            $row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS);
            $this->transactionnumber = $row["TRANSACTIONNUMBER"];
        }
        if ($this->invoicedate!='')
        {
            $this->invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
        }
        if ($this->preparationtime!='')
        {
            $this->preparationtime = DateTime::createFromFormat('d/m/Y H:i',$this->preparationtime)->format('d-M-Y H:i');
        }
        if ($this->removaltime!='')
        {
            $this->removaltime = DateTime::createFromFormat('d/m/Y H:i',$this->removaltime)->format('d-M-Y H:i');
        }
        if ($this->goodscategorycode!=2)
        {
            $this->generatesaleinvoicenumber();
        }
        $query = "
            insert into saleinvoiceheader(
            transactionnumber
            ,goodscategorycode
            ,salecategorycode
            ,yearperiodcode
            ,saleinvoicenumberseriesid
            ,saleinvoicenumberbasevalue
            ,invoicenumber
            ,invoicenumberpresuf
            ,invoicedate
            ,purchasercode
            ,shippingpartycode
            ,preparationtime
            ,removaltime
            ,vehiclenumber
            ,drivername
            ,driverlicenseno
            ,cgstamount
            ,sgstamount
            ,igstamount
            ,ugstamount
            ,tcsamount
            ,vatamount
            ,totaltaxamount
            ,grossamount
            ,taxableamount
            ,weightslipnumber
            ,loadweight
            ,emptyweight
            ,netweight
	        )
	        values (
            ".$this->invl($this->transactionnumber,true)."
            ,".$this->invl($this->goodscategorycode,true)."
            ,".$this->invl($this->salecategorycode,true,true)."
            ,".$this->invl($this->yearperiodcode,true)."
            ,".$this->invl($this->saleinvoicenumberseriesid,true)."
            ,".$this->invl($this->saleinvoicenumberbasevalue,false)."
            ,".$this->invl($this->invoicenumber,true)."
            ,".$this->invl($this->invoicenumberpresuf,false)."
            ,".$this->invl($this->invoicedate,false)."
            ,".$this->invl($this->purchasercode,true,true)."
            ,".$this->invl($this->shippingpartycode,true,true)."
            ,to_date(".$this->invl($this->preparationtime,false).",'dd-mon-yyyy hh24:mi')
            ,to_date(".$this->invl($this->removaltime,false).",'dd-mon-yyyy hh24:mi')
            ,".$this->invl($this->vehiclenumber,false)."
            ,".$this->invl($this->drivername,false)."
            ,".$this->invl($this->driverlicenseno,false)."
            ,".$this->invl($this->cgstamount,true)."
            ,".$this->invl($this->sgstamount,true)."
            ,".$this->invl($this->igstamount,true)."
            ,".$this->invl($this->ugstamount,true)."
            ,".$this->invl($this->tcsamount,true)."
            ,".$this->invl($this->vatamount,true)."
            ,".$this->invl($this->totaltaxamount,true)."
            ,".$this->invl($this->grossamount,true)."
            ,".$this->invl($this->taxableamount,true)."
            ,".$this->invl($this->weightslipnumber,true)."
            ,".$this->invl($this->loadweight,true)."
            ,".$this->invl($this->emptyweight,true)."
            ,".$this->invl($this->netweight,true)."
            )";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            return 1;
            exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function display()
	  {
		    $this->dataoperationmode = operationmode::Select;
		    $cond='';
		    if ($this->salecategorycode!='' and $this->salecategorycode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.salecategorycode = ".$this->salecategorycode;
			       }
			       else
			       {
				         $cond=$cond." and t.salecategorycode = ".$this->salecategorycode;
			       }
		    }
		    if ($this->invoicenumber!='' and $this->invoicenumber!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.invoicenumber = ".$this->invoicenumber;
			       }
			       else
			       {
				         $cond=$cond." and t.invoicenumber = ".$this->invoicenumber;
			       }
		    }
		    if ($this->invoicenumberpresuf!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.invoicenumberpresuf like '%".$this->invoicenumberpresuf."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.invoicenumberpresuf like '%".$this->invoicenumberpresuf."%'";
			       }
		    }
		    if ($this->invoicedate!='')
		    {
			      $this->invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
			      if ($cond=='')
			      {
				        $cond="t.invoicedate = '".$this->invoicedate."'";
			       }
			       else
			       {
				         $cond=$cond." and t.invoicedate = '".$this->invoicedate."'";
			       }
		    }
		    if ($this->brokercode!='' and $this->brokercode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.brokercode = ".$this->brokercode;
			       }
			       else
			       {
				         $cond=$cond." and t.brokercode = ".$this->brokercode;
			       }
		    }
		    if ($this->purchasercode!='' and $this->purchasercode!=0)
		    {
			      if ($cond=='')
			      {
				        $cond="t.purchasercode = ".$this->purchasercode;
			       }
			       else
			       {
				         $cond=$cond." and t.purchasercode = ".$this->purchasercode;
			       }
		    }
		    if ($this->vehiclenumber!='')
		    {
			      if ($cond=='')
			      {
				        $cond="t.vehiclenumber like '%".$this->vehiclenumber."%'";
			       }
			       else
			       {
				         $cond=$cond." and t.vehiclenumber like '%".$this->vehiclenumber."%'";
			       }
		    }
        if ($cond!='')
		    {
		        $query = "select t.* from saleinvoiceheader t where ".$cond." and goodscategorycode=".$this->goodscategorycode." order by transactionnumber";
			    $result = oci_parse($this->connection, $query);
                $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
			    return $result;
		    }
		    else
		    {
		        $query = "select t.* from saleinvoiceheader t where goodscategorycode=".$this->goodscategorycode." order by transactionnumber"; 
			    $result = oci_parse($this->connection, $query);
                $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
			    return $result;
		    }
	  }
    public function update()
    {
        $this->dataoperationmode = operationmode::Update;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
        $this->preparationtime = DateTime::createFromFormat('d/m/Y H:i',$this->preparationtime)->format('d-M-Y H:i');
        $this->removaltime = DateTime::createFromFormat('d/m/Y H:i',$this->removaltime)->format('d-M-Y H:i');
        $query = "
        update saleinvoiceheader set 
        goodscategorycode = ".$this->invl($this->goodscategorycode,true)."
        ,salecategorycode = ".$this->invl($this->salecategorycode,true)."
        ,yearperiodcode = ".$this->invl($this->yearperiodcode,true)."
        ,saleinvoicenumberseriesid = ".$this->invl($this->saleinvoicenumberseriesid,true)."
        ,saleinvoicenumberbasevalue = ".$this->invl($this->saleinvoicenumberbasevalue,false)."
        ,invoicenumber = ".$this->invl($this->invoicenumber,true)."
        ,invoicenumberpresuf =".$this->invl($this->invoicenumberpresuf,false)."
        ,invoicedate =".$this->invl($this->invoicedate,false)."
        ,purchasercode = ".$this->invl($this->purchasercode,true)."
        ,shippingpartycode = ".$this->invl($this->shippingpartycode,true)."
        ,preparationtime = to_date(".$this->invl($this->preparationtime,false).",'dd-mon-yyyy hh24:mi')
        ,removaltime = to_date(".$this->invl($this->removaltime,false).",'dd-mon-yyyy hh24:mi')
        ,vehiclenumber =".$this->invl($this->vehiclenumber,false)."
        ,drivername =".$this->invl($this->drivername,false)."
        ,driverlicenseno =".$this->invl($this->driverlicenseno,false)."
        ,cgstamount = ".$this->invl($this->cgstamount,true)."
        ,sgstamount = ".$this->invl($this->sgstamount,true)."
        ,igstamount = ".$this->invl($this->igstamount,true)."
        ,ugstamount = ".$this->invl($this->ugstamount,true)."
        ,vatamount = ".$this->invl($this->vatamount,true)."
        ,tcsamount = ".$this->invl($this->tcsamount,true)."
        ,totaltaxamount = ".$this->invl($this->totaltaxamount,true)."
        ,grossamount = ".$this->invl($this->grossamount,true)."
        ,taxableamount = ".$this->invl($this->taxableamount,true)." 
        ,weightslipnumber = ".$this->invl($this->weightslipnumber,true)." 
        ,loadweight = ".$this->invl($this->loadweight,true)." 
        ,emptyweight = ".$this->invl($this->emptyweight,true)." 
        ,netweight  = ".$this->invl($this->netweight,true)." 
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
            $sql = 'BEGIN byproductsaleinvheader_update(:p_transactionnumber); END;';
            $result = oci_parse($this->connection,$sql);
            oci_bind_by_name($result,':p_transactionnumber',$transactionnumber,20);
            $transactionnumber=$this->transactionnumber;
            $r=oci_execute($result);
            return 1;
        }
            else
        {
            return 0;
            exit;
        }
    }
    public function delete()
    {
        $this->dataoperationmode = operationmode::Delete;
        if ($this->entryvalidation() <> 0)
        {
            return 0;
            exit;
        }
        elseif ($this->datavalidation() <> 0)
        {
            return 0;
            exit;
        }
        $this->invoicedate = DateTime::createFromFormat('d/m/Y',$this->invoicedate)->format('d-M-Y');
        $query = "
        delete from saleinvoiceheader
        where 
        transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        if (oci_execute($result,OCI_NO_AUTO_COMMIT))
        {
             return 1;
             exit;
        }
        else
        {
            return 0;
            exit;
        }
    }
    public function fetch()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        h.transactionnumber
        ,h.goodscategorycode
        ,h.salecategorycode
        ,yearperiodcode
        ,h.saleinvoicenumberseriesid
        ,saleinvoicenumberbasevalue
        ,invoicenumber
        ,invoicenumberpresuf
        ,invoicedate
        ,purchasercode
        ,shippingpartycode
        ,to_char(preparationtime,'DD-MON-YYYY HH24:MI') as preparationtime
        ,to_char(removaltime,'DD-MON-YYYY HH24:MI') as removaltime
        ,vehiclenumber
        ,drivername
        ,driverlicenseno
        ,cgstamount
        ,sgstamount
        ,igstamount
        ,ugstamount
        ,tcsamount
        ,totaltaxamount
        ,grossamount
        ,s.salecategorynameeng
        ,s.salecategorynameuni
        ,taxableamount
        ,weightslipnumber
        ,loadweight
        ,emptyweight
        ,netweight
        ,virn_number
        ,vack_no
       -- ,to_char(vack_date,'DD-MON-YYYY HH24:MI') as vack_date
       ,vack_date
        ,vqr_location
        from nst_nasaka_byproductsale.saleinvoiceheader h
        ,nst_nasaka_byproductsale.salecategory s 
        where h.salecategorycode=s.salecategorycode
        and h.transactionnumber = ".$this->invl($this->transactionnumber,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $this->transactionnumber = $row['TRANSACTIONNUMBER'];
            $this->goodscategorycode = $row['GOODSCATEGORYCODE'];
            $this->salecategorycode = $row['SALECATEGORYCODE'];
            $this->yearperiodcode = $row['YEARPERIODCODE'];
            $this->saleinvoicenumberseriesid = $row['SALEINVOICENUMBERSERIESID'];
            $this->saleinvoicenumberbasevalue = $row['SALEINVOICENUMBERBASEVALUE'];
            $this->invoicenumber = $row['INVOICENUMBER'];
            $this->invoicenumberpresuf = $row['INVOICENUMBERPRESUF'];
            $this->invoicedate = DateTime::createFromFormat('d-M-y',$row['INVOICEDATE'])->format('d/m/Y');
            $this->purchasercode = $row['PURCHASERCODE'];
            $this->shippingpartycode = $row['SHIPPINGPARTYCODE'];
            $this->preparationtime = DateTime::createFromFormat('d-M-Y H:i',$row['PREPARATIONTIME'])->format('d/m/Y H:i');
            $this->removaltime = DateTime::createFromFormat('d-M-Y H:i',$row['REMOVALTIME'])->format('d/m/Y H:i');
            $this->vehiclenumber = $row['VEHICLENUMBER'];
            $this->drivername = $row['DRIVERNAME'];
            $this->driverlicenseno = $row['DRIVERLICENSENO'];
            $this->cgstamount = $row['CGSTAMOUNT'];
            $this->sgstamount = $row['SGSTAMOUNT'];
            $this->igstamount = $row['IGSTAMOUNT'];
            $this->ugstamount = $row['UGSTAMOUNT'];
            $this->vatamount = $row['VATAMOUNT'];
            $this->tcsamount = $row['TCSAMOUNT'];
            $this->totaltaxamount = $row['TOTALTAXAMOUNT'];
            $this->grossamount = $row['GROSSAMOUNT'];
            $this->taxableamount = $row['TAXABLEAMOUNT'];
            $this->weightslipnumber = $row['WEIGHTSLIPNUMBER'];
            $this->loadweight = $row['LOADWEIGHT'];
            $this->emptyweight = $row['EMPTYWEIGHT'];
            $this->netweight = $row['NETWEIGHT'];
            $this->acknumber=$row['VACK_NO'];
            $this->irnnumber=$row['VIRN_NUMBER'];
            $this->ackdate=$row['VACK_DATE'];
            $broker1 = new goodspurchaser($this->connection);
            $broker1->purchasercode = $this->brokercode;
            $broker1->goodscategorycode = $this->goodscategorycode;
            $broker1->fetch();
            if ($_SESSION['lng']=="English")
            {
                $this->broker = $broker1->purchasernameeng;
            }
            else
            {
                $this->broker = $broker1->purchasernameuni; 
            }

            $goodspurchaser1 = new goodspurchaser($this->connection);
            $goodspurchaser1->purchasercode = $this->purchasercode;
            $goodspurchaser1->goodscategorycode = $this->goodscategorycode;
            $goodspurchaser1->fetch();
            if ($_SESSION['lng']=="English")
            {
                $this->purchaser = $goodspurchaser1->purchasernameeng;
            }
            else
            {
                $this->purchaser = $goodspurchaser1->purchasernameuni; 
            }
            $shiftto1 = new goodspurchaser($this->connection);
            $shiftto1->purchasercode = $this->shippingpartycode;
            $shiftto1->goodscategorycode = $this->goodscategorycode;
            $shiftto1->fetch();
            if ($_SESSION['lng']=="English")
            {
                $this->shiftto = $shiftto1->purchasernameeng;
            }
            else
            {
                $this->shiftto = $shiftto1->purchasernameuni; 
            }
            $this->salecategorynameeng = $row['SALECATEGORYNAMEENG'];
            $this->salecategorynameuni = $row['SALECATEGORYNAMEUNI'];
            $this->found=true;
            return true;
        }
        else
        {
        return false;
        }
    }
    public function isinvoiceexist()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select count(*) as cnt 
        from saleinvoiceheader h
        where h.goodscategorycode = ".$this->goodscategorycode." 
        and h.saleinvoicetransactionnumber = ".$this->transactionnumber;
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            if ($row['CNT']==0)
            {
                return false;
            }
            else
            {
                return true;
            }
        }
        else
        {
            return false;
        }
    }
     public function tendercategory()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        t.tendercategorycode 
        from goodscategory t 
        where t.goodscategorycode= ".$this->invl($this->goodscategorycode,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            return $row['TENDERCATEGORYCODE'];
        }
        else
        {
         return 0;   
        }
    }
      public function hsncode()
    {
        $this->dataoperationmode = operationmode::Select;
        $query = "select 
        t.hsncode
        from goodscategory t 
        where t.goodscategorycode= ".$this->invl($this->goodscategorycode,true)."
        ";
        $result = oci_parse($this->connection, $query);
        $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
        if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            return $row['HSNCODE'];
        }
        else
        {
         return 0;   
        }
    }

    public function balance($purchasercode)
    {
        $this->dataoperationmode = operationmode::Select;
        $query1 = "select t.debtorsaccountcode,s.prefix 
        from salecontroltable t,nst_nasaka_finance.subledgertype s 
        where t.subledgertypecode=s.subledgertypecode(+) 
        and t.goodscategorycode=".$this->goodscategorycode;
        $result1 = oci_parse($this->connection, $query1);
        $r1 = oci_execute($result1,OCI_NO_AUTO_COMMIT);
        if ($row1 = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $query = "select subledger,sum(clearbalance+uncleardebit) as balance 
            from (
            select subledgercode as subledger,nst_nasaka_finance.subaccountclosingbalance(p_yearcode => ".$_SESSION['yearperiodcode'].",p_accountcode => ".$row1['DEBTORSACCOUNTCODE'].",p_subledgercode => p.subledgercode) as clearbalance,0 as uncleardebit
            from (select t.subledgercode 
            from nst_nasaka_finance.accountsubledger t
            where t.accountcode=".$row1['DEBTORSACCOUNTCODE']." and t.referencecode='".$row1['PREFIX']."'||".$purchasercode.")p
            union all
            select g.subledgercode,0 as clearbalance,nvl(sum(h.grossamount),0) as uncleardebit 
            from nst_nasaka_byproductsale.saleinvoiceheader h
            ,nst_nasaka_byproductsale.goodspurchaser p
            ,nst_nasaka_finance.accountsubledger g 
            where h.purchasercode=p.purchasercode
            and g.accountcode=".$row1['DEBTORSACCOUNTCODE']." 
            and to_number(substr(g.referencecode,2,10))=p.purchasercode
            and p.purchasercode=".$purchasercode."
            group by g.subledgercode) t
            group by subledger";
            $result = oci_parse($this->connection, $query);
            $r = oci_execute($result,OCI_NO_AUTO_COMMIT);
            if ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
            {
                return $row['BALANCE'];
            }
            else
            {
                return 0;
            }
        }
        else
        {
            return 0;
        }
    }
    Public function vouchertofinanceposting($action)
    {
        $ret=1;
        if ($action==1)
        {
            $ret=$this->generatesaleinvoicenumber();
            if ($ret==1)
            {
                $ret=$this->update();
            }
            else
            {
                $ret=0;
            }
        }
        if ($ret==1)
        {
            $transactionnumber=$this->transactionnumber;
            $goodscategorycode=$this->goodscategorycode;
            $act=1;
            $ret=1;
            $sql = 'BEGIN BySale_Bill_Swapp_Posting(:p_saletransactionnumber,:p_goodscategorycode,:p_action,:p_ret); END;';
            $result = oci_parse($this->connection,$sql);
            oci_bind_by_name($result,':p_saletransactionnumber',$transactionnumber,20,SQLT_INT);
            oci_bind_by_name($result,':p_goodscategorycode',$goodscategorycode,10,SQLT_INT);
            oci_bind_by_name($result,':p_action',$act,10,SQLT_INT);
            oci_bind_by_name($result,':p_ret',$ret,10,SQLT_INT);
            $p_ret=oci_execute($result);
            if ($p_ret==1)
            { 
                return 1;
             }
            else
            {
                return 0;
            }
        }
        exit;
    }
    public function getqrimage()
    {
        $query = "SELECT einv_qr_file as image FROM saleinvoiceheader WHERE transactionnumber =".$this->invl($this->transactionnumber,true);
        $result = oci_parse($this->connection, $query);
        oci_execute($result);
        $row = oci_fetch_array($result, OCI_ASSOC+OCI_RETURN_NULLS);
        if ($row['IMAGE']!='')
        $img = $row['IMAGE']->load();
        else
        $img =='';
        return $img;
    }
}
?>