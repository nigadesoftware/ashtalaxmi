<?php
    //This is generated by Swapp Software Application on 01/03/2019 08:16:54 PM for PHP
    require("../info/phpsqlajax_dbinfo.php");
    require("../info/phpgetloginview.php");
    require("../info/routine.php");
    require_once("../ip_model/saleinvoiceheader_db_oracle.php");
    require_once("../ip_model/goodspurchaser_db_oracle.php");
    $connection =swapp_connection();
    $searchTerm = $_GET['term'];
    $transactionnumber = $_GET['transactionnumber'];
    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    elseif (strlen($searchTerm)<3 and $searchTerm != '**')
    {
        exit;
    }
    $saleinvoiceheader1=new saleinvoiceheader($connection);
    $saleinvoiceheader1->transactionnumber=$transactionnumber;
    $saleinvoiceheader1->fetch();
    $tendercategorycode = $saleinvoiceheader1->tendercategory();
    $purchasercode= $saleinvoiceheader1->purchasercode;
    $invoicedate= $saleinvoiceheader1->invoicedate;
    $goodscategorycode=$saleinvoiceheader1->goodscategorycode;
    $salecategorycode=$saleinvoiceheader1->salecategorycode;
    $goodspurchaser1=new goodspurchaser($connection);
    $goodspurchaser1->purchasercode=$purchasercode;
    $goodspurchaser1->goodscategorycode=$goodscategorycode;
    $goodspurchaser1->fetch();
    $statecode=$goodspurchaser1->statecode;
    $invoicedate = DateTime::createFromFormat('d/m/Y',$invoicedate)->format('d-M-Y');
    if ($tendercategorycode==1)
    {
        if ($searchTerm == '**')
        {
            $query = "select b.finishedgoodscode
                ,b.finishedgoodsnameeng
                ,b.finishedgoodsnameuni
                ,b.orderrate
                ,b.balancequantity
                ,b.tendernumberpresuf
                ,b.tendertransactionnumber
                ,b.ordertransactionnumber
                ,b.productionyearcode
                ,b.balancequantity        
                from brokerwiseliftedunlifted b 
                where goodscategorycode=".$goodscategorycode." and b.brokercode=".$purchasercode." and b.balancequantity>0";
        }
        else
        {
            $query = "select b.finishedgoodscode
                ,b.finishedgoodsnameeng
                ,b.finishedgoodsnameuni
                ,b.orderrate
                ,b.balancequantity
                ,b.tendernumberpresuf
                ,b.tendertransactionnumber
                ,b.ordertransactionnumber
                ,b.productionyearcode
                ,b.balancequantity
                from brokerwiseliftedunlifted b 
                where goodscategorycode=".$goodscategorycode." and b.purchasercode=".$purchasercode." and b.balancequantity>0 and (upper(FINISHEDGOODSNAMEENG) like upper('%".$searchTerm."%')
            or FINISHEDGOODSNAMEUNI like '%".$searchTerm."%'
            or to_char(FINISHEDGOODSCODE) like '".$searchTerm."')";
        }
    }
    elseif ($tendercategorycode==2)
    {
        if ($searchTerm == '**')
        {
            $query = "select b.finishedgoodscode
                ,b.finishedgoodsnameeng
                ,b.finishedgoodsnameuni
                ,r.salerate 
                from finishedgoods b,finishedgoodsratemaster r 
                where b.finishedgoodscode=r.finishedgoodscode
                and r.fromdate<='".$invoicedate."' and r.todate>='".$invoicedate."'
                and b.goodscategorycode=".$goodscategorycode;
        }
        else
        {
            $query = "select b.finishedgoodscode
                ,b.finishedgoodsnameeng
                ,b.finishedgoodsnameuni
                ,r.salerate 
                from finishedgoods b,finishedgoodsratemaster r 
                where b.finishedgoodscode=r.finishedgoodscode
                and r.fromdate<='".$invoicedate."' and r.todate>='".$invoicedate."'
                and b.goodscategorycode=".$goodscategorycode." 
                and (upper(FINISHEDGOODSNAMEENG) like upper('%".$searchTerm."%')
            or FINISHEDGOODSNAMEUNI like '%".$searchTerm."%'
            or to_char(FINISHEDGOODSCODE) like '".$searchTerm."')";
        }
    }
    
   
   $result = oci_parse($connection, $query); 
   $r = oci_execute($result);
   while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
   {
       $id = $row['FINISHEDGOODSCODE'];
       if ($tendercategorycode==1)
       {
            $orderrate = $row['ORDERRATE'];
            $balancequantity = $row['BALANCEQUANTITY'];
            $tendernumberpresuf = $row['TENDERNUMBERPRESUF'];
            $tendertransactionnumber = $row['TENDERTRANSACTIONNUMBER'];
            $ordertransactionnumber = $row['ORDERTRANSACTIONNUMBER'];
            $productionyearcode = $row['PRODUCTIONYEARCODE'];
            $balancequantity = $row['BALANCEQUANTITY'];
       }
       elseif ($tendercategorycode==2)
       {
            $orderrate = $row['SALERATE'];
            $balancequantity = '';
            $tendernumberpresuf ='';
            $tendertransactionnumber = '';
            $ordertransactionnumber = '';
            $productionyearcode = '';
            $balancequantity = '';
       }
       
       // tax rate start

       $query1 = "select t.taxcode,t.taxpercent,nvl(t.tcs,0) tcs
        from goodstaxrate t
        where t.fromdate<='". $invoicedate."'
        and t.todate>='". $invoicedate."' and t.finishedgoodscode=".$row['FINISHEDGOODSCODE']." 
        and t.salecategorycode=".$salecategorycode;
        $result1 = oci_parse($connection, $query1); 
        $r1 = oci_execute($result1);
        if ($row1 = oci_fetch_array($result1,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $taxrate = $row1['TAXPERCENT']; 
            $taxcode = $row1['TAXCODE'];
            if ($goodspurchaser1->tdsapplicable == 1)
            $tcsrate=0;
            else
            $tcsrate=$row1['TCS'];
        }
        else
        {
            $taxrate=0;
            $taxcode = 0;
            $tcsrate=0;
        }
        if ($taxcode==1 and $taxrate>0 and $statecode==27)
        {
            $cgstrate =$taxrate/2; 
            $sgstrate =$taxrate/2;
            $igstrate =0; 
            $ugstrate =0;  
            $vatrate=0;
        }
        else if ( in_array($statecode, array(4,7,25,26,31,34,35)) and $taxcode==1 and $taxrate>0)
       {
           $cgstrate =0; 
           $sgstrate =0;
           $igstrate =0; 
           $ugstrate =$taxrate;  
           $vatrate=0;
       }
       elseif ($taxcode==1 and $taxrate>0 and $statecode!=27)
        {
            $cgstrate =0; 
            $sgstrate =0;
            $igstrate =$taxrate; 
            $ugstrate =0; 
            $vatrate=0; 
        }
       else if($taxcode==2 and $taxrate>0)
       {
           $cgstrate =0; 
           $sgstrate =0;
           $igstrate =0; 
           $ugstrate =0; 
           $vatrate=$taxrate; 
       }
       else
       {
           $cgstrate =0; 
           $sgstrate =0;
           $igstrate =0; 
           $ugstrate =0; 
           $vatrate=0;
       }
       // tax rate end
       if($tendercategorycode==1)
       {
         if ($_SESSION['lng'] == "English")
            {
                $name = $row['FINISHEDGOODSNAMEENG'].' R'.$orderrate.' Q'.$balancequantity.' '.$tendernumberpresuf;
            }
            else
            {
                $name = $row['FINISHEDGOODSNAMEUNI'].' R'.$orderrate.' Q'.$balancequantity.' '.$tendernumberpresuf;
            }  
       }
       elseif ($tendercategorycode==2) 
       {
            if ($_SESSION['lng'] == "English")
            {
                $name = $row['FINISHEDGOODSNAMEENG'].' R'.$orderrate;
            }
            else
            {
                $name = $row['FINISHEDGOODSNAMEUNI'].' R'.$orderrate;
            }
       }
       
       $data[] = array( 
           'id' => $id
           ,'label' => $name
           ,'value' => $name
           ,'orderrate' => $orderrate
           ,'balancequantity' => $balancequantity
           ,'tendernumberpresuf' => $tendernumberpresuf
           ,'tendertransactionnumber' => $tendertransactionnumber
           ,'ordertransactionnumber' => $ordertransactionnumber
           ,'productionyearcode' => $productionyearcode
           ,'balancequantity'=> $balancequantity
           ,'cgstrate'=> $cgstrate 
           ,'sgstrate'=> $sgstrate 
           ,'igstrate'=> $igstrate 
           ,'ugstrate'=> $ugstrate 
           ,'vatrate'=> $vatrate
           ,'tcsrate'=>$tcsrate
           );
   }
   //return json data
   echo json_encode($data);
   
?>