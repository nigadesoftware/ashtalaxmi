<?php
    //This is generated by Swapp Software Application on 01/03/2019 08:16:54 PM for PHP
    require("../info/phpsqlajax_dbinfo.php");
    require("../info/phpgetloginview.php");
    require("../info/routine.php");
    require_once("../ip_model/saleinvoiceheader_db_oracle.php");
    require_once("../ip_model/goodspurchaser_db_oracle.php");
    $connection =swapp_connection();
    $searchTerm = $_GET['term'];
    $transactionnumber = $_GET['transactionnumber'];
    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    elseif (strlen($searchTerm)<3 and $searchTerm != '**')
    {
        exit;
    }
    $saleinvoiceheader1=new saleinvoiceheader($connection);
    $saleinvoiceheader1->transactionnumber=$transactionnumber;
    $saleinvoiceheader1->fetch();
    $invoicedate= $saleinvoiceheader1->invoicedate;
    $purchasercode=$saleinvoiceheader1->purchasercode;
    $goodscategorycode=$saleinvoiceheader1->goodscategorycode;
    $salecategorycode=$saleinvoiceheader1->salecategorycode;
    $goodspurchaser1=new goodspurchaser($connection);
    $goodspurchaser1->purchasercode=$purchasercode;
    $goodspurchaser1->fetch();
    $statecode=$goodspurchaser1->statecode;
    
   if ($searchTerm == '**')
   {
       $query = "select b.finishedgoodscode
        ,b.finishedgoodsnameeng
        ,b.finishedgoodsnameuni
        ,t.orderrate
        ,t.productionyearcode
        ,t.balancequantity
     from purchaserwiseliftedunlifted t,finishedgoods b
     where t.finishedgoodscode=b.finishedgoodscode and t.balancequantity>0";
   }
   else
   {
       $query = "select b.finishedgoodscode
        ,b.finishedgoodsnameeng
        ,b.finishedgoodsnameuni
        ,t.orderrate
        ,t.productionyearcode
        ,t.balancequantity
     from purchaserwiseliftedunlifted t,finishedgoods b
     where t.finishedgoodscode=b.finishedgoodscode and t.balancequantity>0 and (upper(FINISHEDGOODSNAMEENG) like upper('%".$searchTerm."%')
       or FINISHEDGOODSNAMEUNI like '%".$searchTerm."%'
       or to_char(FINISHEDGOODSCODE) like '".$searchTerm."')";
   }
   $invoicedate = DateTime::createFromFormat('d/m/Y',$invoicedate)->format('d-M-Y');
   $result = oci_parse($connection, $query); 
   $r = oci_execute($result);
   while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
   {
       $id = $row['FINISHEDGOODSCODE'];
       $salerate = $row['FINISHEDGOODSNAMEENG'];
       $memonumberpresuf = $row['FINISHEDGOODSNAMEUNI'];
       $salememotransactionnumber = $row['ORDERRATE'];
       $productionyearcode = $row['PRODUCTIONYEARCODE'];
       $balancequantity = $row['BALANCEQUANTITY'];
       // tax rate start

       $query1 = "select t.taxcode,t.taxpercent 
        from goodstaxrate t
        where t.fromdate<='". $invoicedate."'
        and t.todate>='". $invoicedate."' and t.finishedgoodscode=".$row['FINISHEDGOODSCODE']." 
        and t.salecategorycode=".$salecategorycode;
        $result1 = oci_parse($connection, $query1); 
        $r1 = oci_execute($result1);
        if ($row1 = oci_fetch_array($result1,OCI_ASSOC+OCI_RETURN_NULLS))
        {
            $taxrate = $row1['TAXPERCENT']; 
            $taxcode = $row1['TAXCODE'];
        }
        else
        {
            $taxrate=0;
            $taxcode = 0;
        }
        if ($taxcode==1 and $taxrate>0 and $statecode==27)
        {
            $cgstrate =$taxrate/2; 
            $sgstrate =$taxrate/2;
            $igstrate =0; 
            $ugstrate =0;  
            $vatrate=0;
        }
        else if ( in_array($statecode, array(4,7,25,26,31,34,35)) and $taxcode==1 and $taxrate>0)
       {
           $cgstrate =0; 
           $sgstrate =0;
           $igstrate =0; 
           $ugstrate =$taxrate;  
           $vatrate=0;
       }
       elseif ($taxcode==1 and $taxrate>0 and $statecode!=27)
        {
            $cgstrate =0; 
            $sgstrate =0;
            $igstrate =$taxrate; 
            $ugstrate =0; 
            $vatrate=0; 
        }
       else if($taxcode==2 and $taxrate>0)
       {
           $cgstrate =0; 
           $sgstrate =0;
           $igstrate =0; 
           $ugstrate =0; 
           $vatrate=$taxrate; 
       }
       else
       {
           $cgstrate =0; 
           $sgstrate =0;
           $igstrate =0; 
           $ugstrate =0; 
           $vatrate=0;
       }

       // tax rate end
       if ($_SESSION['lng'] == "English")
       {
           $name = $row['FINISHEDGOODSNAMEENG'].' R'.$salerate.' Q'.$balancequantity.' '.$memonumberpresuf;
       }
       else
       {
           $name = $row['FINISHEDGOODSNAMEUNI'].' R'.$salerate.' Q'.$balancequantity.' '.$memonumberpresuf;
       }
       
       $data[] = array( 
           'id' => $id
           ,'label' => $name
           ,'value' => $name
           ,'salerate' => $salerate
           ,'memonumberpresuf' => $memonumberpresuf
           ,'salememotransactionnumber' => $salememotransactionnumber
           ,'productionyearcode' => $productionyearcode
           ,'balancequantity'=> $balancequantity
           ,'cgstrate'=> $cgstrate 
           ,'sgstrate'=> $sgstrate 
           ,'igstrate'=> $igstrate 
           ,'ugstrate'=> $ugstrate 
           ,'vatrate'=> $vatrate
           );
   }
   //return json data
   echo json_encode($data);
   
?>