<?php
    //This is generated by Swapp Software Application on 01/03/2019 08:16:54 PM for PHP
    require("../info/phpsqlajax_dbinfo.php");
    require("../info/phpgetloginview.php");
    require("../info/routine.php");
    require_once("../ip_model/saleinvoiceheader_db_oracle.php");
    require_once("../ip_model/goodspurchaser_db_oracle.php");
    $connection =swapp_connection();
    $searchTerm = $_GET['term'];
    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    elseif (strlen($searchTerm)<3 and $searchTerm != '**')
    {
        exit;
    }
   if ($searchTerm == '**')
   {
       $query = "select t.transactionnumber
       ,t.memonumberpresuf 
       ,h.brokercode
       ,h.purchasercode
       ,h.shippingpartycode
       ,h.vehiclenumber
       ,h.drivername
       ,h.driverlicenseno
       ,h.salecategorycode
       from vw_pendingmemoforinvoice t
       ,salememoheader h
       where t.transactionnumber=h.transactionnumber
       order by t.transactionnumber";
   }
   else
   {
       $query = "select t.transactionnumber
       ,t.memonumberpresuf 
       ,h.brokercode
       ,h.purchasercode
       ,h.shippingpartycode
       ,h.vehiclenumber
       ,h.drivername
       ,h.driverlicenseno
       ,h.salecategorycode
       from vw_pendingmemoforinvoice t
       ,salememoheader h
       where t.transactionnumber=h.transactionnumber
       and t.invoicenumberpresuf like '%".$searchTerm."%'";
   }
   $result = oci_parse($connection, $query); 
   $r = oci_execute($result);
   while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
   {
       $broker1=new goodspurchaser($connection);
       $broker1->purchasercode=$row['BROKERCODE'];
       $broker1->fetch();
       $brokercode = $broker1->purchasercode;
       if ($_SESSION['lng'] == "English")
       {
            $brokername = $broker1->purchasernameeng;
       }
       else
       {
            $brokername = $broker1->purchasernameuni;
       }
       
       $purchasercode1=new goodspurchaser($connection);
       $purchasercode1->purchasercode=$row['PURCHASERCODE'];
       $purchasercode1->fetch();
       $purchasercode = $broker1->purchasercode;
       if ($_SESSION['lng'] == "English")
       {
           $purchasername = $purchasercode1->purchasernameeng;
       }
       else
       {
            $purchasername = $purchasercode1->purchasernameuni;
       }
       
       $shiftto1=new goodspurchaser($connection);
       $shiftto1->purchasercode=$row['SHIPPINGPARTYCODE'];
       $shiftto1->fetch();
       $shippingpartycode = $shiftto1->purchasercode;
       if ($_SESSION['lng'] == "English")
       {
           $shifttoname = $shiftto1->purchasernameeng;
       }
       else
       {
            $shifttoname = $shiftto1->purchasernameuni;
       }
       $id = $row['TRANSACTIONNUMBER'];
       $name = $row['MEMONUMBERPRESUF'];
       $vehiclenumber = $row['VEHICLENUMBER'];
       $drivername = $row['DRIVERNAME'];
       $driverlicenseno = $row['DRIVERLICENSENO'];
       $salecategorycode = $row['SALECATEGORYCODE'];
       $data[] = array( 
           'id' => $id
           ,'label' => $name
           ,'brokercode' => $brokercode
           ,'brokername' => $brokername
           ,'purchasercode' => $purchasercode
           ,'purchasername' => $purchasername
           ,'shippingpartycode' => $shippingpartycode
           ,'shifttoname' => $shifttoname
           ,'vehiclenumber' => $vehiclenumber
           ,'drivername' => $drivername
           ,'driverlicenseno' => $driverlicenseno
           ,'salecategorycode' => $salecategorycode
           );
   }
   //return json data
   echo json_encode($data);
?>