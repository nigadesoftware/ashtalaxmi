<?php
    //This is generated by Swapp Software Application on 28/05/2019 07:19:54 PM for PHP
    require_once("../info/phpsqlajax_dbinfo.php");
    require_once("../info/phpgetloginview.php");
    require_once("../info/routine.php");
    $connection = swapp_connection();
    $searchTerm = $_GET['term'];
    $farmercode = $_GET['farmercode'];
    $seasoncode = $_GET['yearperiodcode'];
    if (preg_match('/^[0-9]*$/', $searchTerm))
    {
    }
    elseif ((strlen($searchTerm)<3) and $searchTerm != '**')
    {
        exit;
    }
    if ($farmercode=='')
    {
        $cond=' and to_char(plotnumber) = '.$searchTerm;
    }
    else
    {
        if ($searchTerm=='**')
        {
            $cond=' and h.farmercode='.$farmercode;
        }
        else
        {
            $cond=' and to_char(plotnumber) = '.$searchTerm;
        }
    }
    $query = "select plotnumber
    ,f.farmercode
    ,farmernameeng
    ,farmernameuni
    ,f.farmercategorycode
    ,c.farmercategorynameeng
    ,c.farmercategorynameuni
    ,v.villagecode
    ,villagenameeng
    ,villagenameuni
    ,h.area
    ,h.gutnumber
    from nst_nasaka_agriculture.plantationheader h
    ,nst_nasaka_agriculture.farmer f
    ,nst_nasaka_agriculture.village v
    ,nst_nasaka_agriculture.subvillage s
    ,nst_nasaka_agriculture.farmercategory c
    where h.farmercode=f.farmercode 
    and f.farmercategorycode=c.farmercategorycode  
    and h.villagecode=v.villagecode
    and h.villagecode=s.villagecode(+)
    and h.subvillagecode=s.subvillagecode(+)
    and seasoncode=".$seasoncode.$cond." 
     order by plotnumber";
   $result = oci_parse($connection, $query); 
   $r = oci_execute($result);
   while ($row = oci_fetch_array($result,OCI_ASSOC+OCI_RETURN_NULLS))
   {
       $id = $row['PLOTNUMBER'];
       $farmercode= $row['FARMERCODE'];
       $farmercategorycode= $row['FARMERCATEGORYCODE'];
       $villagecode= $row['VILLAGECODE'];
       $area=$row['AREA'];
       $gutnumber=$row['GUTNUMBER'];
       if ($_SESSION['lng'] == "English")
       {
           $name = $row['FARMERNAMEENG'];
           $farmercategory = $row['FARMERCATEGORYNAMEENG'];
           $village= $row['VILLAGENAMEENG'];
       }
       else
       {
           $name = $row['FARMERNAMEUNI'];
           $farmercategory = $row['FARMERCATEGORYNAMEUNI'];
           $village= $row['VILLAGENAMEUNI'];
       }
       $data[] = array( 
           'id' => $id
           ,'label' => $id.' - '.$village.' - '.$gutnumber.' - '.$area
           ,'value' => $name
           );
   }
   //return json data
   echo json_encode($data);
?>